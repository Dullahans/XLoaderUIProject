<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>电子负载上位机</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css">
  <script src="https://unpkg.com/vue@2.7.14/dist/vue.min.js"></script>
  <script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #3b82f6;
      --primary-bg: rgba(37, 99, 235, 0.08);
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #6366f1;
      --running-color: #8b5cf6;
      --bg-page: #f8fafc;
      --bg-white: #ffffff;
      --bg-gray: #f1f5f9;
      --bg-hover: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --font-sans: 'Noto Sans SC', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      /* 左侧边栏宽度：扩大到原来的 1.5 倍（260px -> 390px） */
      --sidebar-width: 350px;
      --toolbar-height: 52px;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      font-family: var(--font-sans);
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-page);
    }

    #app {
      height: 100%;
    }

    .app-layout {
      display: flex;
      height: 100%;
    }

    /* 左侧设备边栏 */
    .device-sidebar {
      width: var(--sidebar-width);
      background: var(--bg-white);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      height: var(--toolbar-height);
      /* 使用统一的高度变量 */
      padding: 0 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      box-sizing: border-box;
      /* 显式设置确保对齐 */
    }

    .sidebar-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      user-select: none;
    }

    .ws-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      margin-left: auto;
      transition: all 0.3s;
    }

    .ws-indicator.connected {
      background: var(--success-color);
      box-shadow: 0 0 6px var(--success-color);
    }

    .sidebar-section {
      padding: 12px 12px 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-section .section-title {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .sidebar-scroll {
      flex: 1;
      overflow: auto;
      padding: 12px;
    }

    .empty-hint {
      padding: 14px 12px;
      border: 1px dashed var(--border-color);
      border-radius: 10px;
      background: var(--bg-gray);
      color: var(--text-secondary);
      text-align: center;
      font-size: 12px;
    }

    .empty-hint .muted {
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 11px;
    }

    .lab-block {
      margin-bottom: 14px;
    }

    .lab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .lab-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .lab-count {
      font-size: 11px;
      color: var(--text-muted);
    }

    .cabinet-card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-white);
      overflow: hidden;
      margin-bottom: 0;
      box-shadow: var(--shadow-sm);
    }

    .cabinet-img {
      position: relative;
      background: var(--bg-gray);
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .cabinet-img img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 10px;
      display: block;
    }

    .cabinet-ip {
      position: absolute;
      top: 14px;
      left: 14px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border-color);
      padding: 2px 6px;
      border-radius: 6px;
    }

    .cabinet-block {
      margin-bottom: 12px;
    }

    /* 设备单体：每个机箱下方独立一行（6列） */
    .cabinet-stack {
      position: relative;
      height: 190px;
      /* 整体长度变大 */
      margin-top: 8px;
    }

    /* 机箱：表格框（LOGO行 / IP行 / 内容区） */
    .cabinet-frame {
      position: absolute;
      inset: 0;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      background: var(--bg-gray);
      box-shadow: var(--shadow-sm);
      display: grid;
      grid-template-rows: 44px 34px 1fr;
    }

    .cabinet-frame-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
    }

    .cabinet-frame-bg img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .cabinet-row {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      gap: 8px;
    }

    .cabinet-row.logo {
      /* background: rgba(15, 23, 42, 0.86); */
      background-color: #e2e8f0;
      /* border-bottom: 1px solid rgba(31, 41, 55, 0.7); */
      border-bottom: 1px solid rgba(31, 41, 55, 0.2);
    }

    .cabinet-row.ip {
      background: rgba(241, 245, 249, 0.95);
    }

    .cabinet-logo {
      height: 22px;
      width: auto;
      display: block;
    }

    .cabinet-ip-text {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-primary);
    }

    .cabinet-body {
      position: relative;
      z-index: 1;
      padding: 8px 10px 10px;
    }

    /* 单体：塞在内容区，6个正好填满，间隔更紧凑 */
    .cabinet-device-grid {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 2px;
      align-items: end;
    }

    .device-item {
      text-align: center;
      cursor: pointer;
    }

    .device-pic {
      position: relative;
      /* width: 58px; */
      /* 单体图片增大 */
      height: 78px;
      margin: 0 auto;
    }

    .device-item.selected .device-pic {
      border-radius: 10px;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.55), 0 8px 18px rgba(37, 99, 235, 0.18);
      background: rgba(37, 99, 235, 0.06);
    }

    .device-item.selected .device-model {
      color: var(--primary-color);
      font-weight: 600;
    }

    .device-pic img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .rgb-dot {
      position: absolute;
      bottom: 6px;
      /* 右下角 */
      right: 6px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #94a3b8;
      /* default 灰 */
      box-shadow: none;
      border: 2px solid rgba(255, 255, 255, 0.95);
      /* 边缘线 */
      outline: 1px solid rgba(0, 0, 0, 0.18);
    }

    .rgb-dot.connected {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.55);
    }

    .rgb-dot.running {
      background: #3b82f6;
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.55);
    }

    .rgb-dot.alarm {
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.55);
    }

    .rgb-dot.upgrading {
      animation: ota-blink 500ms infinite;
    }

    @keyframes ota-blink {

      0%,
      50% {
        background: #3b82f6;
        box-shadow: 0 0 8px rgba(59, 130, 246, 0.55);
      }

      25%,
      75% {
        background: #ef4444;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.55);
      }
    }

    .device-index {
      position: absolute;
      bottom: 4px;
      left: 4px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: #fff;
      background: rgba(15, 23, 42, 0.75);
      padding: 1px 5px;
      border-radius: 6px;
    }

    .device-model {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-secondary);
      white-space: normal;
      /* 多排 */
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      /* 最多两行 */
      -webkit-box-orient: vertical;
      line-height: 1.2;
      min-height: calc(1.2em * 2);
    }

    .device-card {
      margin: 12px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
    }

    .device-visual {
      height: 140px;
      background: linear-gradient(180deg, #dbeafe 0%, #bfdbfe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .device-image {
      width: 120px;
      height: 90px;
      background: linear-gradient(145deg, #374151 0%, #1f2937 100%);
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .device-screen {
      width: 80px;
      height: 36px;
      background: #000;
      border-radius: 3px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 14px;
      color: #00ff88;
      text-shadow: 0 0 8px #00ff88;
    }

    .device-leds {
      display: flex;
      gap: 6px;
    }

    .led {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #333;
    }

    .led.power {
      background: var(--success-color);
      box-shadow: 0 0 6px var(--success-color);
    }

    .led.run {
      background: var(--primary-light);
      box-shadow: 0 0 6px var(--primary-light);
      animation: blink 1s infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    .device-info {
      padding: 12px;
    }

    .device-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .device-sn {
      font-size: 11px;
      color: var(--primary-color);
      font-family: var(--font-mono);
      background: var(--primary-bg);
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 8px;
    }

    .device-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }

    .meta-value {
      font-family: var(--font-mono);
      color: var(--text-secondary);
    }

    .connection-status {
      margin: 0 12px 12px;
      padding: 10px 12px;
      background: var(--bg-gray);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-indicator.connected {
      background: var(--success-color);
      box-shadow: 0 0 6px var(--success-color);
    }

    .status-text {
      flex: 1;
    }

    .status-title {
      font-size: 12px;
      font-weight: 500;
    }

    .status-desc {
      font-size: 10px;
      color: var(--text-muted);
    }

    .connect-btn {
      margin: 0 12px 12px;
    }

    .connect-btn .el-button {
      width: 100%;
    }

    .running-model {
      margin: 0 12px 12px;
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
    }

    .running-model-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .running-model-header i {
      color: var(--running-color);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .running-model-title {
      font-size: 11px;
      font-weight: 500;
      color: var(--running-color);
    }

    .running-model-info {
      font-size: 12px;
    }

    .running-file {
      font-family: var(--font-mono);
      color: var(--text-primary);
      font-weight: 500;
    }

    .running-module {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .run-status {
      margin: 0 12px 12px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }

    .run-status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .run-badge {
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 500;
    }

    .run-badge.running {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
    }

    .run-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }

    .stat-box {
      background: var(--bg-gray);
      padding: 6px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    .stat-label {
      font-size: 9px;
      color: var(--text-muted);
    }

    /* 右侧主区域 */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .toolbar-title {
      font-size: 16px;
      font-weight: 600;
      margin-right: 20px;
    }

    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 20px;
      overflow: hidden;
    }

    /* 设备升级面板 */
    .upgrade-panel {
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      padding: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .upgrade-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .upgrade-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upgrade-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .upgrade-list {
      flex: 1;
      overflow: auto;
      border-top: 1px solid var(--border-light);
      padding-top: 10px;
    }

    .ota-ip-block {
      margin-bottom: 14px;
    }

    .ota-ip-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .ota-ip {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-primary);
      font-weight: 700;
    }

    .ota-device-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .ota-device-card {
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: #fff;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ota-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .ota-name {
      font-weight: 700;
      font-size: 12px;
      color: var(--text-primary);
    }

    .ota-meta {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }

    .ota-status {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* 顶部页签切换 */
    .page-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      background: var(--bg-white);
      padding: 3px;
      border-radius: 8px;
      width: fit-content;
      box-shadow: var(--shadow-sm);
    }

    .page-tab {
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .page-tab:hover {
      color: var(--text-primary);
      background: var(--bg-gray);
    }

    .page-tab.active {
      color: var(--primary-color);
      background: var(--primary-bg);
    }

    .page-content {
      flex: 1;
      background: var(--bg-white);
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      display: none;
    }

    .page-content.active {
      display: flex;
      flex-direction: column;
    }

    .page-header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 15px;
      font-weight: 600;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-divider {
      width: 1px;
      height: 20px;
      background: var(--border-color);
      margin: 0 4px;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-white);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
      background: var(--primary-bg);
    }

    .action-btn.primary {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    .action-btn.primary:hover {
      background: var(--primary-dark);
    }

    .action-btn.success {
      background: var(--success-color);
      border-color: var(--success-color);
      color: white;
    }

    .action-btn.success:hover {
      background: #059669;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .action-btn i {
      font-size: 14px;
    }

    .page-body {
      flex: 1;
      padding: 16px 20px;
      overflow-y: auto;
    }

    /* 参数编辑页面 */
    .model-layout {
      display: flex;
      gap: 16px;
      height: 100%;
    }

    .model-list {
      width: 220px;
      flex-shrink: 0;
      border-right: 1px solid var(--border-color);
      padding-right: 16px;
      display: flex;
      flex-direction: column;
    }

    .model-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .sn-badge {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--primary-color);
      background: var(--primary-bg);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .model-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
      border: 1px solid transparent;
      position: relative;
    }

    .model-item:hover {
      background: var(--bg-gray);
    }

    .model-item.active {
      background: var(--primary-bg);
      border-color: var(--primary-color);
    }

    .model-item.has-error {
      border-color: var(--error-color);
      background: rgba(239, 68, 68, 0.05);
    }

    .model-item.is-running {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.08) 100%);
      border-color: var(--running-color);
    }

    .model-item.is-running .model-item-name {
      color: var(--running-color);
      font-weight: 600;
    }

    .model-item.is-running::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--running-color);
      border-radius: 3px 0 0 3px;
    }

    .model-item.drag-over {
      border: 2px dashed var(--primary-color);
      background: var(--primary-bg);
    }

    .model-item i {
      color: var(--text-muted);
      font-size: 16px;
    }

    .model-item.active i {
      color: var(--primary-color);
    }

    .model-item.is-running i {
      color: var(--running-color);
    }

    .model-item-info {
      flex: 1;
      min-width: 0;
    }

    .model-item-name {
      font-size: 12px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .model-item-size {
      font-size: 10px;
      color: var(--text-muted);
    }

    .model-item-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .model-item-badge.running {
      color: var(--running-color);
      background: rgba(139, 92, 246, 0.08);
      border: 1px solid rgba(139, 92, 246, 0.15);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 3px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .model-item-badge.running i {
      font-size: 12px;
      animation: blink 1.5s infinite;
    }

    .model-item-btns,
    .module-btns {
      display: none;
      margin-left: 4px;
    }

    .model-item:hover .model-item-btns,
    .module-header:hover .module-btns {
      display: block;
    }

    .delete-btn {
      color: var(--error-color) !important;
      padding: 0 !important;
    }

    .delete-btn:hover {
      color: #fecaca !important;
    }

    .model-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .editor-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .editor-filename {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
    }

    .editor-filename i {
      color: var(--primary-color);
    }

    .modified-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--warning-color);
    }

    /* 模块折叠区 */
    .module-section {
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .module-section.is-running {
      border-color: var(--running-color);
      box-shadow: 0 0 0 1px rgba(139, 92, 246, 0.2);
    }

    .module-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--bg-gray);
      cursor: pointer;
      transition: background 0.2s;
    }

    .module-section.is-running .module-header {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.08) 100%);
    }

    .module-header:hover {
      background: var(--bg-hover);
    }

    .module-toggle {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .module-toggle.expanded {
      transform: rotate(90deg);
    }

    .module-info {
      flex: 1;
    }

    .module-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .module-name {
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--primary-color);
    }

    .module-section.is-running .module-name {
      color: var(--running-color);
    }

    .module-name-cn {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: normal;
    }

    .module-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .module-count {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-white);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .running-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: #fff;
      background: var(--running-color);
      padding: 2px 10px;
      border-radius: 12px;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
    }

    .running-indicator i {
      animation: blink 1s infinite;
    }

    .module-body {
      display: none;
      padding: 16px 20px;
    }

    .module-body.expanded {
      display: block;
    }

    /* 参数行 - 增强版 */
    .param-row {
      display: grid;
      grid-template-columns: 280px 1fr auto;
      gap: 24px;
      align-items: start;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid transparent;
      background: var(--bg-white);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      transition: all 0.2s;
    }

    .param-row:hover {
      background: #fcfaff;
      border-color: var(--primary-light);
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.08);
    }

    .param-label-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-top: 4px;
    }

    .param-name-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .param-key {
      font-size: 13px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-weight: 600;
      word-break: break-all;
    }

    .param-name-cn {
      font-size: 11px;
      color: var(--primary-color);
      background: rgba(139, 92, 246, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .param-desc {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
      margin-top: 2px;
    }

    .param-range {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: var(--font-mono);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      background: #f0fdf4;
      padding: 2px 8px;
      border-radius: 4px;
      width: fit-content;
    }

    .param-range i {
      font-size: 12px;
      color: var(--success-color);
    }

    .param-input-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    .param-actions {
      display: flex;
      align-items: center;
      padding-top: 4px;
      justify-content: center;
    }

    .param-actions .delete-btn {
      color: #909399;
      padding: 5px;
      transition: all 0.2s;
    }

    .param-actions .delete-btn:hover {
      color: var(--error-color);
      background: rgba(239, 68, 68, 0.05);
      border-radius: 4px;
    }

    .param-input-row {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .param-input-row .el-input-number,
    .param-input-row .el-input {
      flex: 1;
      max-width: 320px;
      /* 限制一个合理的最大宽度，避免过长 */
      min-width: 150px;
      /* 保证最小可辨识宽度 */
    }

    .param-unit {
      font-size: 12px;
      color: var(--text-secondary);
      font-family: var(--font-mono);
      min-width: 45px;
    }

    .param-type-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--bg-gray);
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* 参数值超出范围警告 */
    .param-row.out-of-range {
      border-color: var(--warning-color);
      background: rgba(245, 158, 11, 0.05);
    }

    .range-warning {
      font-size: 10px;
      color: var(--warning-color);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* 数组显示 */
    .array-display {
      background: var(--bg-gray);
      border-radius: 6px;
      padding: 10px;
      width: 100%;
    }

    .array-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color);
    }

    .array-label {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .array-items {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .array-item {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--bg-white);
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .array-index {
      font-size: 10px;
      color: var(--text-muted);
      font-family: var(--font-mono);
      min-width: 24px;
    }

    .array-item .el-input-number {
      width: 120px;
    }

    .array-item .el-input {
      width: 110px;
    }

    .array-item .el-button {
      padding: 2px;
      color: var(--text-muted);
    }

    .array-item .el-button:hover {
      color: var(--error-color);
    }

    /* 矩阵显示 */
    .matrix-display {
      background: var(--bg-gray);
      border-radius: 6px;
      padding: 10px;
      width: 100%;
    }

    .matrix-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color);
    }

    .matrix-size {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .matrix-table {
      overflow-x: auto;
    }

    .matrix-header {
      display: flex;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 6px;
    }

    .matrix-header-cell {
      width: 80px;
      text-align: center;
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 500;
      flex-shrink: 0;
    }

    .matrix-row {
      display: flex;
      gap: 8px;
      padding: 4px 0;
      align-items: center;
    }

    .matrix-row:hover {
      background: var(--bg-hover);
      margin: 0 -6px;
      padding: 4px 6px;
      border-radius: 4px;
    }

    .matrix-row-index {
      width: 24px;
      font-size: 10px;
      color: var(--text-muted);
      font-family: var(--font-mono);
      text-align: center;
      flex-shrink: 0;
    }

    .matrix-cell-input {
      width: 100px !important;
      flex-shrink: 0;
    }

    .matrix-action-cell {
      width: 24px;
      flex-shrink: 0;
    }

    .matrix-delete-btn {
      padding: 2px;
      color: var(--text-muted);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .matrix-row:hover .matrix-delete-btn {
      opacity: 1;
    }

    .matrix-delete-btn:hover {
      color: var(--error-color);
    }

    /* 数据目录提示 */
    .data-path {
      font-size: 11px;
      color: var(--text-muted);
      padding: 8px 12px;
      background: var(--bg-gray);
      border-radius: 6px;
      margin-bottom: 12px;
      font-family: var(--font-mono);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .data-path i {
      color: var(--primary-color);
    }

    /* 空状态 */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* 未知参数标记 */
    .param-unknown {
      font-size: 10px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* ============================================
       设备信息页样式
    ============================================ */

    .device-overview-card {
      display: flex;
      gap: 24px;
      padding: 20px;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .device-photo {
      width: 280px;
      height: 200px;
      flex-shrink: 0;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: var(--bg-gray);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .device-photo img {
      width: 100%;
      /* height: 100%; */
      object-fit: cover;
    }

    .device-photo-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      gap: 8px;
    }

    .device-photo-overlay i {
      font-size: 32px;
      color: var(--warning-color);
    }

    .device-overview-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .device-overview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .device-model-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .device-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .info-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .info-value {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .info-value.sn {
      font-family: var(--font-mono);
      color: var(--primary-color);
      background: var(--primary-bg);
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-block;
    }

    .info-value.mono {
      font-family: var(--font-mono);
    }

    .info-value.highlight {
      color: var(--success-color);
    }

    .running-model-info {
      margin-top: auto;
      padding: 12px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 8px;
    }

    .running-model-info.stopped {
      background: var(--bg-gray);
      border-color: var(--border-color);
    }

    .running-model-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--running-color);
      color: white;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .running-model-badge i {
      animation: pulse 2s infinite;
    }

    .running-model-badge.stopped {
      background: var(--text-muted);
    }

    .running-model-badge.stopped i {
      animation: none;
    }

    .running-model-detail {
      display: flex;
      gap: 8px;
      font-size: 12px;
    }

    .running-label {
      color: var(--text-muted);
    }

    .running-value {
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-weight: 500;
    }

    /* 规格区域 */
    .spec-section,
    .realtime-section {
      margin-bottom: 20px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .section-title i {
      color: var(--primary-color);
    }

    .spec-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .spec-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      border-radius: 10px;
    }

    .spec-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .spec-content {
      display: flex;
      flex-direction: column;
    }

    .spec-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: var(--font-mono);
    }

    .spec-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* 实时数据 */
    .realtime-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .realtime-card {
      padding: 16px;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      position: relative;
    }

    .realtime-value {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: var(--font-mono);
    }

    .realtime-unit {
      font-size: 14px;
      color: var(--text-muted);
      margin-left: 4px;
    }

    .realtime-label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .realtime-bar {
      height: 4px;
      background: var(--bg-gray);
      border-radius: 2px;
      margin-top: 12px;
      overflow: hidden;
    }

    .realtime-bar-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    /* ============================================
       寄存器管理页样式
    ============================================ */

    .register-page {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .register-filters {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .register-table-container {
      flex: 1;
      overflow: auto;
      margin-top: 12px;
    }

    .register-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .register-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .register-table th {
      background: var(--bg-gray);
      color: var(--text-secondary);
      font-weight: 500;
      text-align: left;
      padding: 8px 10px;
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    .register-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    .register-table tr:hover {
      background: var(--primary-bg);
    }

    .register-table tr.reg-modified {
      background: rgba(245, 158, 11, 0.08);
    }

    .register-table tr.reg-read-error {
      background: rgba(239, 68, 68, 0.06);
    }

    .reg-value.error {
      color: var(--error-color);
      font-weight: 600;
    }

    .reg-range {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .reg-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .reg-desc {
      font-size: 12px;
      color: var(--text-muted);
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .reg-value-cell {
      min-width: 180px;
    }

    .reg-value {
      font-family: var(--font-mono);
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }

    .reg-value.readonly {
      background: var(--bg-gray);
      color: var(--text-primary);
    }

    .reg-input-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .reg-current-value {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .reg-input {
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 13px;
      width: 100%;
      min-width: 120px;
      /* 确保在小屏幕上也有足够的点击区域 */
      max-width: 400px;
      /* 进一步增加最大宽度，确保长字符串也能显示完整 */
      transition: all 0.2s;
    }

    .reg-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-bg);
    }

    .reg-input::placeholder {
      font-family: var(--font-sans);
      font-size: 12px;
      color: var(--text-muted);
    }

    .reg-actions {
      white-space: nowrap;
    }

    .reg-actions .el-button {
      padding: 5px 10px;
      font-size: 12px;
    }

    .register-stats {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
      font-size: 12px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    /* 滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-gray);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    /* 非模态抽屉样式，确保不遮挡点击 */
    .non-modal-drawer.el-drawer__wrapper {
      pointer-events: none;
      z-index: 2000;
    }

    .non-modal-drawer .el-drawer {
      pointer-events: auto;
      box-shadow: -2px 0 12px rgba(0, 0, 0, 0.1);
    }

    /* 确保设备选择区域可以正常点击 */
    .cabinet-device-grid {
      position: relative;
      z-index: 1;
    }

    /* 寄存器 Sheet 拖拽样式 */
    .register-table tr[draggable="true"] {
      cursor: grab;
    }

    .register-table tr[draggable="true"]:active {
      cursor: grabbing;
    }

    .register-table tr.drag-over-row {
      border-top: 2px solid var(--primary-color);
    }

    /* 页签增强样式 */
    .tab-label-zone {
      display: inline-block;
      height: 100%;
      padding: 0 10px;
      margin: 0 -15px;
      /* 负边距抵消父级内边距，扩大捕获范围 */
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .tab-label-zone.drag-over-tab {
      background-color: rgba(var(--primary-rgb), 0.1);
      box-shadow: inset 0 -2px 0 var(--primary-color);
    }

    .root-tab-label {
      color: var(--primary-color);
      font-weight: 800 !important;
    }

    .root-tab-label i {
      margin-right: 4px;
    }

    .el-tabs__item.is-active .root-tab-label {
      background: #eff6ff;
      border-radius: 4px 4px 0 0;
    }

    /* 右键菜单样式 */
    .context-menu {
      position: fixed;
      z-index: 3000;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 5px 0;
      min-width: 120px;
    }

    .context-menu-item {
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .context-menu-item:hover {
      background-color: var(--bg-gray);
      color: var(--primary-color);
    }

    .context-menu-item.danger:hover {
      background-color: #fef2f2;
      color: var(--danger-color);
    }

    .context-menu-divider {
      height: 1px;
      background-color: var(--border-color);
      margin: 4px 0;
    }

    .context-submenu {
      position: absolute;
      left: 100%;
      top: 0;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 5px 0;
      display: none;
      min-width: 120px;
    }

    .context-menu-item:hover>.context-submenu {
      display: block;
    }

    /* 侧边悬浮面板样式 - 极致紧凑且支持缩放 */
    .floating-panel {
      position: fixed;
      right: 8px;
      /* 稍微离开边缘，以显示右侧圆角 */
      top: 50%;
      transform: translateY(-50%);
      z-index: 2000;
      background: var(--bg-white);
      border: none;
      border-radius: 30px;
      /* 大圆角形成胶囊/半圆形状 */
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      padding: 6px 3px;
      /* 适当增加上下内边距 */
      gap: 4px;
      /* 适当增加图标间距 */
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none;
      width: 28px;
      /* 适当放大缩小状态的宽度 */
    }

    .floating-panel:hover {
      width: 44px;
      /* 鼠标挪上去后放大到现在这个大小 */
      padding: 10px 6px;
      gap: 4px;
      /* 悬停时也保持较小的间距 */
      box-shadow: -4px 0 20px rgba(139, 92, 246, 0.15);
    }

    .floating-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      width: 22px;
      /* 初始尺寸适当放大 */
      height: 22px;
      border-radius: 4px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-secondary);
    }

    .floating-panel:hover .floating-item {
      width: 32px;
      /* 悬停时恢复尺寸 */
      height: 32px;
      border-radius: 8px;
    }

    .floating-item:hover {
      background: var(--primary-bg);
      color: var(--primary-color);
    }

    .floating-item i {
      font-size: 16px;
      /* 初始图标适当放大 */
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .floating-panel:hover .floating-item i {
      font-size: 20px;
      /* 悬停时图标放大 */
    }

    .floating-item:hover i {
      transform: scale(1.2);
    }

    .floating-item span {
      position: absolute;
      right: 100%;
      margin-right: 15px;
      background: rgba(45, 45, 45, 0.9);
      color: white;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .floating-item:hover span {
      opacity: 1;
      transform: translateX(0);
      /* 向左弹出文本 */
    }

    /* 气泡小箭头 */
    .floating-item span::after {
      content: '';
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      border: 6px solid transparent;
      border-left-color: rgba(45, 45, 45, 0.9);
    }

    .drag-handle {
      height: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      color: var(--text-muted);
      opacity: 0;
      transition: all 0.3s ease;
      background: transparent;
    }

    .floating-panel:hover .drag-handle {
      height: 24px;
      /* 缩小手柄高度 */
      opacity: 1;
      margin-top: 2px;
      /* 缩小间距 */
    }

    .drag-handle i {
      font-size: 16px;
    }

    /* 全局消息提示样式调整：位于顶部工具栏下方，水平居中 */
    .el-message {
      min-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      border: none !important;
    }

    .el-message--success {
      background-color: #f0fdf4 !important;
    }

    .el-message--error {
      background-color: #fef2f2 !important;
    }

    .el-message--warning {
      background-color: #fffbeb !important;
    }

    .el-message--info {
      background-color: #f0f9ff !important;
    }

    /* 顶部工具栏适配模型控制功能 */
    .toolbar {
      height: var(--toolbar-height);
      /* 使用统一的高度变量 */
      background: var(--bg-white);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 20px;
      box-sizing: border-box;
      /* 显式设置确保对齐 */
    }

    .toolbar .bar-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toolbar .bar-divider {
      width: 1px;
      height: 24px;
      background: var(--border-color);
    }

    .toolbar .bar-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="app-layout">
      <!-- 左侧设备边栏 -->
      <aside class="device-sidebar">
        <div class="sidebar-header">
          <span class="sidebar-title">
            <img class="cabinet-logo" src="img/logo.png" alt="logo" />
          </span>
          <el-tooltip :content="wsConnected ? 'WebSocket已连接' : 'WebSocket未连接'" placement="right">
            <span class="ws-indicator" :class="{ connected: wsConnected }"></span>
          </el-tooltip>
        </div>

        <!-- 实验室选择（query_location_info） -->
        <div class="sidebar-section">
          <div class="section-title">
            <span>实验室</span>
            <el-tag v-if="!isLocationRegistered" size="mini" type="danger" effect="plain"
              style="font-weight: normal; transform: scale(0.85);">未注册</el-tag>
          </div>
          <div style="display: flex; gap: 6px;">
            <el-select v-model="selectedLocation" size="mini" placeholder="请选择实验室" style="flex: 1;"
              @change="onLocationChanged">
              <el-option v-if="selectedLocation === '未设置' && !isLocationRegistered" key="未设置" label="未设置（请选择实验室）"
                value="未设置" disabled></el-option>
              <el-option v-for="loc in locationList" :key="loc" :label="loc" :value="loc"></el-option>
            </el-select>
            <el-button size="mini" type="primary" icon="el-icon-check" circle @click="handleSaveLocation"
              title="保存实验室位置"></el-button>
          </div>
        </div>

        <!-- lab / 机箱 / 设备列表（get_connect_status 推送） -->
        <div class="sidebar-scroll">
          <div v-if="!hasConnectStatus" class="empty-hint">
            <i class="el-icon-info"></i>
            <div>暂无状态数据</div>
            <div class="muted">等待 get_connect_status 推送…</div>
          </div>

          <div v-for="lab in labView" :key="lab.labKey" class="lab-block">
            <div class="lab-header">
              <span class="lab-name">{{ lab.labKey }}</span>
              <span class="lab-count">{{ lab.cabinets.length }} 机箱</span>
            </div>

            <div v-for="cab in lab.cabinets" :key="cab.ip" class="cabinet-block">
              <!-- 机箱框（下层） + 单体（上层） -->
              <div class="cabinet-stack">
                <div class="cabinet-frame">
                  <!-- <div class="cabinet-frame-bg">
                    <img src="img/cabinet.png" />
                  </div> -->
                  <!-- <div class="cabinet-row logo">
                    <img class="cabinet-logo" src="img/logo.png" alt="logo" />
        </div> -->
                  <div class="cabinet-row ip">
                    <span class="cabinet-ip-text">IP: {{ cab.ip }}</span>
                  </div>
                  <div class="cabinet-body">
                    <div class="cabinet-device-grid">
                      <div v-for="dev in cab.devices" :key="dev.loader_num" class="device-item"
                        :class="{ selected: isSelectedDevice(dev), disconnected: !toBool(dev.connect) }"
                        @click="selectDevice(dev)" title="单击选中该设备">
                        <div class="device-pic">
                          <img src="img/device.png" alt="device" />
                          <span class="rgb-dot" :class="deviceLedClass(dev)"></span>
                          <span class="device-index">{{ dev.loader_num + 1 }}</span>
                        </div>
                        <div class="device-model" :title="dev.loader_name || dev.running_model || ''">
                          {{ dev.loader_name || dev.running_model || '—' }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- 右侧主区域 -->
      <div class="main-area">
        <div class="toolbar">
          <!-- 模型选择、刷新、启动、停止功能移至此处 -->
          <div class="bar-section" style="flex: 1;">
            <span class="bar-label">模型选择</span>
            <el-cascader v-model="selectedModelPath" :options="modelOptions" :props="{ expandTrigger: 'hover' }"
              size="mini" clearable placeholder="请选择项目/模型" style="width: 280px;"></el-cascader>
            <el-button size="mini" icon="el-icon-refresh" @click="refreshModelOptions" :loading="modelOptionsLoading">
              刷新
            </el-button>
            <el-radio-group v-model="runMode" size="mini" style="margin-left: 10px;" :disabled="isModelRunning">
              <el-radio-button label="model">模型</el-radio-button>
              <el-radio-button label="regen">回灌</el-radio-button>
            </el-radio-group>
          </div>

          <div class="bar-divider"></div>

          <div class="bar-section">
            <el-button size="mini" type="success" icon="el-icon-video-play" @click="startSelectedModel"
              :disabled="!canStartSelected">
              启动
            </el-button>
            <el-button size="mini" type="danger" icon="el-icon-video-pause" @click="stopSelectedModel"
              :disabled="!canStopSelected">
              停止
            </el-button>
          </div>
        </div>

        <div class="content-area">
          <div class="page-tabs">
            <button class="page-tab" :class="{ active: activePage === 'info' }"
              @click="switchPage('info')">设备信息</button>
            <button class="page-tab" :class="{ active: activePage === 'model' }"
              @click="switchPage('model')">参数编辑</button>
            <button class="page-tab" :class="{ active: activePage === 'register' }"
              @click="switchPage('register')">寄存器管理</button>
          </div>

          <!-- 工具弹窗：模型管理（暂不处理） -->
          <el-dialog title="模型管理" :visible.sync="dialogModelVisible" width="520px">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
              <div style="color: var(--text-muted); font-size: 12px;">
                设备文件根目录下的 project1/project2… 会在这里展示（log 文件夹不展示在模型管理里）。
              </div>
              <el-button size="mini" icon="el-icon-refresh" @click="loadModelTree" :loading="modelTreeLoading"
                :disabled="!wsConnected">刷新</el-button>
            </div>
            <el-tree v-if="modelTreeData && modelTreeData.length" :data="modelTreeData" node-key="label"
              :props="{ label: 'label', children: 'children' }" :default-expand-all="false" accordion></el-tree>
            <div v-else style="color: var(--text-muted); font-size: 12px;">
              {{ wsConnected ? (modelTreeLoading ? '加载中…' : '暂无项目目录') : 'WebSocket 未连接' }}
            </div>
            <span slot="footer" class="dialog-footer">
              <el-button size="mini" @click="dialogModelVisible = false">关闭</el-button>
            </span>
          </el-dialog>

          <el-dialog title="日志拉取" :visible.sync="dialogLogVisible" width="650px">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
              <div style="color: var(--text-muted); font-size: 12px;">
                仅展示设备 log 目录下的日志文件。
              </div>
              <el-button size="mini" icon="el-icon-refresh" @click="loadLogTree" :loading="logTreeLoading"
                :disabled="!wsConnected">刷新</el-button>
            </div>

            <div v-if="logTreeData && logTreeData.length"
              style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
              <el-tree :data="logTreeData" node-key="label" :props="{ label: 'label', children: 'children' }"
                :default-expand-all="true" :expand-on-click-node="true" highlight-current>
                <span slot-scope="{ node, data }"
                  style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding-right: 10px;">
                  <span>
                    <i :class="data.children && data.children.length ? 'el-icon-folder' : 'el-icon-document'"
                      style="margin-right: 8px; color: var(--text-muted);"></i>
                    {{ data.label }}
                  </span>
                  <span>
                    <!-- 仅文件显示下载按钮 -->
                    <el-button v-if="!data.children || data.children.length === 0" type="text" size="mini"
                      icon="el-icon-download" @click.stop="handlePullLog(data, node)">下载</el-button>
                    <!-- 所有节点都显示删除按钮 -->
                    <el-button type="text" size="mini" icon="el-icon-delete" style="color: #F56C6C;"
                      @click.stop="handleDeleteLog(data, node)">删除</el-button>
                  </span>
                </span>
              </el-tree>
            </div>
            <div v-else style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">
              {{ wsConnected ? (logTreeLoading ? '加载中…' : '暂无目录/文件') : 'WebSocket 未连接' }}
            </div>
            <span slot="footer" class="dialog-footer">
              <el-button size="mini" @click="dialogLogVisible = false">关闭</el-button>
            </span>
          </el-dialog>

          <!-- 工具弹窗：设备文件获取（参数编辑使用，排除 log 目录） -->
          <el-dialog title="从设备获取文件" :visible.sync="dialogFetchVisible" width="650px">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
              <div style="color: var(--text-muted); font-size: 12px;">
                从设备存储中选择一个文件（排除 log 目录）同步到本地服务器。
              </div>
              <el-button size="mini" icon="el-icon-refresh" @click="loadFetchTree" :loading="fetchTreeLoading"
                :disabled="!wsConnected">刷新</el-button>
            </div>

            <div v-if="fetchTreeData && fetchTreeData.length"
              style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
              <el-tree :data="fetchTreeData" node-key="label" :props="{ label: 'label', children: 'children' }"
                :default-expand-all="false" highlight-current>
                <span slot-scope="{ node, data }"
                  style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding-right: 10px;">
                  <span>
                    <i :class="data.children && data.children.length ? 'el-icon-folder' : 'el-icon-document'"
                      style="margin-right: 8px; color: var(--text-muted);"></i>
                    {{ data.label }}
                  </span>
                  <span>
                    <!-- 仅文件显示获取按钮 -->
                    <el-button v-if="!data.children || data.children.length === 0" type="text" size="mini"
                      icon="el-icon-bottom" @click.stop="confirmFetchFile(data, node)">获取到本地</el-button>
                    <!-- 所有节点（文件和目录）都显示删除按钮 -->
                    <el-button type="text" size="mini" icon="el-icon-delete" style="color: #F56C6C;"
                      @click.stop="handleDeleteFetchFile(data, node)">删除</el-button>
                  </span>
                </span>
              </el-tree>
            </div>
            <div v-else style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">
              {{ wsConnected ? (fetchTreeLoading ? '加载中…' : '暂无可用文件') : 'WebSocket 未连接' }}
            </div>
            <span slot="footer" class="dialog-footer">
              <el-button size="mini" @click="dialogFetchVisible = false">取消</el-button>
            </span>
          </el-dialog>

          <!-- 工具弹窗：设备升级（socket.md 14/15） -->
          <el-dialog title="设备升级（云端/近端）" :visible.sync="dialogUpgradeVisible" width="1100px">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
              <div style="color: var(--text-muted); font-size: 12px;">
                当前展示：loader 名称 / SN / 当前版本 / 云端版本。
              </div>
              <el-button size="mini" type="primary" icon="el-icon-refresh" @click="checkCloudNewVersion"
                :loading="otaLoading" :disabled="!wsConnected">
                获取云端版本
              </el-button>
            </div>
            <div style="margin-bottom: 10px; font-size: 12px; color: var(--text-secondary);">
              {{ otaCloudStatusText }}
            </div>

            <el-table :data="upgradeRows" size="mini" border style="width: 100%;">
              <el-table-column prop="ip" label="IP" width="140"></el-table-column>
              <el-table-column prop="loader_name" label="Loader名称" width="140"></el-table-column>
              <el-table-column prop="sn" label="SN号" width="140"></el-table-column>
              <el-table-column prop="current_version" label="当前版本" width="120"></el-table-column>
              <el-table-column label="云端版本" width="120">
                <template slot-scope="scope">
                  <span v-if="scope.row.target_version">{{ scope.row.target_version }}</span>
                  <span v-else style="color: var(--text-muted);">
                    {{ otaCloudStatus === 'error' ? '获取失败' : (otaCloudStatus === 'empty' ? '无新版本' : (otaCloudStatus ===
                    'never' ? '未获取' : '—')) }}
                  </span>
                </template>
              </el-table-column>
              <el-table-column label="进度" width="220">
                <template slot-scope="scope">
                  <el-progress :percentage="Math.round(getOtaProgress(scope.row.ip, scope.row.loader_num))"
                    :status="getOtaProgressStatus(scope.row.ip, scope.row.loader_num)" :stroke-width="10"></el-progress>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="200">
                <template slot-scope="scope">
                  <el-button size="mini" type="success" @click="openLocalUpgrade(scope.row)"
                    :disabled="!wsConnected">近端升级</el-button>
                  <el-button size="mini" type="primary" @click="startOta(scope.row.ip, scope.row.loader_num)"
                    :disabled="!wsConnected">远端升级</el-button>
                </template>
              </el-table-column>
            </el-table>

            <span slot="footer" class="dialog-footer">
              <el-button size="mini" @click="dialogUpgradeVisible = false">关闭</el-button>
            </span>
          </el-dialog>

          <!-- 近端升级：输入 hex 文件路径 -->
          <el-dialog title="近端升级（输入 .hex 文件路径）" :visible.sync="dialogLocalUpgradeVisible" width="560px">
            <div style="margin-bottom: 15px; font-size: 12px; color: var(--text-muted);">
              目标设备：{{ localUpgradeTarget.ip }} #{{ localUpgradeTarget.loader_num }}（{{ localUpgradeTarget.loader_name ||
              '' }}）
            </div>

            <div style="margin: 20px 0;">
              <el-input v-model="localUpgradePath" placeholder="请输入 .hex 文件的绝对路径，例如：D:\workspace\aaa.hex" size="small"
                style="width: 100%;">
                <template slot="prepend">文件路径</template>
              </el-input>
              <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">
                <i class="el-icon-info"></i> 请输入上位机（服务器）本地文件的完整绝对路径。
              </div>
            </div>

            <span slot="footer" class="dialog-footer">
              <el-button size="mini" @click="dialogLocalUpgradeVisible = false"
                :disabled="localUpgradeLoading">取消</el-button>
              <el-button size="mini" type="primary" :disabled="!localUpgradePath || localUpgradeLoading"
                :loading="localUpgradeLoading" @click="confirmLocalUpgrade">开始近端升级</el-button>
            </span>
          </el-dialog>

          <!-- 控制台：右侧抽屉（保留历史） -->
          <!-- 控制台抽屉（右侧，非模态） -->
          <el-drawer title="控制台" :visible.sync="drawerConsoleVisible" direction="rtl" size="420px" :modal="false"
            :wrapper-closable="false" custom-class="non-modal-drawer">
            <div style="display:flex; flex-direction:column; height: 100%;">
              <div
                style="flex:1; overflow:auto; border:1px solid var(--border-color); border-radius:10px; padding:10px; background: var(--bg-white);">
                <div v-if="!consoleHistory.length" style="color: var(--text-muted); font-size: 12px;">暂无历史记录</div>
                <div v-for="(m, idx) in consoleHistory" :key="idx" style="margin-bottom:8px;">
                  <div style="font-size:11px; color: var(--text-muted);">
                    {{ m.ts }} · {{ m.dir === 'out' ? '发送' : '返回' }}
                  </div>
                  <pre
                    style="white-space: pre-wrap; word-break: break-word; background: var(--bg-gray); padding:8px; border-radius:8px; font-family: var(--font-mono); font-size:12px; margin-top:4px;">{{ m.text }}</pre>
                </div>
              </div>
              <div
                style="margin-top:10px; padding: 10px; background: var(--bg-gray); border: 2px solid var(--border-color); border-radius: 6px;">
                <div style="display:flex; gap:8px; align-items:center;">
                  <el-input v-model="consoleInput" size="small" placeholder="输入控制台命令，例如 120GET:CCV" style="flex: 1;"
                    @keyup.enter.native="sendConsoleCmd"></el-input>
                  <el-button size="small" type="primary" @click="sendConsoleCmd"
                    :disabled="!wsConnected || !consoleInput">发送</el-button>
                </div>
              </div>
              <div style="margin-top:6px; font-size: 12px; color: var(--text-muted);">
                当前设备：{{ device_id }} #{{ loader_num }}
              </div>
            </div>
          </el-drawer>

          <!-- 新增 Sheet 弹窗 -->
          <el-dialog title="新增寄存器 Sheet" :visible.sync="dialogAddSheetVisible" width="400px">
            <el-form label-width="80px">
              <el-form-item label="名称">
                <el-input v-model="newSheetName" placeholder="例如：关键参数" @keyup.enter.native="confirmAddSheet"></el-input>
              </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
              <el-button size="small" @click="dialogAddSheetVisible = false">取消</el-button>
              <el-button size="small" type="primary" @click="confirmAddSheet">确定</el-button>
            </div>
          </el-dialog>

          <!-- 右键菜单 -->
          <div v-if="contextMenuVisible" class="context-menu"
            :style="{ left: contextMenuPos.x + 'px', top: contextMenuPos.y + 'px' }" @click.stop>
            <div class="context-menu-item">
              添加到页签 <i class="el-icon-arrow-right"></i>
              <div class="context-submenu">
                <div v-for="s in registerSheets.filter(x => x.id !== 'root')" :key="s.id" class="context-menu-item"
                  @click="addRegToSheet(contextMenuReg, s.id)">
                  {{ s.name }}
                </div>
                <div v-if="registerSheets.length <= 1" class="context-menu-item muted">暂无自定义页签</div>
              </div>
            </div>
            <div v-if="activeSheetId !== 'root'" class="context-menu-item danger"
              @click="removeRegFromCurrentSheet(contextMenuReg)">
              从当前页签删除
            </div>
          </div>

          <!-- 设备信息页 -->
          <div class="page-content" :class="{ active: activePage === 'info' }">
            <div class="page-header">
              <h2 class="page-title">设备信息</h2>
              <el-button size="mini" icon="el-icon-refresh" @click="refreshDeviceInfo">刷新</el-button>
            </div>
            <div class="page-body">
              <!-- 设备概览卡片 -->
              <div class="device-overview-card">
                <div class="device-photo">
                  <!-- 设备图片展示 -->
                  <img src="img/device_info.png" alt="设备图片" />
                  <div class="device-photo-overlay" v-if="!deviceConnected">
                    <i class="el-icon-warning"></i>
                    <span>设备未连接</span>
                  </div>
                </div>
                <div class="device-overview-info">
                  <div class="device-overview-header">
                    <h3 class="device-model-name">{{ currentDeviceName }}</h3>
                    <el-tag :type="deviceConnected ? 'success' : 'info'" size="small">
                      {{ deviceConnected ? '在线' : '离线' }}
                    </el-tag>
                  </div>

                  <div class="device-info-grid">
                    <div class="info-item">
                      <span class="info-label">设备序列号</span>
                      <span class="info-value sn">{{ deviceInfo.sn || '--' }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">硬件版本</span>
                      <span class="info-value">{{ deviceInfo.hardwareVersion || '--' }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">软件版本</span>
                      <span class="info-value">{{ deviceInfo.softwareVersion || '--' }}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">运行时间</span>
                      <span class="info-value highlight">{{ deviceInfo.runTime || '--' }}</span>
                    </div>
                  </div>

                  <!-- 正在运行的模型 -->
                  <div class="running-model-info" v-if="deviceConnected && isModelRunning">
                    <div class="running-model-badge">
                      <i class="el-icon-video-play"></i>
                      <span>模型运行中</span>
                    </div>
                    <div class="running-model-detail">
                      <span class="running-label">文件:</span>
                      <span class="running-value">{{ runningFile }}</span>
                      <span class="running-label">模块:</span>
                      <span class="running-value">{{ getModuleDisplayName(runningModule) }}</span>
                    </div>
                  </div>
                  <div class="running-model-info stopped" v-else-if="deviceConnected">
                    <div class="running-model-badge stopped">
                      <i class="el-icon-video-pause"></i>
                      <span>模型未运行</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 设备规格 -->
              <div class="spec-section">
                <h4 class="section-title">
                  <i class="el-icon-data-analysis"></i>
                  设备规格
                </h4>
                <div class="spec-grid">
                  <div class="spec-card">
                    <div class="spec-icon" style="background: rgba(37, 99, 235, 0.1); color: var(--primary-color);">
                      <i class="el-icon-s-data"></i>
                    </div>
                    <div class="spec-content">
                      <span class="spec-value">{{ currentSpecs.max_current_a }} A</span>
                      <span class="spec-label">最大电流</span>
                    </div>
                  </div>
                  <div class="spec-card">
                    <div class="spec-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success-color);">
                      <i class="el-icon-lightning"></i>
                    </div>
                    <div class="spec-content">
                      <span class="spec-value">±{{ Math.abs(currentSpecs.max_voltage_v) }} V</span>
                      <span class="spec-label">最大电压</span>
                    </div>
                  </div>
                  <div class="spec-card">
                    <div class="spec-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning-color);">
                      <i class="el-icon-odometer"></i>
                    </div>
                    <div class="spec-content">
                      <span class="spec-value">{{ currentSpecs.max_power_w }} W</span>
                      <span class="spec-label">最大功率</span>
                    </div>
                  </div>
                  <div class="spec-card">
                    <div class="spec-icon" style="background: rgba(139, 92, 246, 0.1); color: var(--running-color);">
                      <i class="el-icon-time"></i>
                    </div>
                    <div class="spec-content">
                      <span class="spec-value">{{ currentSpecs.sample_rate_khz }} kHz</span>
                      <span class="spec-label">采样率</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 实时数据 -->
              <div class="realtime-section" v-if="deviceConnected">
                <h4 class="section-title">
                  <i class="el-icon-data-line"></i>
                  实时数据
                </h4>
                <div class="realtime-grid">
                  <div class="realtime-card">
                    <span class="realtime-value">{{ realtimeData.current.toFixed(1) }}</span>
                    <span class="realtime-unit">A</span>
                    <span class="realtime-label">电流</span>
                    <div class="realtime-bar">
                      <div class="realtime-bar-fill" :style="{ width: (realtimeData.current / 100 * 100) + '%' }"></div>
                    </div>
                  </div>
                  <div class="realtime-card">
                    <span class="realtime-value">{{ realtimeData.voltage.toFixed(0) }}</span>
                    <span class="realtime-unit">V</span>
                    <span class="realtime-label">电压</span>
                    <div class="realtime-bar">
                      <div class="realtime-bar-fill"
                        :style="{ width: (realtimeData.voltage / 600 * 100) + '%', background: 'var(--success-color)' }">
                      </div>
                    </div>
                  </div>
                  <div class="realtime-card">
                    <span class="realtime-value">{{ realtimeData.power.toFixed(1) }}</span>
                    <span class="realtime-unit">kW</span>
                    <span class="realtime-label">功率</span>
                    <div class="realtime-bar">
                      <div class="realtime-bar-fill"
                        :style="{ width: (realtimeData.power / 50 * 100) + '%', background: 'var(--warning-color)' }">
                      </div>
                    </div>
                  </div>
                  <div class="realtime-card">
                    <span class="realtime-value">{{ realtimeData.temperature }}</span>
                    <span class="realtime-unit">°C</span>
                    <span class="realtime-label">温度</span>
                    <div class="realtime-bar">
                      <div class="realtime-bar-fill"
                        :style="{ width: (realtimeData.temperature / 80 * 100) + '%', background: realtimeData.temperature > 60 ? 'var(--error-color)' : 'var(--running-color)' }">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 参数编辑页 -->
          <div class="page-content" :class="{ active: activePage === 'model' }">
            <div class="page-header">
              <h2 class="page-title">参数编辑</h2>
              <div class="btn-group">
                <el-tooltip content="云端上传（暂未开放）" placement="top">
                  <button class="action-btn" :disabled="true" @click="handleUploadCloud">
                    <i class="el-icon-upload2"></i>云端上传
                  </button>
                </el-tooltip>
                <el-tooltip content="云端下载（暂未开放）" placement="top">
                  <button class="action-btn" :disabled="true" @click="handleDownloadCloudModel">
                    <i class="el-icon-download"></i>云端下载
                  </button>
                </el-tooltip>

                <span class="btn-divider"></span>

                <el-tooltip content="从设备获取文件" placement="top">
                  <button class="action-btn" :disabled="!wsConnected" @click="handleDownloadDevice">
                    <i class="el-icon-top"></i>模型导出
                  </button>
                </el-tooltip>
                <el-tooltip content="将资源导入到设备存储" placement="top">
                  <button class="action-btn" :disabled="!wsConnected" @click="handleLoadModelToDevice">
                    <i class="el-icon-bottom"></i>模型导入
                  </button>
                </el-tooltip>

                <span class="btn-divider"></span>

                <el-tooltip content="保存到本地文件" placement="top" :open-delay="500">
                  <button class="action-btn primary" :disabled="!currentModel || !hasModified" @click="handleSave">
                    <i class="el-icon-folder-checked"></i>保存
                  </button>
                </el-tooltip>
                <el-tooltip content="另存为新文件" placement="top" :open-delay="500">
                  <button class="action-btn primary" :disabled="!currentModel || !currentModel.success"
                    @click="handleSaveAs">
                    <i class="el-icon-document-add"></i>另存为
                  </button>
                </el-tooltip>
                <el-tooltip content="更新设备输出（立即生效）" placement="top" :open-delay="500">
                  <button class="action-btn success" :disabled="!canApply" @click="handleApply">
                    <i class="el-icon-video-play"></i>应用
                  </button>
                </el-tooltip>
              </div>
            </div>
            <div class="page-body">
              <!-- 回灌模式时显示空状态 -->
              <div v-if="runMode === 'regen'" class="empty-state" style="height: 100%; padding: 60px 20px;">
                <i class="el-icon-info" style="font-size: 48px; color: var(--text-muted);"></i>
                <p style="margin-top: 20px; color: var(--text-secondary);">回灌模式下不支持参数编辑</p>
                <p style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">请切换到"模型"模式进行参数编辑</p>
              </div>

              <!-- 模型模式时显示编辑界面 -->
              <template v-else>
                <div class="data-path">
                  <i class="el-icon-folder"></i>
                  <span>数据目录: wcar_resource/loader/model</span>
                </div>

                <div class="model-layout">
                  <!-- 模型列表 -->
                  <div class="model-list">
                    <div class="model-list-header">
                      <span>模型文件</span>
                      <div style="display:flex; gap:5px; align-items:center;">
                        <el-button type="text" size="mini" icon="el-icon-plus" @click="handleCreateNewModel"
                          title="新建模型文件"></el-button>
                      </div>
                    </div>
                    <div v-for="(model, index) in models" :key="index" class="model-item" :class="{ 
                      active: activeModelIndex === index,
                      'has-error': model.errors && model.errors.length > 0,
                      'is-running': isFileRunning(model.filename),
                      'drag-over': dragOverModelIndex === index
                    }" @click="handleSelectModel(index)" draggable="true" @dragstart="handleModelDragStart($event, index)"
                      @dragover.prevent="handleModelDragOver($event, index)" @dragleave="handleModelDragLeave($event)"
                      @drop="handleModelDrop($event, index)">
                      <i :class="model.success ? 'el-icon-document' : 'el-icon-document-delete'"></i>
                      <div class="model-item-info">
                        <div class="model-item-name">{{ model.filename }}</div>
                        <div class="model-item-size">{{ model.modules ? model.modules.length + ' 个模块' : '解析失败' }}</div>
                      </div>
                      <div class="model-item-btns" @click.stop>
                        <el-button type="text" size="mini" icon="el-icon-delete" class="delete-btn"
                          @click="handleDeleteModel(model, index)" v-if="!isFileRunning(model.filename)"
                          title="删除模型文件"></el-button>
                      </div>
                      <span v-if="isFileRunning(model.filename)" class="model-item-badge running" title="该模型正在运行中">
                        <i class="el-icon-video-play"></i>
                        <span>运行中</span>
                      </span>
                    </div>
                  </div>

                  <!-- 编辑器 -->
                  <div class="model-editor" v-if="currentModel">
                    <div class="editor-toolbar">
                      <div class="editor-filename">
                        <i class="el-icon-document"></i>
                        <span>{{ currentModel.filename }}</span>
                        <span class="modified-dot" v-if="hasModified"></span>
                        <el-tag v-if="isFileRunning(currentModel.filename)" size="mini" type="warning" effect="dark"
                          style="margin-left:8px;">
                          <i class="el-icon-video-play"></i> 运行中
                        </el-tag>
                      </div>
                      <div style="display:flex; gap:10px;">
                        <el-button type="text" size="mini" icon="el-icon-circle-plus-outline"
                          @click="handleOpenAddModuleDialog">
                          添加模块
                        </el-button>
                        <el-button type="text" size="mini" icon="el-icon-view" @click="showRaw = !showRaw">
                          {{ showRaw ? '编辑视图' : '原始内容' }}
                        </el-button>
                      </div>
                    </div>

                    <!-- 错误和警告显示 -->
                    <div v-if="currentModel.errors && currentModel.errors.length"
                      style="margin: 10px; padding: 10px; background: #FEF0F0; border: 1px solid #FDE2E2; border-radius: 4px; color: #F56C6C; font-size: 12px;">
                      <div style="font-weight: bold; margin-bottom: 5px;"><i class="el-icon-error"></i> 解析错误:</div>
                      <div v-for="(err, ei) in currentModel.errors" :key="ei">
                        • {{ err.message }} <span v-if="err.lineNum">(第 {{ err.lineNum }} 行)</span>
                      </div>
                    </div>
                    <div v-if="currentModel.warnings && currentModel.warnings.length"
                      style="margin: 10px; padding: 10px; background: #FDF6EC; border: 1px solid #FAECD8; border-radius: 4px; color: #E6A23C; font-size: 12px;">
                      <div style="font-weight: bold; margin-bottom: 5px;"><i class="el-icon-warning"></i> 警告:</div>
                      <div v-for="(wrn, wi) in currentModel.warnings" :key="wi">
                        • {{ wrn.message }} <span v-if="wrn.lineNum">(第 {{ wrn.lineNum }} 行)</span>
                      </div>
                    </div>

                    <!-- 原始内容视图 -->
                    <div v-if="showRaw" style="flex: 1; overflow: auto;">
                      <pre
                        style="background: var(--bg-gray); padding: 12px; border-radius: 6px; font-family: var(--font-mono); font-size: 12px; line-height: 1.6; white-space: pre-wrap;">{{ currentModel.raw }}</pre>
                    </div>

                    <!-- 模块编辑视图 -->
                    <div v-else style="flex: 1; overflow-y: auto;">
                      <div v-if="currentModel.modules && currentModel.modules.length">
                        <div v-for="(mod, mi) in currentModel.modules" :key="mi" class="module-section"
                          :class="{ 'is-running': isModuleRunning(currentModel.filename, mod.name) }">
                          <div class="module-header" @click="toggleModule(mi)">
                            <span class="module-toggle" :class="{ expanded: expandedModules[mi] }">
                              <i class="el-icon-arrow-right"></i>
                            </span>
                            <div class="module-info">
                              <div class="module-name-row">
                                <span class="module-name">{{ mod.name }}</span>
                                <span class="module-name-cn" v-if="getModuleDef(mod.name)">{{
                                  getModuleDef(mod.name).name }}</span>
                              </div>
                              <div class="module-desc" v-if="getModuleDef(mod.name)">{{
                                getModuleDef(mod.name).description }}</div>
                            </div>
                            <span v-if="isModuleRunning(currentModel.filename, mod.name)" class="running-indicator">
                              <i class="el-icon-video-play"></i> 运行中
                            </span>
                            <span class="module-count">{{ mod.params.length }} 参数</span>
                            <div class="module-btns" @click.stop>
                              <el-button type="text" size="mini" icon="el-icon-delete" class="delete-btn"
                                @click="handleRemoveModule(mi)" v-if="!isModuleRunning(currentModel.filename, mod.name)"
                                title="删除此模块"></el-button>
                            </div>
                          </div>
                          <div class="module-body" :class="{ expanded: expandedModules[mi] }">
                            <!-- 添加参数按钮 -->
                            <div v-if="expandedModules[mi]"
                              style="padding: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 8px;">
                              <el-button type="text" size="mini" icon="el-icon-plus"
                                @click="handleOpenAddParamDialog(mi)"
                                :disabled="isModuleRunning(currentModel.filename, mod.name)">
                                添加参数
                              </el-button>
                            </div>
                            <div v-for="(param, pi) in mod.params" :key="pi" class="param-row"
                              :class="{ 'out-of-range': isOutOfRange(param) }">
                              <div class="param-label-section">
                                <div class="param-name-row">
                                  <span class="param-key">{{ param.name }}</span>
                                  <span class="param-name-cn" v-if="getParamDef(param.name)">
                                    {{ getParamDef(param.name).description }}
                                  </span>
                                  <span class="param-unknown" v-else>未定义</span>
                                </div>
                                <div class="param-range"
                                  v-if="getParamDef(param.name) && getParamDef(param.name).min !== undefined">
                                  <i class="el-icon-info"></i>
                                  范围: {{ getParamDef(param.name).min }} ~ {{ getParamDef(param.name).max }}
                                  <span v-if="getParamDef(param.name).default !== undefined">
                                    (默认: {{ getParamDef(param.name).default }})
                                  </span>
                                </div>
                              </div>

                              <div class="param-input-section">
                                <!-- 单值 -->
                                <template v-if="param.type === 'single'">
                                  <div class="param-input-row">
                                    <el-input-number v-if="isNumericParam(param)" :value="param.value" size="mini"
                                      controls-position="right"
                                      :min="getParamDef(param.name) ? getParamDef(param.name).min : -Infinity"
                                      :max="getParamDef(param.name) ? getParamDef(param.name).max : Infinity"
                                      :step="getParamDef(param.name) ? (getParamDef(param.name).step || 1) : 1"
                                      :precision="getPrecision(param.name)"
                                      @change="updateSingleParam(param, $event)"></el-input-number>
                                    <el-input v-else v-model="param.value" size="mini"
                                      @input="hasModified = true"></el-input>
                                    <span class="param-unit">{{ getParamDef(param.name) ? getParamDef(param.name).unit :
                                      '' }}</span>
                                    <span class="param-type-badge">{{ param.type }}</span>
                                  </div>
                                  <div class="range-warning" v-if="isOutOfRange(param)">
                                    <i class="el-icon-warning"></i>
                                    值超出建议范围
                                  </div>
                                </template>

                                <!-- 数组 -->
                                <template v-else-if="param.type === 'array'">
                                  <div class="array-display">
                                    <div class="array-header">
                                      <span class="array-label">数组 [{{ param.value.length }}]</span>
                                      <el-button type="text" size="mini" icon="el-icon-plus"
                                        @click="addArrayItem(param)"></el-button>
                                    </div>
                                    <div class="array-items">
                                      <div v-for="(item, idx) in param.value" :key="idx" class="array-item">
                                        <span class="array-index">[{{ idx }}]</span>
                                        <el-input-number v-if="typeof item === 'number'" :value="item" size="mini"
                                          controls-position="right"
                                          @change="updateArrayItem(param, idx, $event)"></el-input-number>
                                        <el-input v-else :value="item" size="mini"
                                          @input="updateArrayItemStr(param, idx, $event)"></el-input>
                                        <el-button type="text" size="mini" icon="el-icon-delete"
                                          @click="removeArrayItem(param, idx)"></el-button>
                                      </div>
                                    </div>
                                  </div>
                                </template>

                                <!-- 矩阵 -->
                                <template v-else-if="param.type === 'matrix'">
                                  <div class="matrix-display">
                                    <div class="matrix-toolbar">
                                      <span class="matrix-size">{{ param.value.length }} × {{ param.value[0] ?
                                        param.value[0].length : 0 }}</span>
                                      <el-button type="text" size="mini" icon="el-icon-plus"
                                        @click="addMatrixRow(param)">添加行</el-button>
                                    </div>
                                    <div class="matrix-table">
                                      <div class="matrix-header"
                                        v-if="getParamDef(param.name) && getParamDef(param.name).columns">
                                        <span class="matrix-row-index">#</span>
                                        <span v-for="(col, ci) in getParamDef(param.name).columns" :key="ci"
                                          class="matrix-header-cell">{{ col }}</span>
                                        <span class="matrix-action-cell"></span>
                                      </div>
                                      <div v-for="(row, ri) in param.value" :key="ri" class="matrix-row">
                                        <span class="matrix-row-index">{{ ri }}</span>
                                        <el-input-number v-for="(cell, ci) in row" :key="ci" :value="cell" size="mini"
                                          controls-position="right" class="matrix-cell-input"
                                          @change="updateMatrixCell(param, ri, ci, $event)"></el-input-number>
                                        <el-button type="text" size="mini" icon="el-icon-delete"
                                          class="matrix-delete-btn" @click="removeMatrixRow(param, ri)"></el-button>
                                      </div>
                                    </div>
                                  </div>
                                </template>
                              </div>
                              <!-- 删除参数按钮 -->
                              <div class="param-actions">
                                <el-button type="text" size="mini" icon="el-icon-delete" class="delete-btn"
                                  @click="handleRemoveParam(mi, pi)"
                                  :disabled="isModuleRunning(currentModel.filename, mod.name)"
                                  title="删除此参数"></el-button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div v-else class="empty-state">
                        <i class="el-icon-warning-outline"></i>
                        <p>该文件解析失败</p>
                      </div>
                    </div>
                  </div>

                  <div v-else class="model-editor">
                    <div class="empty-state" style="height: 100%;">
                      <i class="el-icon-folder-opened"></i>
                      <p>请从左侧选择一个模型文件</p>
                    </div>
                  </div>
                </div>
            </div>
            </template>
          </div>

          <!-- 弹窗：新建模型文件 -->
          <el-dialog title="新建模型文件" :visible.sync="dialogNewModelVisible" width="400px">
            <el-form label-width="80px">
              <el-form-item label="文件名">
                <el-input v-model="newModelFilename" placeholder="请输入文件名（不含扩展名）">
                  <template slot="append">.bin</template>
                </el-input>
              </el-form-item>
            </el-form>
            <div slot="footer">
              <el-button size="mini" @click="dialogNewModelVisible = false">取消</el-button>
              <el-button size="mini" type="primary" @click="confirmCreateNewModel">确定</el-button>
            </div>
          </el-dialog>

          <!-- 弹窗：添加模块 -->
          <el-dialog title="添加模块" :visible.sync="dialogAddModuleVisible" width="500px">
            <el-form label-width="100px">
              <el-form-item label="模块类型">
                <el-select v-model="selectedModuleType" placeholder="请选择模块类型" style="width: 100%;" filterable>
                  <el-option v-for="mod in availableModules" :key="mod.id" :label="mod.name + ' (' + mod.id + ')'"
                    :value="mod.id">
                    <span style="float: left">{{ mod.name }}</span>
                    <span style="float: right; color: #8492a6; font-size: 13px">{{ mod.id }}</span>
                  </el-option>
                </el-select>
              </el-form-item>
              <div v-if="selectedModuleType"
                style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <div style="font-weight: bold; margin-bottom: 5px;">模块描述:</div>
                <div style="font-size: 13px; color: #606266;">{{ getModuleDesc(selectedModuleType) }}</div>
              </div>
            </el-form>
            <div slot="footer">
              <el-button size="mini" @click="dialogAddModuleVisible = false">取消</el-button>
              <el-button size="mini" type="primary" @click="confirmAddModule"
                :disabled="!selectedModuleType">确定</el-button>
            </div>
          </el-dialog>

          <!-- 弹窗：添加参数 -->
          <el-dialog title="添加参数" :visible.sync="dialogAddParamVisible" width="500px">
            <el-form label-width="100px">
              <el-form-item label="参数类型">
                <el-select v-model="selectedParamName" placeholder="请选择参数" style="width: 100%;" filterable>
                  <el-option v-for="param in availableParamsForModule" :key="param.name" :label="param.displayName"
                    :value="param.name">
                    <span style="float: left">{{ param.displayName }}</span>
                    <span style="float: right; color: #8492a6; font-size: 13px">ID: {{ param.id }}</span>
                  </el-option>
                </el-select>
              </el-form-item>
              <div v-if="selectedParamName"
                style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <div style="font-weight: bold; margin-bottom: 5px;">参数描述:</div>
                <div style="font-size: 13px; color: #606266;">{{ getParamDef(selectedParamName) ?
                  getParamDef(selectedParamName).description : '无描述' }}</div>
              </div>
            </el-form>
            <div slot="footer">
              <el-button size="mini" @click="dialogAddParamVisible = false">取消</el-button>
              <el-button size="mini" type="primary" @click="confirmAddParam"
                :disabled="!selectedParamName">确定</el-button>
            </div>
          </el-dialog>

          <!-- 弹窗：导入设备选择（资源树浏览器） -->
          <el-dialog title="资源导入设备" :visible.sync="dialogImportDeviceVisible" width="600px">
            <div style="margin-bottom: 15px;">
              <el-radio-group v-model="importDeviceType" size="mini">
                <el-radio label="current">导入当前设备</el-radio>
                <!-- 暂时隐藏导入所有设备功能 -->
                <!-- <el-radio label="all">导入所有设备</el-radio> -->
              </el-radio-group>
            </div>

            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 10px;">
              <div style="color: var(--text-muted); font-size: 12px;">
                请选择要导入的资源 (来自上位机 wcar_resource/loader 目录)：
              </div>
              <el-button size="mini" icon="el-icon-refresh" @click="refreshResourceTree"
                :loading="resourceTreeLoading">刷新</el-button>
            </div>

            <div v-loading="resourceTreeLoading"
              style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
              <el-tree :key="resourceTreeKey" :props="{ label: 'label', children: 'children', isLeaf: 'isLeaf' }" lazy
                :load="loadResourceNode" @node-click="handleResourceNodeClick" @node-expand="handleResourceNodeExpand"
                highlight-current>
                <span slot-scope="{ node, data }" style="display: flex; align-items: center; gap: 8px;">
                  <i :class="node.isLeaf ? 'el-icon-document' : 'el-icon-folder'" style="color: var(--text-muted);"></i>
                  <span>{{ data.label }}</span>
                </span>
              </el-tree>
            </div>

            <div v-if="selectedResourcePath" style="margin-top: 15px; font-size: 12px; color: var(--primary-color);">
              <strong>已选择导入路径:</strong> {{ selectedResourcePath }}
            </div>

            <div slot="footer">
              <el-button size="mini" @click="dialogImportDeviceVisible = false">取消</el-button>
              <el-button size="mini" type="primary" @click="confirmImportDevice"
                :disabled="!selectedResourcePath">开始导入</el-button>
            </div>
          </el-dialog>

          <!-- 寄存器管理页 -->
          <div class="page-content" :class="{ active: activePage === 'register' }">
            <div class="page-header">
              <h2 class="page-title">寄存器管理</h2>
              <div class="page-header-actions">
                <el-input v-model="registerSearch" placeholder="搜索寄存器..." prefix-icon="el-icon-search" size="mini"
                  style="width: 200px; margin-right: 10px;" clearable></el-input>
                <el-button size="mini" icon="el-icon-refresh" @click="refreshSheetRegisters(currentSheet)"
                  :loading="registerLoading">
                  刷新当前页
                </el-button>
              </div>
            </div>
            <div class="page-body register-page" style="display: flex; flex-direction: column;">
              <!-- Sheet 切换 -->
              <div
                style="display: flex; align-items: center; background: var(--bg-white); border-bottom: 1px solid var(--border-color); padding-left: 10px;">
                <el-tabs v-model="activeSheetId" type="card" @tab-remove="handleSheetRemove"
                  style="margin-bottom: -1px;">
                  <el-tab-pane v-for="(sheet, index) in registerSheets" :key="sheet.id" :name="sheet.id"
                    :closable="sheet.id !== 'root'">
                    <span slot="label" class="tab-label-zone" :class="{ 
                        'root-tab-label': sheet.id === 'root',
                        'drag-over-tab': dragOverTabIndex === index
                      }" :draggable="sheet.id !== 'root'" @dragstart="handleTabDragStart($event, index)"
                      @dragover.prevent="handleTabDragOver($event, index)" @dragleave="handleTabDragLeave($event)"
                      @drop="handleDropOnTab($event, index)">
                      <i v-if="sheet.id === 'root'" class="el-icon-collection"></i>
                      <span @dblclick="renameSheet(sheet)">{{ sheet.name }}</span>
                      <i v-if="sheet.timerEnabled" class="el-icon-timer"
                        style="color: var(--primary-color); margin-left: 4px;" title="自动刷新中"></i>
                    </span>
                  </el-tab-pane>
                </el-tabs>
                <el-button size="mini" type="text" icon="el-icon-plus" style="margin-left: 10px; padding: 8px;"
                  @click="handleSheetAdd" title="新建页签（上限5个）"></el-button>
              </div>

              <!-- 当前 Sheet 的控制项 (仅非 root sheet 显示自动刷新开关) -->
              <div v-if="activeSheetId !== 'root'"
                style="padding: 8px 12px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 5px; background: #f8fafc;">
                <div
                  style="font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 5px;">
                  自动刷新:
                  <el-switch v-model="currentSheet.timerEnabled" size="mini"
                    @change="toggleSheetTimer(currentSheet)"></el-switch>
                </div>
                <div v-if="currentSheet.timerEnabled"
                  style="font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 5px;">
                  间隔:
                  <el-input-number v-model="currentSheet.timerInterval" size="mini" :min="500" :max="20000" :step="500"
                    style="width: 100px;"
                    @change="saveRegisterSheets(); startSheetTimer(currentSheet);"></el-input-number>
                  ms
                </div>
                <div style="flex: 1; text-align: right; font-size: 11px; color: var(--text-muted);">
                  提示：可从“全量寄存器”拖拽条目到其他页签；双击页签重命名。
                </div>
              </div>

              <div class="register-table-container" style="flex: 1; overflow: auto; margin-top: 5px;">
                <table class="register-table">
                  <thead>
                    <tr>
                      <th width="65" style="text-align: center;">ID</th>
                      <th width="100">名称</th>
                      <th width="70" style="text-align: center;">
                        <el-dropdown trigger="click" @command="v => registerTypeFilter = v">
                          <span class="el-dropdown-link" style="cursor: pointer; font-size: 12px; color: inherit;">
                            类型<i class="el-icon-arrow-down el-icon--right"></i>
                          </span>
                          <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item command="all"
                              :disabled="registerTypeFilter === 'all'">全部类型</el-dropdown-item>
                            <el-dropdown-item command="int"
                              :disabled="registerTypeFilter === 'int'">数值型</el-dropdown-item>
                            <el-dropdown-item command="string"
                              :disabled="registerTypeFilter === 'string'">字符串型</el-dropdown-item>
                          </el-dropdown-menu>
                        </el-dropdown>
                      </th>
                      <th width="70" style="text-align: center;">
                        <el-dropdown trigger="click" @command="v => registerFilter = v">
                          <span class="el-dropdown-link" style="cursor: pointer; font-size: 12px; color: inherit;">
                            权限<i class="el-icon-arrow-down el-icon--right"></i>
                          </span>
                          <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item command="all" :disabled="registerFilter === 'all'">全部权限</el-dropdown-item>
                            <el-dropdown-item command="read" :disabled="registerFilter === 'read'">只读</el-dropdown-item>
                            <el-dropdown-item command="write"
                              :disabled="registerFilter === 'write'">只写</el-dropdown-item>
                            <el-dropdown-item command="readwrite"
                              :disabled="registerFilter === 'readwrite'">读写</el-dropdown-item>
                          </el-dropdown-menu>
                        </el-dropdown>
                      </th>
                      <th width="110">当前值</th>
                      <th width="350">新值</th>
                      <th>描述</th>
                      <th width="140">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(reg, index) in filteredRegisters" :key="reg.name" draggable="true"
                      @dragstart="handleDragStart($event, reg, index)"
                      @dragover.prevent="handleDragOverRow($event, index)" @dragleave="handleDragLeaveRow($event)"
                      @drop="handleDropOnRow($event, index)" @contextmenu.prevent="showContextMenu($event, reg)" :class="{ 
                        'reg-modified': reg.modified, 
                        'reg-read-error': reg.readError,
                        'drag-over-row': dragOverRowIndex === index 
                      }">
                      <td class="reg-id" style="text-align: center;">0x{{
                        reg.address.toString(16).toUpperCase().padStart(4, '0') }}</td>
                      <td class="reg-name">{{ reg.name }}</td>
                      <td style="text-align: center;">
                        <el-tag size="mini" :type="reg.type === 'int' ? '' : 'warning'">
                          {{ reg.type === 'int' ? '数值' : '字符串' }}
                        </el-tag>
                      </td>
                      <td style="text-align: center;">
                        <el-tag size="mini"
                          :type="reg.access === 'read' ? 'info' : (reg.access === 'write' ? 'danger' : 'success')">
                          {{ reg.access === 'read' ? '只读' : (reg.access === 'write' ? '只写' : '读写') }}
                        </el-tag>
                      </td>
                      <td class="reg-value" :class="{ 'text-danger': reg.readError }">
                        <template v-if="reg.access !== 'write'">
                          {{ reg.readError ? '读取失败' : (reg.value !== null ? reg.value : '--') }}
                        </template>
                        <span v-else class="muted">--</span>
                      </td>
                      <td class="reg-write">
                        <div v-if="reg.access !== 'read'" class="reg-input-wrap">
                          <input v-if="reg.type === 'int'" type="number" class="reg-input"
                            v-model.number="reg.inputValue" @keyup.enter="writeRegister(reg)"
                            :placeholder="reg.access === 'write' ? '输入后写入' : '新值'"
                            :min="reg.min !== null ? reg.min : undefined"
                            :max="reg.max !== null ? reg.max : undefined" />
                          <input v-else type="text" class="reg-input" v-model="reg.inputValue"
                            @keyup.enter="writeRegister(reg)" :placeholder="reg.access === 'write' ? '输入后写入' : '新值'" />
                        </div>
                        <span v-else class="muted">只读</span>
                      </td>
                      <td class="reg-desc">
                        <div>{{ reg.description }}</div>
                        <div v-if="reg.type === 'int' && reg.min !== null && reg.max !== null" class="reg-range">
                          范围: {{ reg.min }} ~ {{ reg.max }}
                        </div>
                      </td>
                      <td class="reg-actions">
                        <!-- 可读的显示刷新按钮 -->
                        <el-button v-if="reg.access !== 'write'" size="mini" icon="el-icon-refresh"
                          :loading="reg.loading" @click="readRegister(reg)">读取</el-button>
                        <!-- 可写的显示写入按钮 -->
                        <el-button v-if="reg.access !== 'read'" size="mini" type="primary" icon="el-icon-upload2"
                          :disabled="reg.inputValue === '' || reg.inputValue === null"
                          @click="writeRegister(reg)">写入</el-button>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <div v-if="filteredRegisters.length === 0" class="empty-state" style="padding: 40px;">
                  <i class="el-icon-folder-opened"></i>
                  <p>没有匹配的寄存器</p>
                </div>
              </div>

              <!-- 寄存器统计 -->
              <div class="register-stats">
                <span>共 {{ registers.length }} 个寄存器</span>
                <span>|</span>
                <span>只读: {{ registers.filter(r => r.access === 'read').length }}</span>
                <span>只写: {{ registers.filter(r => r.access === 'write').length }}</span>
                <span>读写: {{ registers.filter(r => r.access === 'readwrite').length }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧悬浮面板 -->
    <div id="floating-panel" class="floating-panel">
      <div class="floating-item" @click="openUpgradeDialog" title="设备升级">
        <i class="el-icon-upload"></i>
        <span>设备升级</span>
      </div>
      <div class="floating-item" @click="openLogDialog" title="日志拉取">
        <i class="el-icon-document"></i>
        <span>日志拉取</span>
      </div>
      <div class="floating-item" @click="openConsoleDrawer" title="控制台">
        <i class="el-icon-monitor"></i>
        <span>控制台</span>
      </div>
      <div class="drag-handle" title="上下拖动调整位置">
        <i class="el-icon-rank"></i>
      </div>
    </div>
  </div>

  <script>
    // 全局修改 Element UI 消息提示默认配置
    const _originalMessage = Vue.prototype.$message;
    Vue.prototype.$message = function (options) {
      const defaultOptions = {
        duration: 1500, // 降低显示时长至 1.5s
        offset: 75,     // 位于 toolbar (60px) 下方，避开模型选择框
        showClose: true
      };
      if (typeof options === 'string') {
        return _originalMessage({ ...defaultOptions, message: options });
      }
      return _originalMessage({ ...defaultOptions, ...options });
    };
    // 重新绑定便捷方法
    ['success', 'warning', 'info', 'error'].forEach(type => {
      Vue.prototype.$message[type] = (options) => {
        if (typeof options === 'string') options = { message: options };
        options.type = type;
        return Vue.prototype.$message(options);
      };
    });

    // 参数编辑字典（由后端提供，见 /api/model/dictionary 或 WS action: model.dictionary）
    let modelDictionary = { parameters: {}, modules: {} };

    // ============================================================
    // WebSocket 通信类
    // ============================================================
    class WSClient {
      constructor(url = null) {
        // 默认连接策略：
        // - 业务要求：WebSocket 由 Python 服务提供，端口固定 28657
        // - 允许通过 window.WS_URL 覆盖（例如路径不是 /ws 时）
        if (!url) {
          if (window.WS_URL) {
            url = window.WS_URL;
          } else {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname;
            // Python WS 固定端口
            url = `${protocol}//${host}:28657/ws`;
          }
        }
        this.url = url;
        this.ws = null;
        this.connected = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectInterval = 3000;
        // Python WS 协议字段：cmd_id（时间戳/整型），topic 固定 sim_loader
        // 业务约定：所有消息 topic 统一为 LOADER
        this.topic = 'LOADER';
        this.messageId = 0; // 保留，但默认用 cmd_id
        this.pendingRequests = new Map();
        this.listeners = new Map();
        this.requestTimeout = 10000; // 默认超时时间 10s
      }

      /**
       * 连接WebSocket服务器
       */
      connect() {
        return new Promise((resolve, reject) => {
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            resolve();
            return;
          }

          this.ws = new WebSocket(this.url);

          this.ws.onopen = () => {
            console.log('[WS] 连接成功');
            this.connected = true;
            this.reconnectAttempts = 0;
            // 建链握手：告知服务端 UI 已上线
            try {
              // 第一帧严格按要求：纯字符串
              this.ws.send('Hello, I am loader');
            } catch (e) {
              console.warn('[WS] hello handshake failed:', e);
            }
            // 注意：必须在 hello 之后再触发 connected，
            // 否则 connected 的回调里会立刻发送 device.info 等请求，导致第一帧不是 hello
            this.emit('connected');
            resolve();
          };

          this.ws.onclose = (event) => {
            console.log('[WS] 连接关闭', event.code, event.reason);
            this.connected = false;
            this.emit('disconnected');
            this.tryReconnect();
          };

          this.ws.onerror = (error) => {
            console.error('[WS] 连接错误', error);
            this.emit('error', error);
            reject(error);
          };

          this.ws.onmessage = (event) => {
            this.handleMessage(event.data);
          };
        });
      }

      /**
       * 断开连接
       */
      disconnect() {
        if (this.ws) {
          this.ws.close();
          this.ws = null;
        }
        this.connected = false;
      }

      /**
       * 尝试重连
       */
      tryReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
          console.log('[WS] 达到最大重连次数，停止重连');
          this.emit('reconnectFailed');
          return;
        }

        this.reconnectAttempts++;
        console.log(`[WS] 尝试重连 (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);

        setTimeout(() => {
          this.connect().catch(() => { });
        }, this.reconnectInterval);
      }

      /**
       * 处理收到的消息
       */
      handleMessage(data) {
        try {
          if (typeof data !== 'string') return;
          const message = JSON.parse(data);

          // 兼容 socket.md 某些示例：响应可能直接是数组
          if (Array.isArray(message)) {
            if (this.pendingRequests.size > 0) {
              // 找到最新（数值最大）的 cmd_id
              let latestKey = null;
              for (const k of this.pendingRequests.keys()) {
                if (latestKey === null || Number(k) > Number(latestKey)) latestKey = k;
              }
              const pending = latestKey !== null ? this.pendingRequests.get(latestKey) : null;
              if (pending) {
                const { resolve, timer } = pending;
                clearTimeout(timer);
                this.pendingRequests.delete(latestKey);
                resolve({ topic: this.topic, cmd_id: latestKey, name: 'anonymous.array', data: message });
                return;
              }
            }
            this.emit('anonymous.array', message);
            return;
          }

          // 处理响应消息
          // 兼容：cmd_id 可能返回为字符串或数字
          const rawCmdId = message.cmd_id ?? message.id;
          const cmdId = (rawCmdId !== undefined && rawCmdId !== null) ? String(rawCmdId) : null;

          if (cmdId && this.pendingRequests.has(cmdId)) {
            const { resolve, reject, timer } = this.pendingRequests.get(cmdId);
            clearTimeout(timer);
            this.pendingRequests.delete(cmdId);

            // 兼容 socket.md：响应可能是 { topic, cmd_id, name, data: {...} } 或直接是数据
            // data 字段可能是字符串 JSON 或对象或数组
            let responseData = message;
            if (message.data !== undefined) {
              if (typeof message.data === 'string') {
                try {
                  const parsed = JSON.parse(message.data);
                  // 如果解析后是数组（如 get_signals），直接返回数组
                  responseData = parsed;
                } catch (e) {
                  responseData = message.data;
                }
              } else {
                // 如果 data 是数组（如 get_signals），直接返回数组
                responseData = message.data;
              }
            }

            // 兼容：success=false / ok=false / code!=0
            const ok = (responseData.success !== false) && (responseData.ok !== false) && (responseData.code === undefined || responseData.code === 0);
            if (!ok && responseData.success === false) {
              reject(new Error(responseData.error || responseData.msg || responseData.desc || '请求失败'));
            } else {
              resolve(responseData);
            }
            return;
          }

          // 处理推送/广播消息
          if (message && message.name) {
            // data 字段按 socket.md 文档：有时是字符串 JSON，有时直接是对象
            let processedData = message.data;
            if (typeof message.data === 'string' && (message.data.startsWith('{') || message.data.startsWith('['))) {
              try { processedData = JSON.parse(message.data); } catch (e) { }
            }
            // 特殊处理 refresh_signals 推送消息（第31条的定时响应）
            if (message.name === 'refresh_signals') {
              // refresh_signals 的 data 是数组格式
              this.emit('refresh_signals', processedData);
            } else {
              this.emit(message.name, processedData);
            }
          }
          if (message && message.type) {
            this.emit(message.type, message.data);
          }
        } catch (err) {
          console.error('[WS] 消息解析失败:', err, '原始数据:', data);
        }
      }

      /**
       * 发送请求并等待响应
       * @param {string} action - 操作类型
       * @param {object} params - 参数
       * @param {number} timeout - 可选，自定义超时时间（毫秒）
       * @returns {Promise<object>} - 响应数据
       */
      request(action, params = {}, timeout = null) {
        return new Promise((resolve, reject) => {
          if (!this.connected) {
            reject(new Error('WebSocket 未连接'));
            return;
          }

          // ===== 适配 Python WS 协议 =====
          // dict = { topic:'sim_loader', cmd_id:时间戳, name:方法名, data:接口入参 }
          // 方法名映射：允许 window.WS_METHOD_MAP 覆盖（action -> name）
          const cmd_id = Date.now() * 1000 + ((++this.messageId) % 1000);
          const cmdIdStr = String(cmd_id);
          const map = window.WS_METHOD_MAP || {};
          const name = map[action] || action;
          // data 字段按接口文档要求：默认是 JSON 字符串（例如 "{}" / "{\"device_id\":\"127.0.0.1\"}"）
          // 允许直接传 string 以完全控制 data
          const dataField = (typeof params === 'string') ? params : JSON.stringify(params || {});
          const message = { topic: this.topic, cmd_id, name, data: dataField };

          // 设置超时
          const currentTimeout = timeout || this.requestTimeout;
          const timer = setTimeout(() => {
            this.pendingRequests.delete(cmdIdStr);
            reject(new Error('请求超时'));
          }, currentTimeout);

          this.pendingRequests.set(cmdIdStr, { resolve, reject, timer });

          console.log('[WS] 发送请求:', name, params, 'cmd_id=', cmd_id, 'timeout=', currentTimeout);
          this.ws.send(JSON.stringify(message));
        });
      }

      /**
       * 发送消息（不等待响应）
       */
      send(action, params = {}) {
        if (!this.connected) {
          console.warn('[WS] 未连接，无法发送');
          return false;
        }
        const cmd_id = Date.now() * 1000 + ((++this.messageId) % 1000);
        const map = window.WS_METHOD_MAP || {};
        const name = map[action] || action;
        const dataField = (typeof params === 'string') ? params : JSON.stringify(params || {});
        this.ws.send(JSON.stringify({ topic: this.topic, cmd_id, name, data: dataField }));
        return true;
      }

      /**
       * 添加事件监听
       */
      on(event, callback) {
        if (!this.listeners.has(event)) {
          this.listeners.set(event, []);
        }
        this.listeners.get(event).push(callback);
      }

      /**
       * 移除事件监听
       */
      off(event, callback) {
        if (this.listeners.has(event)) {
          const list = this.listeners.get(event);
          const idx = list.indexOf(callback);
          if (idx !== -1) list.splice(idx, 1);
        }
      }

      /**
       * 触发事件
       */
      emit(event, data) {
        if (this.listeners.has(event)) {
          this.listeners.get(event).forEach(cb => cb(data));
        }
      }

      // ============================================================
      // API 方法封装
      // ============================================================

      // ============================================================
      // socket.md(1~13) 接口封装（统一 topic=LOADER，data 为 JSON 字符串）
      // ============================================================

      // --- loader 状态上报（每5s一次，服务端推送 name=get_connect_status）---
      startGetConnectStatus() {
        return this.request('start_get_connect_status', {});
      }

      // --- 停止所有定时器 ---
      stopAllTimers() {
        return this.request('stop_all_timers', {});
      }

      // --- loader 机柜位置信息 ---
      queryLocationInfo() {
        return this.request('query_location_info', {});
      }

      // --- 获取模型列表（树形下拉）---
      getModels(device_id, loader_num, sim_type = 'component_emulation') {
        return this.request('get_models', { device_id, loader_num, sim_type });
      }

      // --- 启动模型播放 ---
      startLoader(device_id, loader_num, model, sim_type = 'component_emulation') {
        // model: ["project1","Window_Left"]
        return this.request('start_loader', { device_id, loader_num, model, sim_type }, 10000);
      }

      // --- 停止模型播放 ---
      stopLoader(device_id, loader_num, model, sim_type = 'component_emulation') {
        // model: ["project1","Window"]
        return this.request('stop_loader', { device_id, loader_num, model, sim_type }, 10000);
      }

      // --- 6 批量获取寄存器值（get_signals）---
      getSignals(device_id, loader_num, regs) {
        // regs 可以是单个寄存器名称（字符串）或寄存器名称数组
        const regsArray = Array.isArray(regs) ? regs : (regs ? [regs] : []);
        return this.request('get_signals', { device_id, loader_num, regs: regsArray });
      }

      // --- 31 定时获取寄存器值（schedule_refresh_signals）---
      scheduleRefreshSignals(device_id, loader_num, regs, period) {
        // regs 必须是寄存器名称数组
        const regsArray = Array.isArray(regs) ? regs : (regs ? [regs] : []);
        return this.request('schedule_refresh_signals', { device_id, loader_num, regs: regsArray, period });
      }

      // --- 32 停止定时获取寄存器值（stop_refresh_regs）---
      stopRefreshRegs() {
        return this.request('stop_refresh_regs', {});
      }

      // --- 8 设置寄存器值（set_signals）---
      setSignals(device_id, loader_num, signals) {
        return this.request('set_signals', { device_id, loader_num, signals });
      }

      // --- 9 获取 loader 中文件信息（get_file_info）---
      getFileInfo(device_id, loader_num, name = '') {
        return this.request('get_file_info', { device_id, loader_num, name });
      }

      // --- 10 读取 resource/loader 目录结构（obtain_loader_dir_structure）---
      obtainLoaderDirStructure(path = 'loader') {
        return this.request('obtain_loader_dir_structure', { path });
      }

      // --- 11 导入模型文件（load_model）---
      loadModel(device_id, loader_num, modelzip, project, all_devices = false) {
        if (all_devices) {
          return this.request('load_model', { modelzip, project, all_devices: true });
        } else {
          return this.request('load_model', { device_id, loader_num, modelzip, project, all_devices: false });
        }
      }

      // --- 12 从云端导入模型（download_cloud_models）---
      downloadCloudModels(device_id, loader_num, model_name, model_id, project) {
        return this.request('download_cloud_models', { device_id, loader_num, model_name, model_id, project });
      }

      // --- 13 控制台命令交互（send_cmd）---
      sendCmd(device_id, loader_num, cmd, multi_frames = false) {
        return this.request('send_cmd', { device_id, loader_num, cmd, multi_frames });
      }

      // --- 14 检查云端新版本（check_loaders_new_version）---
      checkLoadersNewVersion() {
        return this.request('check_loaders_new_version', {});
      }

      // --- 15 单设备云端 OTA（update_one_loader）---
      updateOneLoader(device_id, loader_num) {
        return this.request('update_one_loader', { device_id, loader_num }, 300000);
      }

      // --- 17 设置单个寄存器值（set_reg_value）---
      setRegValue(device_id, loader_num, reg_name, reg_value) {
        return this.request('set_reg_value', { device_id, loader_num, reg_name, reg_value: String(reg_value) });
      }

      // --- 18 单个寄存器刷新（wait_reg_value）---
      waitRegValue(device_id, loader_num, reg_name) {
        return this.request('wait_reg_value', { device_id, loader_num, reg_name });
      }

      // --- 19 保存实验室机柜位置信息（save_location_info） ---
      saveLocationInfo(location) {
        return this.request('save_location_info', { location });
      }

      // --- 20 获取服务器本地资源文件夹文件列表（get_local_file_list） ---
      getLocalFileList() {
        return this.request('get_local_file_list', {});
      }

      // --- 21 从服务器本地读取文件内容（read_local_file） ---
      readLocalFile(path) {
        return this.request('read_local_file', { path });
      }

      // --- 22 保存文件到服务器本地（save_local_file） ---
      saveLocalFile(path, bin_json) {
        return this.request('save_local_file', { path, bin_json });
      }

      // --- 23 另存为文件到服务器本地（save_as_local_file） ---
      saveAsLocalFile(path, bin_json) {
        return this.request('save_as_local_file', { path, bin_json });
      }

      // --- 24 上传文件到云端（upload_to_cloud） ---
      uploadToCloud(path) {
        return this.request('upload_to_cloud', { path });
      }

      // --- 25 从设备获取文件到服务器本地（download_from_device） ---
      downloadFromDevice(device_id, loader_num, path) {
        return this.request('download_from_device', { device_id, loader_num, path });
      }

      // --- 26 应用参数到设备（apply_params_to_device） ---
      applyParamsToDevice(device_id, loader_num, module_info) {
        return this.request('apply_params_to_device', { device_id, loader_num, module_info });
      }

      // --- 27 停止所有定时器（stop_all_timers） ---
      stopAllTimers() {
        return this.request('stop_all_timers', {});
      }

      // --- 28 删除服务器本地文件（delete_local_file） ---
      deleteLocalFile(path) {
        return this.request('delete_local_file', { path });
      }

      // --- 删除设备文件（del_file） ---
      delFile(device_id, loader_num, path) {
        return this.request('del_file', { device_id, loader_num, path });
      }

      // --- 29 OTA近端升级（loader_ota） ---
      loaderOta(device_id, loader_num, path) {
        return this.request('loader_ota', { device_id, loader_num, path }, 300000);
      }

      // --- 30 文件拉取（pull_loader_log） ---
      pullLoaderLog(device_id, loader_num, path) {
        return this.request('pull_loader_log', { device_id, loader_num, path });
      }

      // --- 文件操作（非 socket.md 标准，供 Python FastAPI 后端使用） ---
      saveFile(device_sn, filename, content) {
        return this.request('file.save', { device_sn, filename, content });
      }
      saveFileAs(device_sn, filename, content) {
        return this.request('file.saveAs', { device_sn, filename, content });
      }
      readFile(device_sn, filename) {
        return this.request('file.read', { device_sn, filename });
      }
      deleteFile(device_sn, filename) {
        return this.request('file.delete', { device_sn, filename });
      }
      listFiles(device_sn) {
        return this.request('file.list', { device_sn });
      }
    }

    // 创建全局 WebSocket 客户端实例
    const wsClient = new WSClient();

    // bin 解析：按 socket.md 风格走 WS（name=bin_parse），传入文件相对路径
    async function parseBinByServer(filePath) {
      // WS 优先，HTTP 兜底
      if (wsClient && wsClient.connected) {
        // 使用接口 21：read_local_file
        const msg = await wsClient.readLocalFile(filePath);
        const payload = msg && msg.data !== undefined ? msg.data : msg;

        let result = (payload.ret === true && payload.data) ? payload.data : payload;

        if (result && result.success !== false) {
          return {
            success: true,
            filename: result.filename || filePath.split('/').pop(),
            modules: result.modules || [],
            raw: result.content || '',
            path: filePath,
            errors: result.errors || [],
            warnings: result.warnings || []
          };
        }
        return { success: false, error: result.desc || result.msg || '解析失败' };
      }

      try {
        const resp = await fetch('/api/bin/parse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: filePath })
        });
        return await resp.json();
      } catch (err) {
        return { success: false, error: err.message };
      }
    }

    // 示例文件
    const sampleFiles = {
      'example.bin': `#这是一个模型文件
#后车窗
WINDOW_R
up_limit:2200
down_limit:0
vout_gain:1.5
current_output_gain:0.5
stuck_mode:2000
matrix1:3 4 5

#尾门锁
TAIL_GATE_LOCK
signal_tailgate_1:1
signal_tailgate_2:1
vout_gain:1.2
current_output_gain:0.3
example_factor:
    0 0 0
    1 2.3 4.51
    2 3.4 6.66`,

      'motor_control.bin': `#电机控制模型
MOTOR_CTRL
max_speed:3000
min_speed:0
acceleration:100
deceleration:150
pid_kp:1.5
pid_ki:0.2
pid_kd:0.05

BRAKE_CTRL
brake_force:80
release_delay:50`,

      'test_out_of_range.bin': `#范围测试
WINDOW_R
up_limit:99999
vout_gain:15.5
current_output_gain:0.5`
    };

    new Vue({
      el: '#app',
      data: {
        wsConnected: false,        // WebSocket连接状态
        // 默认按“未连接/未运行”显示，等收到 get_connect_status 或读到寄存器再更新
        deviceConnected: false,
        deviceSN: '',
        // 对接 start_loader/stop_loader/get_models 的入参（先按文档默认值）
        device_id: '127.0.0.1',
        loader_num: 0,

        // 左侧栏：实验室/机箱/设备状态
        locationList: [],
        selectedLocation: '',
        isLocationRegistered: false,
        connectStatus: null, // get_connect_status 推送原始 data
        selectedDeviceKey: '', // `${ip}#${loader_num}`
        lastConnectStatusTime: 0, // 最后收到 get_connect_status 的时间戳
        connectStatusCheckTimer: null, // get_connect_status 检查定时器
        hasRequestedConnectStatus: false, // 是否已经请求过一次（避免不停请求）

        // 设备信号缓存（用于把 MFILE 等寄存器值反映到左侧设备单体显示）
        deviceSignalCache: {}, // key -> { MFILE, ... }

        // OTA（socket.md 14/15）
        otaLoading: false,
        otaGroups: [],
        otaProgress: {}, // key: `${ip}#${loader_num}` -> number(0-100)
        otaStatus: {},   // key -> { status, desc }
        otaUpdatingKey: '',
        otaCloudStatus: 'never', // never | ok | empty | error
        otaCloudMsg: '',
        otaCloudCheckedAt: '',

        // 工具弹窗状态
        dialogModelVisible: false,
        dialogUpgradeVisible: false,
        dialogLogVisible: false,
        dialogFetchVisible: false,
        dialogLocalUpgradeVisible: false,
        drawerConsoleVisible: false,

        // 近端升级（hex 文件）
        localUpgradeTarget: { ip: '', loader_num: 0, loader_name: '' },
        selectedHexFile: null,
        selectedHexName: '',
        selectedHexPath: '', // 文件的完整路径（服务器路径）
        hexFileList: [],
        localUpgradeLoading: false, // 近端升级加载状态
        localUpgradeTab: 'file', // 近端升级标签页：'file' 或 'path'
        localUpgradePath: '', // 手动输入的文件路径

        // 控制台（保留历史）
        consoleInput: '',
        consoleHistory: [],

        // 设备文件树（模型/日志）
        modelTreeLoading: false,
        modelTreeData: [],
        logTreeLoading: false,
        logTreeData: [],
        fetchTreeLoading: false,
        fetchTreeData: [],
        selectedLogPath: '', // 选中的日志文件路径
        selectedResourcePath: '', // 选中的资源文件路径（用于导入设备）
        resourceTreeLoading: false, // 资源树加载状态
        resourceTreeKey: 0, // 用于强制刷新资源树的 key

        // 设备规格配置（从 device_specs.json 加载）
        deviceSpecsConfig: null,
        // 可选：从寄存器 NAME 读取到的设备名（没读到就用默认）
        deviceNameFromRegister: '',

        // 顶部横栏：模型树下拉
        modelOptionsLoading: false,
        modelOptions: [],
        selectedModelPath: [],
        runMode: 'model', // model | regen (回灌)
        activeTool: 'model',
        activePage: 'info',
        activeModelIndex: 0,
        hasModified: false,
        showRaw: false,
        expandedModules: {},
        models: [],
        isModelRunning: false,
        runningFile: '',
        runningModule: '',
        // 设备信息（从接口获取）
        deviceInfo: {
          sn: '',
          hardwareVersion: '',
          softwareVersion: '',
          runTime: ''
        },
        // 实时数据（从接口获取）
        realtimeData: {
          current: 0,
          voltage: 0,
          power: 0,
          temperature: 0
        },
        // 寄存器相关
        registerSearch: '',
        registerFilter: 'all',
        registerTypeFilter: 'all',
        registerLoading: false,
        registers: [],
        registerDefsAll: [],

        // 寄存器分Sheet管理
        activeSheetId: 'root',
        registerSheets: [
          { id: 'root', name: '全量寄存器', registerNames: [], timerEnabled: false, timerInterval: 5000, timerId: null }
        ],
        dialogAddSheetVisible: false,
        newSheetName: '',
        dragOverRowIndex: null,
        dragOverTabIndex: null,
        dragOverModelIndex: null,
        draggedRegName: '',

        // 右键菜单
        contextMenuVisible: false,
        contextMenuPos: { x: 0, y: 0 },
        contextMenuReg: null,

        // 参数编辑变量字典（参数/模块定义）
        modelDictionary: { parameters: {}, modules: {} },

        // 新增文件/模块弹窗
        dialogNewModelVisible: false,
        newModelFilename: '',
        dialogAddModuleVisible: false,
        selectedModuleType: '',
        // 添加参数弹窗
        dialogAddParamVisible: false,
        selectedParamName: '',
        selectedModuleIndexForParam: -1, // 当前要添加参数的模块索引
        // 导入设备弹窗
        dialogImportDeviceVisible: false,
        importDeviceType: 'current' // 'current' | 'all'
      },
      watch: {
        // 监听页签切换，停止定时刷新
        async activeSheetId(newId, oldId) {
          if (oldId && oldId !== newId && this.wsConnected) {
            // 切换页签时，停止之前的定时刷新
            try {
              await wsClient.stopRefreshRegs();
              console.log('[Sheet] 切换页签，已停止定时刷新寄存器');
            } catch (err) {
              console.error('[Sheet] 停止定时刷新失败:', err);
            }

            // 清除旧页签的定时器标记
            const oldSheet = this.registerSheets.find(s => s.id === oldId);
            if (oldSheet && oldSheet.timerEnabled) {
              oldSheet.timerId = null;
              oldSheet.timerEnabled = false;
            }
          }
        }
      },
      computed: {
        currentSheet() {
          return this.registerSheets.find(s => s.id === this.activeSheetId) || this.registerSheets[0];
        },
        filteredRegisters() {
          const sheet = this.currentSheet;
          let list = [];
          if (sheet.id === 'root') {
            list = this.registers;
          } else {
            // 按照 sheet.registerNames 中定义的顺序排列对象
            const names = sheet.registerNames || [];
            list = names.map(name => this.registers.find(r => r.name === name)).filter(Boolean);
          }

          return list.filter(reg => {
            // 搜索过滤
            if (this.registerSearch) {
              const search = this.registerSearch.toLowerCase();
              const nameMatch = reg.name.toLowerCase().includes(search);
              const descMatch = reg.description.toLowerCase().includes(search);
              if (!nameMatch && !descMatch) return false;
            }
            // 权限过滤
            if (this.registerFilter !== 'all' && reg.access !== this.registerFilter) return false;
            // 类型过滤
            if (this.registerTypeFilter !== 'all' && reg.type !== this.registerTypeFilter) return false;
            return true;
          });
        },
        currentDeviceEntry() {
          // 从 connectStatus 中找到当前 device_id + loader_num 对应的设备
          // 新格式: { lab: [ { ip, port, value: [device,...] }, ... ] }
          // 旧格式: { lab: [ device, ... ] }
          const raw = this.connectStatus && typeof this.connectStatus === 'object' ? this.connectStatus : {};
          for (const items of Object.values(raw)) {
            if (!Array.isArray(items)) continue;
            for (const item of items) {
              if (!item) continue;
              // 判断是新格式的 cabinet 对象还是旧格式的 device 对象
              if (Array.isArray(item.value)) {
                // 新格式：递归寻找
                for (const d of item.value) {
                  if (d && String(d.ip) === String(this.device_id) && Number(d.loader_num) === Number(this.loader_num)) {
                    return d;
                  }
                }
              } else {
                // 旧格式
                if (String(item.ip) === String(this.device_id) && Number(item.loader_num) === Number(this.loader_num)) {
                  return item;
                }
              }
            }
          }
          return null;
        },
        currentDeviceName() {
          // 设备名优先：connect_status.name -> 寄存器 NAME -> 默认值
          const entry = this.currentDeviceEntry;
          const n1 = entry && entry.name ? String(entry.name).trim() : '';
          if (n1) return n1;
          const n2 = (this.deviceNameFromRegister || '').trim();
          if (n2) return n2;
          return 'X-Loader';
        },
        currentHardwareVersion() {
          // 硬件版本优先：connect_status.hversion -> deviceInfo.hardwareVersion -> default
          const entry = this.currentDeviceEntry;
          const v1 = entry && entry.hversion ? String(entry.hversion).trim() : '';
          if (v1) return v1;
          const v2 = this.deviceInfo && this.deviceInfo.hardwareVersion ? String(this.deviceInfo.hardwareVersion).trim() : '';
          if (v2) return v2;
          return 'default';
        },
        currentSpecs() {
          // 根据 设备名 + 硬件版本 从 deviceSpecsConfig 中选规格；否则走 default/default
          const cfg = this.deviceSpecsConfig || {};
          const nameMap = cfg[this.currentDeviceName] || cfg['default'] || {};
          const spec = nameMap[this.currentHardwareVersion] || nameMap['default'] || (cfg.default && cfg.default.default) || {
            max_current_a: 100,
            max_voltage_v: 600,
            max_power_w: 50000,
            sample_rate_khz: 100
          };
          return spec;
        },
        currentModel() { return this.models[this.activeModelIndex] || null; },
        canApply() {
          return this.deviceConnected && this.isModelRunning &&
            this.currentModel && this.currentModel.success &&
            this.isFileRunning(this.currentModel.filename);
        },
        canStartSelected() {
          return Array.isArray(this.selectedModelPath) && this.selectedModelPath.length >= 2;
        },
        canStopSelected() {
          // 只要模型正在运行就可以停止，不需要选择模型路径
          return this.deviceConnected && this.isModelRunning;
        },
        hasConnectStatus() {
          return this.connectStatus && typeof this.connectStatus === 'object' && Object.keys(this.connectStatus).length > 0;
        },
        availableModules() {
          if (!this.modelDictionary || !this.modelDictionary.modules) return [];
          return Object.entries(this.modelDictionary.modules).map(([id, def]) => ({
            id,
            name: def.name || id
          }));
        },
        availableParamsForModule() {
          // 获取当前模块允许的参数列表
          if (this.selectedModuleIndexForParam < 0 || !this.currentModel || !this.currentModel.modules) return [];

          const module = this.currentModel.modules[this.selectedModuleIndexForParam];
          if (!module || !this.modelDictionary || !this.modelDictionary.modules) return [];

          const modDef = this.modelDictionary.modules[module.name];
          if (!modDef) return [];

          // 获取模块允许的参数ID列表
          const allowedIds = modDef.allowed_param_ids || [];

          // 获取已存在的参数名称
          const existingParamNames = new Set(module.params.map(p => p.name));

          // 从参数字典中筛选出允许的参数
          const params = [];
          if (this.modelDictionary.parameters) {
            Object.entries(this.modelDictionary.parameters).forEach(([name, def]) => {
              // 检查参数ID是否在允许列表中
              if (def.id && allowedIds.includes(def.id)) {
                // 检查参数是否已存在
                if (!existingParamNames.has(name)) {
                  params.push({
                    name,
                    id: def.id,
                    displayName: `${def.name || name} (${name})`
                  });
                }
              }
            });
          }

          // 按ID排序
          params.sort((a, b) => a.id - b.id);

          return params;
        },
        currentSimType() {
          return this.runMode === 'regen' ? 'data_replay' : 'component_emulation';
        },
        otaCloudMap() {
          // 从 check_loaders_new_version 的结果构建：key -> { target_version, current_version, sn, loader_name, progress }
          const map = {};
          for (const grp of (this.otaGroups || [])) {
            const ip = grp && grp.ip ? String(grp.ip) : '';
            for (const d of (grp.devices || [])) {
              const k = this.otaKey(ip, d.loader_num);
              map[k] = {
                target_version: d.target_version || '',
                current_version: d.current_version || '',
                sn: d.sn || '',
                loader_name: d.loader_name || '',
                progress: d.progress
              };
            }
          }
          return map;
        },
        otaCloudStatusText() {
          if (this.otaCloudStatus === 'never') return '云端版本：未获取';
          if (this.otaCloudStatus === 'ok') return `云端版本：已获取（${this.otaCloudCheckedAt || ''}）`;
          if (this.otaCloudStatus === 'empty') return `云端版本：无新版本（${this.otaCloudCheckedAt || ''}）`;
          if (this.otaCloudStatus === 'error') return `云端版本：获取失败（${this.otaCloudMsg || ''}）`;
          return '云端版本：未知';
        },
        upgradeRows() {
          // 展示 upgrade 弹窗的数据：以 get_connect_status 为主，云端版本来自 otaCloudMap（没获取就为空）
          const rows = [];
          const raw = this.connectStatus && typeof this.connectStatus === 'object' ? this.connectStatus : {};

          const processDevice = (d) => {
            if (!d || d.ip === undefined || d.loader_num === undefined) return;
            const ip = String(d.ip);
            const loader_num = Number(d.loader_num);
            const k = this.otaKey(ip, loader_num);
            const cloud = this.otaCloudMap[k] || {};
            rows.push({
              ip,
              loader_num,
              loader_name: d.loader_name || cloud.loader_name || `loader-${loader_num}`,
              sn: d.sn || cloud.sn || '',
              running_text: (this.toBool(d.running) ? '运行中' : '未运行'),
              current_version: d.version || cloud.current_version || '',
              target_version: cloud.target_version || ''
            });
          };

          for (const items of Object.values(raw)) {
            if (!Array.isArray(items)) continue;
            for (const item of items) {
              if (!item) continue;
              if (Array.isArray(item.value)) {
                item.value.forEach(processDevice);
              } else {
                processDevice(item);
              }
            }
          }
          // 排序：IP -> loader_num
          rows.sort((a, b) => (a.ip === b.ip ? a.loader_num - b.loader_num : a.ip.localeCompare(b.ip)));
          return rows;
        },
        labView() {
          // connectStatus 新格式: { "lab-1": [ { ip, port, value: [device,...] }, ... ] }
          // connectStatus 旧格式: { "lab-1": [ device, ... ] }
          const raw = this.connectStatus && typeof this.connectStatus === 'object' ? this.connectStatus : {};
          const labs = [];
          for (const [labKey, items] of Object.entries(raw)) {
            const list = Array.isArray(items) ? items : [];
            const cabinets = [];

            // 处理每一个机箱/主机节点
            for (const item of list) {
              if (!item) continue;

              let ip = 'unknown';
              let devicesRaw = [];

              if (Array.isArray(item.value)) {
                // 新格式
                ip = item.ip || 'unknown';
                devicesRaw = item.value;
              } else {
                // 旧格式（为了兼容，我们将相同 IP 的归到一个机箱）
                ip = item.ip || 'unknown';
                // 这里需要一点特殊处理：如果已经有这个 IP 的机箱了，就往里加，否则新建
                let cab = cabinets.find(c => c.ip === ip);
                if (!cab) {
                  cab = { ip, devices: this.createEmptySlots(ip) };
                  cabinets.push(cab);
                }
                this.fillSlot(cab.devices, item, ip);
                continue;
              }

              // 新格式的处理
              const slots = this.createEmptySlots(ip);
              for (const d of devicesRaw) {
                this.fillSlot(slots, d, ip);
              }
              cabinets.push({ ip, devices: slots });
            }
            labs.push({ labKey, cabinets });
          }
          return labs;
        }
      },
      methods: {
        // 辅助：创建 6 个空槽位（供 labView 使用）
        createEmptySlots(ip) {
          return new Array(6).fill(null).map((_, idx) => ({
            ip,
            loader_num: idx,
            connect: false,
            running: false,
            interrupt: false,
            high_temp_alarm: false,
            busy: false,
            running_model: ''
          }));
        },
        // 辅助：填充槽位数据（供 labView 使用）
        fillSlot(slots, d, ip) {
          const n = Number(d.loader_num);
          if (Number.isFinite(n) && n >= 0 && n < 6) {
            const cacheKey = `${String(ip)}#${n}`;
            const cached = this.deviceSignalCache && this.deviceSignalCache[cacheKey] ? this.deviceSignalCache[cacheKey] : null;
            slots[n] = {
              ...slots[n],
              ...d,
              loader_num: n,
              connect: this.toBool(d.connect),
              running: this.toBool(d.running),
              interrupt: this.toBool(d.interrupt),
              high_temp_alarm: this.toBool(d.high_temp_alarm),
              busy: this.toBool(d.busy),
              // 优先级：寄存器缓存 MFILE > 推送的 loader_name > 推送的 running_model > 推送的 name
              running_model: (cached && cached.MFILE) ? cached.MFILE : (d.loader_name || d.running_model || d.name || '')
            };
          }
        },
        // 辅助：SN 格式化为 4 段 16 进制（如 3f-2d-4a-73）
        formatSN(val) {
          if (!val) return '--';
          let num = Number(val);
          if (isNaN(num)) return String(val); // 如果不是数字，原样返回
          // 转为 16 进制，补齐 8 位（4字节）
          let hex = num.toString(16).padStart(8, '0').toLowerCase();
          // 每 2 位一组加连字符
          const segments = [];
          for (let i = 0; i < hex.length; i += 2) {
            segments.push(hex.substring(i, i + 2));
          }
          return segments.join('-');
        },
        // 将 get_signals 的响应统一解析为 name->value map
        signalsToMap(resp) {
          const payload = (resp && resp.data !== undefined) ? resp.data : resp;
          const list = Array.isArray(payload) ? payload : (payload && Array.isArray(payload.data) ? payload.data : []);
          const map = new Map();
          for (const it of list) {
            if (!it || it.name === undefined) continue;
            map.set(String(it.name), it.value);
          }
          // 兼容单寄存器返回：{name,value}
          if (!list.length && payload && payload.name !== undefined && payload.value !== undefined) {
            map.set(String(payload.name), payload.value);
          }
          if (!list.length && payload && payload.data && payload.data.name !== undefined && payload.data.value !== undefined) {
            map.set(String(payload.data.name), payload.data.value);
          }
          return map;
        },

        // --- Sheet 管理 ---
        loadRegisterSheets() {
          try {
            const saved = localStorage.getItem('xloader_register_sheets');
            if (saved) {
              const sheets = JSON.parse(saved);
              // 确保 root sheet 始终存在且格式正确
              if (!sheets.find(s => s.id === 'root')) {
                sheets.unshift({ id: 'root', name: '全量寄存器', registerNames: [], timerEnabled: false, timerInterval: 5000, timerId: null });
              }
              // 清理上次残留的 timerId
              sheets.forEach(s => s.timerId = null);
              this.registerSheets = sheets;
            }
          } catch (e) {
            console.error('[Sheet] Load failed:', e);
          }
        },
        saveRegisterSheets() {
          try {
            const toSave = this.registerSheets.map(s => ({
              id: s.id,
              name: s.name,
              registerNames: s.registerNames,
              timerEnabled: s.timerEnabled,
              timerInterval: s.timerInterval
            }));
            localStorage.setItem('xloader_register_sheets', JSON.stringify(toSave));
          } catch (e) {
            console.error('[Sheet] Save failed:', e);
          }
        },
        handleSheetAdd() {
          if (this.registerSheets.length >= 5) {
            this.$message.warning('最多只能创建 5 个页签（包括全量寄存器），请删除不需要的页签后再试。');
            return;
          }
          this.newSheetName = '';
          this.dialogAddSheetVisible = true;
        },
        handleSheetRemove(targetName) {
          if (targetName === 'root') return;
          this.$confirm('确定删除该页签吗？其内的寄存器分组信息将丢失。', '提示', { type: 'warning' }).then(() => {
            const idx = this.registerSheets.findIndex(s => s.id === targetName);
            if (idx !== -1) {
              const sheet = this.registerSheets[idx];
              if (sheet.timerId) clearInterval(sheet.timerId);
              this.registerSheets.splice(idx, 1);
              if (this.activeSheetId === targetName) this.activeSheetId = 'root';
              this.saveRegisterSheets();
            }
          }).catch(() => {
            // 取消删除，不执行任何操作，也不报错
          });
        },
        confirmAddSheet() {
          const name = this.newSheetName.trim();
          if (!name) return;
          const id = 'sheet_' + Date.now();
          this.registerSheets.push({
            id,
            name,
            registerNames: [],
            timerEnabled: false,
            timerInterval: 5000,
            timerId: null
          });
          this.activeSheetId = id;
          this.dialogAddSheetVisible = false;
          this.saveRegisterSheets();
        },
        renameSheet(sheet) {
          if (sheet.id === 'root') return;
          this.$prompt('请输入新的 Sheet 名称', '改名', {
            inputValue: sheet.name,
            inputPattern: /\S+/,
            inputErrorMessage: '名称不能为空'
          }).then(({ value }) => {
            sheet.name = value;
            this.saveRegisterSheets();
          });
        },
        async toggleSheetTimer(sheet) {
          // 注意：el-switch 的 @change 事件会在 v-model 更新后触发
          // 所以这里 sheet.timerEnabled 已经是新值了
          const shouldEnable = sheet.timerEnabled;

          if (!shouldEnable) {
            // 关闭当前定时刷新
            sheet.timerId = null;
            // 调用停止接口
            if (this.wsConnected) {
              try {
                await wsClient.stopRefreshRegs();
                console.log('[Sheet] 定时刷新已停止:', sheet.name);
              } catch (err) {
                console.error('[Sheet] 停止定时刷新失败:', err);
                // 如果停止失败，恢复开关状态
                this.$set(sheet, 'timerEnabled', true);
                return;
              }
            }
            // 确保状态已更新
            this.$set(sheet, 'timerEnabled', false);
          } else {
            // 开启当前前，先关闭其他所有 Sheet 的定时器（同一时间只允许一个）
            for (const s of this.registerSheets) {
              if (s.id !== sheet.id && s.timerEnabled) {
                s.timerId = null;
                this.$set(s, 'timerEnabled', false);
                // 调用停止接口
                if (this.wsConnected) {
                  try {
                    await wsClient.stopRefreshRegs();
                    console.log('[Sheet] 已停止其他页签的定时刷新:', s.name);
                  } catch (err) {
                    console.error('[Sheet] 停止定时刷新失败:', err);
                  }
                }
              }
            }

            // 启动新的定时刷新
            this.$set(sheet, 'timerEnabled', true);
            this.startSheetTimer(sheet);
          }
          this.saveRegisterSheets();
        },
        startSheetTimer(sheet) {
          // 先清除之前的定时器
          if (sheet.timerId) {
            clearInterval(sheet.timerId);
            sheet.timerId = null;
          }

          // 如果 WebSocket 未连接或设备未连接，不启动定时器
          if (!this.wsConnected || !this.deviceConnected) {
            return;
          }

          const names = sheet.id === 'root' ? this.registers.map(r => r.name) : sheet.registerNames;
          if (!names.length) {
            return;
          }

          const period = sheet.timerInterval || 5000;

          try {
            // 使用第31条接口启动定时刷新
            wsClient.scheduleRefreshSignals(this.device_id, this.loader_num, names, period).then(() => {
              console.log(`[Sheet] 定时刷新已启动: ${sheet.name}, 周期: ${period}ms`);
            }).catch(err => {
              console.error(`[Sheet] 启动定时刷新失败:`, err);
            });
          } catch (err) {
            console.error(`[Sheet] 启动定时刷新异常:`, err);
          }
        },
        async refreshSheetRegisters(sheet) {
          if (!this.deviceConnected) return;
          const names = sheet.id === 'root' ? this.registers.map(r => r.name) : sheet.registerNames;
          if (!names.length) return;

          try {
            // 使用第6条接口批量获取寄存器值（单次刷新）
            const resp = await wsClient.getSignals(this.device_id, this.loader_num, names);
            const m = this.signalsToMap(resp);

            // 更新寄存器值
            this.registers.forEach(reg => {
              if (names.includes(reg.name) && m.has(reg.name)) {
                reg.value = m.get(reg.name);
                reg.readError = false;
              }
            });
          } catch (e) {
            console.warn('[Sheet] Auto-refresh failed:', e);
          }
        },
        // --- 拖拽 / 移动寄存器与页签 ---
        handleDragStart(event, reg, index) {
          event.dataTransfer.setData('type', 'register');
          event.dataTransfer.setData('regName', reg.name);
          event.dataTransfer.setData('fromSheetId', this.activeSheetId);
          event.dataTransfer.setData('fromIndex', index);
          this.draggedRegName = reg.name;
        },
        handleTabDragStart(event, index) {
          if (this.registerSheets[index].id === 'root') return;
          event.dataTransfer.setData('type', 'tab');
          event.dataTransfer.setData('fromTabIndex', index);
        },
        handleModelDragStart(event, index) {
          event.dataTransfer.setData('type', 'model');
          event.dataTransfer.setData('fromModelIndex', index);
          // 视觉反馈
          event.target.style.opacity = '0.5';
          event.target.addEventListener('dragend', () => {
            event.target.style.opacity = '1';
          }, { once: true });
        },
        handleModelDragOver(event, index) {
          this.dragOverModelIndex = index;
        },
        handleModelDragLeave(event) {
          this.dragOverModelIndex = null;
        },
        handleModelDrop(event, targetIndex) {
          this.dragOverModelIndex = null;
          const type = event.dataTransfer.getData('type');
          if (type !== 'model') return;

          const fromIndex = parseInt(event.dataTransfer.getData('fromModelIndex'));
          if (isNaN(fromIndex) || fromIndex === targetIndex) return;

          // 记录当前选中的模型对象，以便在排序后恢复正确的激活索引
          const activeModel = this.models[this.activeModelIndex];

          // 重新排序 models 数组
          const models = [...this.models];
          const [movedModel] = models.splice(fromIndex, 1);
          models.splice(targetIndex, 0, movedModel);
          this.models = models;

          // 恢复激活索引
          if (activeModel) {
            this.activeModelIndex = this.models.indexOf(activeModel);
          }
        },
        handleDragOverRow(event, index) {
          if (this.activeSheetId === 'root') return;
          this.dragOverRowIndex = index;
        },
        handleTabDragOver(event, index) {
          this.dragOverTabIndex = index;
        },
        handleTabDragLeave(event) {
          this.dragOverTabIndex = null;
        },
        handleDropOnRow(event, targetIndex) {
          this.dragOverRowIndex = null;
          const type = event.dataTransfer.getData('type');
          if (type !== 'register') return;

          const fromSheetId = event.dataTransfer.getData('fromSheetId');
          const regName = event.dataTransfer.getData('regName');

          if (this.activeSheetId === 'root' || fromSheetId !== this.activeSheetId) return;

          // 同一 Sheet 内排序：需映射回原始 registerNames 的索引
          const sheet = this.currentSheet;
          const names = [...sheet.registerNames];

          const targetReg = this.filteredRegisters[targetIndex];
          if (!targetReg) return;

          const realFromIndex = names.indexOf(regName);
          const realTargetIndex = names.indexOf(targetReg.name);

          if (realFromIndex !== -1 && realTargetIndex !== -1) {
            const [movedName] = names.splice(realFromIndex, 1);
            names.splice(realTargetIndex, 0, movedName);
            sheet.registerNames = names;
            this.saveRegisterSheets();
          }
        },
        handleDropOnTab(event, targetIndex) {
          this.dragOverTabIndex = null;
          const type = event.dataTransfer.getData('type');
          const targetSheet = this.registerSheets[targetIndex];
          if (!targetSheet) return;

          if (type === 'tab') {
            // 页签排序
            const fromIndex = parseInt(event.dataTransfer.getData('fromTabIndex'));
            if (isNaN(fromIndex) || fromIndex === targetIndex || targetSheet.id === 'root') return;

            const sheets = [...this.registerSheets];
            const [moved] = sheets.splice(fromIndex, 1);
            sheets.splice(targetIndex, 0, moved);
            this.registerSheets = sheets;
            this.saveRegisterSheets();
          } else if (type === 'register') {
            // 寄存器复制到页签
            const regName = event.dataTransfer.getData('regName');
            const fromSheetId = event.dataTransfer.getData('fromSheetId');
            if (!regName || fromSheetId === targetSheet.id) return;

            if (!targetSheet.registerNames.includes(regName)) {
              targetSheet.registerNames.push(regName);
              this.saveRegisterSheets();
              this.$message.success(`已复制到页签: ${targetSheet.name}`);
            }
          }
        },

        // --- 右键菜单 ---
        showContextMenu(event, reg) {
          this.contextMenuReg = reg;
          this.contextMenuPos = { x: event.clientX, y: event.clientY };
          this.contextMenuVisible = true;

          const hideMenu = () => {
            this.contextMenuVisible = false;
            document.removeEventListener('click', hideMenu);
          };
          document.addEventListener('click', hideMenu);
        },
        addRegToSheet(reg, sheetId) {
          const sheet = this.registerSheets.find(s => s.id === sheetId);
          if (sheet && reg) {
            if (!sheet.registerNames.includes(reg.name)) {
              sheet.registerNames.push(reg.name);
              this.saveRegisterSheets();
              this.$message.success(`已添加到页签: ${sheet.name}`);
            } else {
              this.$message.warning('该寄存器已存在于目标页签');
            }
          }
          this.contextMenuVisible = false;
        },
        removeRegFromCurrentSheet(reg) {
          if (this.activeSheetId === 'root' || !reg) return;
          const sheet = this.currentSheet;
          sheet.registerNames = sheet.registerNames.filter(n => n !== reg.name);
          this.saveRegisterSheets();
          this.$message.success('已从当前页签删除');
          this.contextMenuVisible = false;
        },

        async refreshDeviceInfoFromSignals() {
          if (!this.wsConnected) return;
          try {
            // 未连接时不读取/不展示运行中
            if (!this.deviceConnected) {
              this.isModelRunning = false;
              this.runningFile = '';
              return;
            }

            // 只获取必须的几个寄存器，而不是全量获取
            const essentialRegs = ['NAME', 'VERSION', 'HVERSION', 'SN', 'MFILE'];
            let m = new Map();
            try {
              const resp = await wsClient.getSignals(this.device_id, this.loader_num, essentialRegs);
              m = this.signalsToMap(resp);
            } catch (err) {
              console.warn('[DeviceInfo] Failed to get essential registers:', err);
            }

            // 新增寄存器：VERSION/HVERSION/NAME/SN/MFILE 等（show:false）也在这里读出来用于设备信息展示
            const name = m.get('NAME');
            const version = m.get('VERSION');
            const hversion = m.get('HVERSION');
            const sn = m.get('SN');
            const mfile = m.get('MFILE');

            if (name !== undefined && name !== null && String(name).trim()) {
              this.deviceNameFromRegister = String(name);
            }
            if (sn !== undefined && sn !== null && String(sn).trim()) {
              const formatted = this.formatSN(sn);
              this.deviceInfo.sn = formatted;
              this.deviceSN = String(sn); // 原始 SN 用于逻辑，formatted 用于展示
            }
            if (hversion !== undefined && hversion !== null && String(hversion).trim()) {
              this.deviceInfo.hardwareVersion = String(hversion);
            }
            if (version !== undefined && version !== null && String(version).trim()) {
              this.deviceInfo.softwareVersion = String(version);
            }
            // 更新 MFILE 缓存和运行状态
            const f = mfile !== undefined && mfile !== null ? String(mfile).trim() : '';
            const k = this.otaKey(this.device_id, this.loader_num);
            this.$set(this.deviceSignalCache, k, { ...(this.deviceSignalCache[k] || {}), MFILE: f });

            // 关键修复：只有当 MFILE 不为空 且 不是占位符 时才认为在运行
            // 特殊规则：如果包含"->"，检查"->"之前的内容是否为"FAIL:MFILE"，如果是则模型未运行
            const isFailMfile = (str) => {
              if (!str) return false;
              const upperStr = String(str).toUpperCase();
              const arrowIndex = upperStr.indexOf('->');
              if (arrowIndex !== -1) {
                const beforeArrow = upperStr.substring(0, arrowIndex).trim();
                return beforeArrow === 'FAIL:MFILE';
              }
              return false;
            };

            if (!f || f.toLowerCase().includes('example') || isFailMfile(f)) {
              this.isModelRunning = false;
              this.runningFile = '';
              this.runningModule = '';
            } else {
              this.isModelRunning = true;
              // 修复：根据用户反馈，SEF3/Window_F 结构中，SEF3 是文件名，Window_F 是运行中的模块名
              const parts = f.split(/[\/\\]/);
              if (parts.length >= 2) {
                this.runningFile = parts[0]; // 文件名（如 SEF3）
                this.runningModule = parts[1]; // 模块名（如 Window_F）
              } else {
                this.runningFile = f;
                this.runningModule = '';
              }
            }
          } catch (err) {
            // 读信号失败时，不应继续显示“运行中”
            this.isModelRunning = false;
            this.runningFile = '';
          }
        },

        // 顶部工具按钮：统一弹窗/抽屉，不切换主内容区
        openModelDialog() { this.dialogModelVisible = true; this.loadModelTree(); },
        openUpgradeDialog() { this.dialogUpgradeVisible = true; },
        openLogDialog() { this.dialogLogVisible = true; this.loadLogTree(); },
        openConsoleDrawer() { this.drawerConsoleVisible = true; },

        toBool(v) {
          if (v === true) return true;
          if (v === false) return false;
          const s = String(v).toLowerCase().trim();
          return s === 'true' || s === '1' || s === 'yes' || s === 'y';
        },
        deviceLedClass(dev) {
          // 灰：未连接；绿：已连接/停止运行；蓝：运行中；红蓝闪烁：OTA升级中；红：异常
          const connected = dev && this.toBool(dev.connect);
          if (!connected) return '';

          // 检查是否正在OTA升级（只有状态为 'running' 时才显示升级状态）
          const k = this.getDeviceKey(dev);
          const otaSt = this.otaStatus[k];
          const isUpgrading = otaSt && otaSt.status === 'running';
          if (isUpgrading) return 'upgrading';

          const abnormal = this.toBool(dev.interrupt) || this.toBool(dev.high_temp_alarm) || this.toBool(dev.busy);
          if (abnormal) return 'alarm';

          // 运行中：蓝色；停止运行：绿色
          const running = this.toBool(dev.running);
          if (running) return 'running';
          return 'connected';
        },
        getDeviceKey(dev) {
          if (!dev) return '';
          return `${String(dev.ip)}#${Number(dev.loader_num)}`;
        },
        isSelectedDevice(dev) {
          return this.selectedDeviceKey && this.selectedDeviceKey === this.getDeviceKey(dev);
        },
        async selectDevice(dev) {
          if (!dev) return;

          // 记录切换前的设备信息
          const oldDeviceId = this.device_id;
          const oldLoaderNum = this.loader_num;

          // 检查是否有页签开启了定时刷新
          const activeSheet = this.registerSheets.find(s => s.timerEnabled);

          // 切换设备时，停止原设备的定时刷新寄存器
          if (this.wsConnected && activeSheet) {
            try {
              await wsClient.stopRefreshRegs();
              console.log('[Device] 切换设备，已停止原设备的定时刷新寄存器');
            } catch (err) {
              console.error('[Device] 停止定时刷新失败:', err);
            }
          }

          // 更新选择（并同步影响顶部 start/stop/get_models 的目标设备）
          this.selectedDeviceKey = this.getDeviceKey(dev);
          if (dev.ip) this.device_id = String(dev.ip);
          if (Number.isFinite(Number(dev.loader_num))) this.loader_num = Number(dev.loader_num);
          // 选中即认为"当前设备上下文"来自状态推送
          this.deviceConnected = !!dev.connect;
          // 直接从 connectStatus 中同步设备信息，不需要请求寄存器
          this.syncDeviceInfoFromStatus(dev);

          // 如果切换了设备，且之前有页签开启了定时刷新，需要在新设备上重新启动
          if (activeSheet && (oldDeviceId !== this.device_id || oldLoaderNum !== this.loader_num)) {
            // 清除所有页签的定时器标记
            this.registerSheets.forEach(s => {
              if (s.timerEnabled) {
                s.timerId = null;
                this.$set(s, 'timerEnabled', false);
              }
            });

            // 在新设备上重新启动当前活动页签的定时刷新
            if (this.deviceConnected && this.wsConnected && activeSheet.id === this.activeSheetId) {
              // 延迟一下，确保设备切换完成
              this.$nextTick(() => {
                this.$set(activeSheet, 'timerEnabled', true);
                this.startSheetTimer(activeSheet);
                console.log('[Device] 已在新设备上重新启动定时刷新:', activeSheet.name);
              });
            }
          } else {
            // 如果没有切换设备，或者没有开启定时刷新，只清除标记
            this.registerSheets.forEach(s => {
              if (s.timerEnabled && s.timerId) {
                s.timerId = null;
                this.$set(s, 'timerEnabled', false);
              }
            });
          }
        },

        /**
         * 从 get_connect_status 推送消息中同步设备信息（不请求寄存器）
         * 直接使用推送消息中的 running_model 和 running 字段
         */
        syncDeviceInfoFromStatus(entry) {
          if (!entry) {
            entry = this.currentDeviceEntry;
          }
          if (entry) {
            // 从推送消息中获取设备信息
            this.deviceInfo = {
              sn: this.formatSN(entry.sn || this.deviceInfo.sn),
              hardwareVersion: entry.hversion || this.deviceInfo.hardwareVersion || '',
              softwareVersion: entry.version || this.deviceInfo.softwareVersion || '',
              runTime: (entry.total_time !== undefined && entry.total_time !== null && String(entry.total_time) !== '')
                ? `${entry.total_time} h`
                : (this.deviceInfo.runTime || '')
            };
            if (entry.sn) this.deviceSN = String(entry.sn);
            if (entry.name) this.deviceNameFromRegister = String(entry.name);

            // 直接使用推送消息中的 running 和 running_model 字段判断运行状态
            if (!this.deviceConnected) {
              this.isModelRunning = false;
              this.runningFile = '';
              this.runningModule = '';
            } else {
              // 直接使用 entry.running 和 entry.running_model，不使用缓存
              const isRunning = entry.running === true || String(entry.running).toLowerCase() === 'true';
              const runningModel = entry.running_model || '';

              // 判断是否真的在运行：running 为 true 且 running_model 不为空且不是占位符
              // 特殊规则：如果包含"->"，检查"->"之前的内容是否为"FAIL:MFILE"，如果是则模型未运行
              const isFailMfile = (str) => {
                if (!str) return false;
                const upperStr = String(str).toUpperCase();
                const arrowIndex = upperStr.indexOf('->');
                if (arrowIndex !== -1) {
                  const beforeArrow = upperStr.substring(0, arrowIndex).trim();
                  return beforeArrow === 'FAIL:MFILE';
                }
                return false;
              };

              if (isRunning && runningModel &&
                !runningModel.toLowerCase().includes('example') &&
                !isFailMfile(runningModel)) {
                this.isModelRunning = true;

                // 修复：根据用户反馈，SEF3/Window_F 结构中，SEF3 是文件名，Window_F 是运行中的模块名
                const parts = runningModel.split(/[\/\\]/);
                if (parts.length >= 2) {
                  this.runningFile = parts[0]; // 文件名（如 SEF3）
                  this.runningModule = parts[1]; // 模块名（如 Window_F）
                } else {
                  this.runningFile = runningModel;
                  this.runningModule = '';
                }
              } else {
                this.isModelRunning = false;
                this.runningFile = '';
                this.runningModule = '';
              }
            }
          }
        },

        // ===========================
        // OTA（socket.md 14/15）
        // ===========================
        otaKey(ip, loader_num) {
          return `${String(ip)}#${Number(loader_num)}`;
        },
        getOtaProgress(ip, loader_num) {
          const k = this.otaKey(ip, loader_num);
          const v = this.otaProgress[k];
          return typeof v === 'number' ? v : 0;
        },
        getOtaProgressStatus(ip, loader_num) {
          const k = this.otaKey(ip, loader_num);
          const st = this.otaStatus[k] || {};
          if (st.status === 'success') return 'success';
          if (st.status === 'error' || st.status === 'failed') return 'exception';
          return undefined;
        },
        getOtaStatusText(ip, loader_num) {
          const k = this.otaKey(ip, loader_num);
          const st = this.otaStatus[k];
          if (st && st.desc) return st.desc;
          const p = this.getOtaProgress(ip, loader_num);
          if (p > 0 && p < 100) return `升级中… ${p.toFixed(1)}%`;
          return '—';
        },
        async checkCloudNewVersion() {
          if (!this.wsConnected) return;
          this.otaLoading = true;
          try {
            const resp = await wsClient.checkLoadersNewVersion();
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && payload.ret === false) throw new Error(payload.desc || 'check failed');
            const desc = (payload && payload.desc) || [];
            this.otaGroups = Array.isArray(desc) ? desc : [];
            this.otaCloudCheckedAt = new Date().toLocaleString();
            this.otaCloudMsg = '';
            this.otaCloudStatus = this.otaGroups.length ? 'ok' : 'empty';
            // 初始化进度（优先用返回的 progress）
            for (const grp of this.otaGroups) {
              for (const d of (grp.devices || [])) {
                const k = this.otaKey(grp.ip, d.loader_num);
                const p = Number(d.progress);
                if (Number.isFinite(p)) this.$set(this.otaProgress, k, p);
              }
            }
            this.$message.success('已获取云端版本信息');
          } catch (err) {
            this.otaCloudCheckedAt = new Date().toLocaleString();
            this.otaCloudStatus = 'error';
            this.otaCloudMsg = (err && err.message) ? err.message : String(err);
            this.$message.error('检查失败: ' + (err.message || err));
          } finally {
            this.otaLoading = false;
          }
        },
        async startOta(ip, loader_num) {
          if (!this.wsConnected) return;
          const k = this.otaKey(ip, loader_num);
          this.otaUpdatingKey = k;
          this.$set(this.otaStatus, k, { status: 'running', desc: '已发起升级' });
          try {
            const resp = await wsClient.updateOneLoader(String(ip), Number(loader_num));
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && payload.ret === false) throw new Error(payload.desc || 'update failed');
            // 真实进度会通过 update_ota_progress 推送
            this.$message.success('升级请求已发送');
          } catch (err) {
            this.$set(this.otaStatus, k, { status: 'error', desc: err.message || '升级失败' });
            this.$message.error('升级失败: ' + (err.message || err));
          } finally {
            this.otaUpdatingKey = '';
          }
        },

        openLocalUpgrade(row) {
          this.localUpgradeTarget = {
            ip: row.ip,
            loader_num: row.loader_num,
            loader_name: row.loader_name || ''
          };
          this.localUpgradePath = '';
          this.dialogLocalUpgradeVisible = true;
        },
        async confirmLocalUpgrade() {
          // 直接从输入框获取路径
          const filePath = (this.localUpgradePath || '').trim();
          if (!filePath) {
            this.$message.warning('请输入 .hex 文件的绝对路径');
            return;
          }
          if (!filePath.toLowerCase().endsWith('.hex')) {
            this.$message.warning('文件路径必须以 .hex 结尾');
            return;
          }

          // 防止重复点击
          if (this.localUpgradeLoading) {
            return;
          }

          // 立即关闭弹窗并设置加载状态
          this.dialogLocalUpgradeVisible = false;
          this.localUpgradeLoading = true;

          const k = this.otaKey(this.localUpgradeTarget.ip, this.localUpgradeTarget.loader_num);

          try {
            // 调用 loader_ota 接口
            const resp = await wsClient.loaderOta(
              this.localUpgradeTarget.ip,
              this.localUpgradeTarget.loader_num,
              filePath
            );

            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && payload.ret === false) {
              throw new Error(payload.desc || '近端升级失败');
            }

            // 只有成功后才设置升级状态
            this.$message.success('近端升级已启动');
            this.$set(this.otaStatus, k, { status: 'running', desc: '近端升级中…' });
            this.otaUpdatingKey = k;

            // 清空输入
            this.localUpgradePath = '';
          } catch (err) {
            this.$message.error(`近端升级失败: ${err.message || err}`);
            // 如果失败，重新打开弹窗让用户重试
            this.dialogLocalUpgradeVisible = true;
          } finally {
            this.localUpgradeLoading = false;
          }
        },

        // 控制台：保留历史
        pushConsole(dir, text) {
          const ts = new Date().toLocaleString();
          this.consoleHistory.push({ ts, dir, text: String(text ?? '') });
          // 控制台只保留最近 200 条
          if (this.consoleHistory.length > 200) this.consoleHistory.splice(0, this.consoleHistory.length - 200);
        },
        async sendConsoleCmd() {
          try {
            const cmd = String(this.consoleInput || '').trim();
            if (!cmd) return;
            this.pushConsole('out', cmd);
            this.consoleInput = '';
            const resp = await wsClient.sendCmd(this.device_id, this.loader_num, cmd, false);
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            const desc = payload && payload.desc !== undefined ? payload.desc : JSON.stringify(payload);
            this.pushConsole('in', desc);
          } catch (err) {
            this.pushConsole('in', 'ERROR: ' + (err.message || err));
          }
        },

        // 设备文件树（get_file_info）：用于模型管理(project*) 和 日志拉取(log/)
        normalizeTree(node) {
          if (!node) return null;
          if (Array.isArray(node)) return node.map(n => this.normalizeTree(n)).filter(Boolean);

          const label = node.label !== undefined ? String(node.label) : (node.name !== undefined ? String(node.name) : '');

          // 根据最新的 socket.md，子节点可能在 children 或 desc 字段中
          let rawChildren = [];
          if (Array.isArray(node.children)) {
            rawChildren = node.children;
          } else if (Array.isArray(node.desc)) {
            rawChildren = node.desc;
          }

          return { label, children: rawChildren.map(c => this.normalizeTree(c)).filter(Boolean) };
        },
        findNodeByLabel(nodes, label) {
          const list = Array.isArray(nodes) ? nodes : [];
          const target = String(label).toLowerCase();
          for (const n of list) {
            if (!n) continue;
            if (n.label && String(n.label).toLowerCase() === target) return n;
            const hit = this.findNodeByLabel(n.children, target);
            if (hit) return hit;
          }
          return null;
        },
        async loadFileTreeRoot() {
          if (!this.wsConnected) return [];
          const resp = await wsClient.getFileInfo(this.device_id, this.loader_num, '');
          const payload = (resp && resp.data !== undefined) ? resp.data : resp;

          const norm = this.normalizeTree(payload);
          if (Array.isArray(norm)) return norm;

          // 特殊处理：如果根节点没有 label 但有 children（说明 payload 是个包装对象），则返回其 children
          if (norm && !norm.label && norm.children && norm.children.length) {
            return norm.children;
          }

          if (norm && (norm.label || (norm.children && norm.children.length))) return [norm];
          return [];
        },
        async loadModelTree() {
          this.modelTreeLoading = true;
          try {
            const roots = await this.loadFileTreeRoot();
            const root = roots[0] || null;
            const children = root && Array.isArray(root.children) ? root.children : roots;
            // 模型管理：只显示 project*，排除 log
            const projects = (children || []).filter(n => n && n.label && n.label.toLowerCase() !== 'log');
            this.modelTreeData = projects;
          } catch (err) {
            this.modelTreeData = [];
          } finally {
            this.modelTreeLoading = false;
          }
        },
        async loadLogTree() {
          this.logTreeLoading = true;
          try {
            const roots = await this.loadFileTreeRoot();
            // 需求：日志拉取弹窗中只会展示 log 目录下的内容
            const logNode = this.findNodeByLabel(roots, 'log');
            if (logNode) {
              // 将 log 节点作为根节点展示，这样 buildFullPath 就能正确包含 "log/" 路径
              this.logTreeData = [logNode];
            } else {
              this.logTreeData = [];
            }
          } catch (err) {
            console.error('[LogTree] Failed:', err);
            this.logTreeData = [];
          } finally {
            this.logTreeLoading = false;
          }
        },
        async loadFetchTree() {
          this.fetchTreeLoading = true;
          try {
            const roots = await this.loadFileTreeRoot();
            // 需求：其余内容（排除 log 目录）放到设备获取展示
            const otherNodes = (Array.isArray(roots) ? roots : [roots]).filter(n => n && String(n.label).toLowerCase() !== 'log');
            this.fetchTreeData = otherNodes;
          } catch (err) {
            console.error('[FetchTree] Failed:', err);
            this.fetchTreeData = [];
          } finally {
            this.fetchTreeLoading = false;
          }
        },
        async handleDownloadDevice() {
          this.dialogFetchVisible = true;
          this.loadFetchTree();
        },
        async confirmFetchFile(data, node) {
          if (!data || (data.children && data.children.length > 0)) {
            return; // 仅支持获取文件，不支持目录
          }
          const path = this.buildFullPath(node);
          try {
            this.$message.info(`正在从设备获取文件: ${path}...`);
            if (this.wsConnected) {
              // 从设备获取文件到服务器本地
              await wsClient.downloadFromDevice(this.device_id, this.loader_num, path);
              this.$message.success('文件获取成功，已存入服务器本地');
              this.dialogFetchVisible = false;
              // 刷新本地文件列表
              await this.parseAllFiles();
            } else {
              this.$message.success('已从设备获取文件 (模拟)');
              this.dialogFetchVisible = false;
            }
          } catch (err) {
            this.$message.error(`获取失败: ${err.message || err}`);
          }
        },
        async handleDeleteFetchFile(data, node) {
          if (!data || !data.label) return;
          const path = this.buildFullPath(node);
          const isDir = data.children && data.children.length > 0;
          try {
            await this.$confirm(`确定要从设备上删除${isDir ? '目录' : '文件'} "${path}" 吗？${isDir ? '该操作将删除目录下所有内容！' : ''}`, '删除确认', {
              confirmButtonText: '删除',
              cancelButtonText: '取消',
              type: 'warning'
            });

            const resp = await wsClient.delFile(this.device_id, this.loader_num, path);
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && (payload.ret === false || payload.success === false)) {
              throw new Error(payload.desc || payload.msg || '删除失败');
            }
            this.$message.success(`${isDir ? '目录' : '文件'}删除成功`);
            this.loadFetchTree(); // 刷新列表
          } catch (err) {
            if (err !== 'cancel') {
              this.$message.error(`删除失败: ${err.message || err}`);
            }
          }
        },
        // 辅助：根据 el-tree 的 node 对象构建完整路径
        buildFullPath(node) {
          const pathParts = [];
          let current = node;
          while (current && current.data && current.level > 0) {
            pathParts.unshift(current.data.label);
            current = current.parent;
          }
          return pathParts.join('/');
        },
        async handlePullLog(data, node) {
          if (!data || !data.label) return;
          const path = this.buildFullPath(node);
          try {
            this.$message.info(`正在拉取: ${path}...`);
            const resp = await wsClient.pullLoaderLog(this.device_id, this.loader_num, path);
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && (payload.ret === false || payload.success === false)) {
              throw new Error(payload.desc || payload.msg || '拉取失败');
            }
            this.$message.success('拉取成功');
          } catch (err) {
            this.$message.error(`拉取失败: ${err.message || err}`);
          }
        },
        async handleDeleteLog(data, node) {
          if (!data || !data.label) return;
          const path = this.buildFullPath(node);
          const isDir = data.children && data.children.length > 0;

          try {
            await this.$confirm(`确定要删除设备上的${isDir ? '目录' : '文件'} "${path}" 吗？${isDir ? '该操作将删除目录下所有内容！' : ''}`, '删除确认', {
              confirmButtonText: '删除',
              cancelButtonText: '取消',
              type: 'warning'
            });

            const resp = await wsClient.delFile(this.device_id, this.loader_num, path);
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && (payload.ret === false || payload.success === false)) {
              throw new Error(payload.desc || payload.msg || '删除失败');
            }
            this.$message.success('删除成功');
            this.loadLogTree(); // 刷新列表
          } catch (err) {
            if (err !== 'cancel') {
              this.$message.error(`删除失败: ${err.message || err}`);
            }
          }
        },
        async loadDeviceSpecsConfig() {
          try {
            const resp = await fetch('device_specs.json');
            this.deviceSpecsConfig = await resp.json();
          } catch (err) {
            console.warn('[spec] load device_specs.json failed:', err);
            this.deviceSpecsConfig = null;
          }
        },

        async tryReadDeviceNameFromRegister() {
          // 仅在“EL-5000电子负载”场景需要从寄存器 NAME 获取（你要求的规则）
          // 这里依赖你 register_definitions.json 里存在 name=NAME 的寄存器定义
          try {
            const regDef = (this.registerDefsAll || this.registers || []).find(r => r && r.name === 'NAME');
            if (!regDef) return;
            const resp = await wsClient.getSignals(this.device_id, this.loader_num, regDef.name);
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            // 兼容：{name:"CCV",value:"100"} / {data:{name:"CCV",value:"100"}} / {data:[...]} / 直接数组
            let val = null;
            if (payload && payload.value !== undefined) val = payload.value;
            else if (payload && payload.data && payload.data.value !== undefined) val = payload.data.value;
            else if (Array.isArray(payload)) {
              const item = payload.find(x => x && x.name === regDef.name);
              if (item && item.value !== undefined) val = item.value;
            } else if (payload && Array.isArray(payload.data)) {
              const item = payload.data.find(x => x && x.name === regDef.name);
              if (item && item.value !== undefined) val = item.value;
            }
            if (val !== undefined && val !== null) {
              this.deviceNameFromRegister = String(val);
            }
          } catch (err) {
            // 读不到就用默认
          }
        },
        async loadLocationInfo() {
          try {
            const resp = await wsClient.queryLocationInfo();
            // 兼容不同返回层级
            const payload = resp && resp.data ? resp.data : resp;
            if (payload && payload.location_list) {
              this.locationList = payload.location_list || [];
              const registered = payload.loader_location || '';
              if (registered) {
                this.selectedLocation = registered;
                this.isLocationRegistered = true;
              } else {
                // 如果为空，显示特殊的默认地点，不自动保存
                this.selectedLocation = '未设置';
                this.isLocationRegistered = false;
              }
            }
          } catch (err) {
            console.warn('[ws] query_location_info failed:', err);
            // 如果获取失败，也显示默认地点
            this.selectedLocation = '未设置';
            this.isLocationRegistered = false;
          }
        },

        async handleSaveLocation() {
          if (!this.selectedLocation || this.selectedLocation === '未设置') {
            this.$message.warning('请先选择实验室');
            return;
          }
          try {
            const resp = await wsClient.saveLocationInfo(this.selectedLocation);
            const payload = resp && resp.data ? resp.data : resp;
            if (payload && (payload.ret === true || payload.ret === 'true')) {
              this.$message.success('实验室位置保存成功');
              this.isLocationRegistered = true;
            } else {
              this.$message.error((payload && payload.desc) || '保存实验室位置失败');
            }
          } catch (err) {
            this.$message.error('保存失败: ' + err.message);
          }
        },

        onLocationChanged() {
          // 选中实验室后，点击保存才会生效
        },

        /**
         * 刷新模型列表（get_models）
         * 响应 data: { ret:true, desc:[{value,label,children:[...]}] }
         */
        async refreshModelOptions() {
          this.modelOptionsLoading = true;
          try {
            const resp = await wsClient.getModels(this.device_id, this.loader_num, this.currentSimType);
            const payload = resp && resp.data ? resp.data : resp; // 兼容不同返回层级
            const ok = payload && (payload.ret === true || payload.ret === 'true');
            if (!ok) {
              this.$message.error((payload && payload.desc) || '获取模型列表失败');
              this.modelOptions = [];
              return;
            }
            this.modelOptions = payload.desc || [];
            this.$message.success('模型列表已刷新');
            // 移除 refreshDeviceInfoFromSignals 调用，只刷新模型列表即可
          } catch (err) {
            this.$message.error('获取模型列表失败: ' + err.message);
          } finally {
            this.modelOptionsLoading = false;
          }
        },

        async startSelectedModel() {
          if (!this.canStartSelected) {
            this.$message.warning('请先选择项目/模型');
            return;
          }
          try {
            const resp = await wsClient.startLoader(this.device_id, this.loader_num, this.selectedModelPath, this.currentSimType);
            const payload = resp && resp.data ? resp.data : resp;
            if (payload && payload.ret === false) {
              this.$message.error(payload.desc || '启动失败');
            } else {
              this.$message.success((payload && payload.desc) || '已发送启动命令');
            }
          } catch (err) {
            this.$message.error('启动失败: ' + err.message);
          }
        },

        async stopSelectedModel() {
          if (!this.canStopSelected) {
            this.$message.warning('当前没有运行中的模型');
            return;
          }
          try {
            // 使用当前运行的文件路径，如果没有则使用 selectedModelPath
            const modelPath = this.runningFile || (Array.isArray(this.selectedModelPath) && this.selectedModelPath.length >= 2 ? this.selectedModelPath : ['project1', 'model']);

            // 先尝试 data_replay（回灌）
            let resp = await wsClient.stopLoader(this.device_id, this.loader_num, modelPath, 'data_replay');
            let payload = resp && resp.data ? resp.data : resp;

            // 如果 data_replay 失败，再尝试 component_emulation（模型）
            if (payload && payload.ret === false) {
              console.log('[WS] data_replay 停止失败，尝试 component_emulation');
              resp = await wsClient.stopLoader(this.device_id, this.loader_num, modelPath, 'component_emulation');
              payload = resp && resp.data ? resp.data : resp;
            }

            // 判断最终结果
            if (payload && payload.ret === false) {
              this.$message.error(payload.desc || '停止失败');
            } else {
              // 如果响应表明停止成功，直接更新状态，不需要再读取MFILE
              this.isModelRunning = false;
              this.runningFile = '';
              this.runningModule = '';
              this.$message.success((payload && payload.desc) || '已发送停止命令');
              // 不再调用 refreshDeviceInfoFromSignals，因为响应已经表明停止成功
            }
          } catch (err) {
            this.$message.error('停止失败: ' + err.message);
          }
        },
        /**
         * 加载模型字典（参数/模块定义）
         * 【纯静态模式】优先从同目录静态文件加载：model_dictionary.json
         * （仍保留 WS/API 兜底，方便联调）
         */
        async loadModelDictionary() {
          try {
            // 1) 静态 json（cs/ 同目录）
            try {
              const resp = await fetch('model_dictionary.json', { cache: 'no-cache' });
              if (resp.ok) {
                const json = await resp.json();
                if (json && json.parameters && json.modules) {
                  this.modelDictionary = { parameters: json.parameters, modules: json.modules };
                  modelDictionary = this.modelDictionary;
                  return;
                }
              }
            } catch (e) { }

            // 2) WS 兜底
            if (this.wsConnected) {
              const data = await wsClient.request('model.dictionary');
              if (data && data.parameters && data.modules) {
                this.modelDictionary = { parameters: data.parameters, modules: data.modules };
                modelDictionary = this.modelDictionary;
                return;
              }
            }

            // 3) HTTP API 兜底
            const resp = await fetch('/api/model/dictionary');
            const json = await resp.json();
            if (json && json.parameters && json.modules) {
              this.modelDictionary = { parameters: json.parameters, modules: json.modules };
              modelDictionary = this.modelDictionary;
            }
          } catch (err) {
            console.warn('[model] loadModelDictionary failed:', err);
          }
        },
        /**
         * 加载寄存器定义
         * 【纯静态模式】优先从同目录静态文件加载：register_definitions.json
         * （仍保留 WS/API 兜底，方便联调）
         */
        async loadRegisterDefinitions() {
          try {
            let defs = null;
            // 1) 静态 json
            try {
              const resp = await fetch('register_definitions.json', { cache: 'no-cache' });
              if (resp.ok) {
                const json = await resp.json();
                defs = json && json.definitions;
              }
            } catch (e) { }

            // 2) WS 兜底
            if (!defs && this.wsConnected) {
              const data = await wsClient.request('register.definitions');
              defs = data && data.definitions;
            }

            // 3) HTTP API 兜底
            if (!defs) {
              const resp = await fetch('/api/register/definitions');
              const json = await resp.json();
              defs = json && json.definitions;
            }

            if (!Array.isArray(defs)) return;

            // 保留全量定义
            this.registerDefsAll = defs;

            this.registers = defs.map(d => ({
              // 兼容历史：register_definitions.json 已将 address 改为 id（如 "0x0000"）
              address: (typeof d.address === 'number')
                ? d.address
                : (typeof d.id === 'string' && d.id.startsWith('0x'))
                  ? parseInt(d.id, 16)
                  : (typeof d.id === 'number' ? d.id : 0),
              name: d.name,
              type: d.type,
              access: d.access,
              description: d.description || '',
              min: typeof d.min === 'number' ? d.min : null,
              max: typeof d.max === 'number' ? d.max : null,
              value: null,
              inputValue: null,
              loading: false,
              modified: false,
              readError: false
            }));
          } catch (err) {
            console.warn('[register] loadRegisterDefinitions failed:', err);
          }
        },

        /**
         * 加载模型文件列表（打开参数编辑页面时调用）
         * 【接口】WebSocket: get_local_file_list
         */
        async parseAllFiles() {
          try {
            // 确保模型字典已加载
            await this.loadModelDictionary();

            if (this.wsConnected) {
              try {
                // 从服务器获取本地文件列表
                const resp = await wsClient.getLocalFileList();
                const payload = resp && resp.data ? resp.data : resp;

                // 检查响应格式
                if (payload && payload.ret === true && Array.isArray(payload.desc) && payload.desc.length > 0) {
                  // 只显示文件名列表，不加载内容（默认不选中文件）
                  this.models = payload.desc.map(file => ({
                    filename: file.filename || file.name || 'unknown.bin',
                    path: file.path || file.filename || file.name || 'unknown.bin',
                    success: false, // 未加载内容
                    modules: [],
                    raw: '',
                    modified: false,
                    errors: [],
                    warnings: []
                  }));

                  // 自动选中正在运行的模型
                  let foundRunning = false;
                  if (this.isModelRunning && this.runningFile) {
                    const runningIdx = this.models.findIndex(m => this.isFileRunning(m.filename));
                    if (runningIdx !== -1) {
                      this.selectModel(runningIdx);
                      foundRunning = true;
                      console.log('[参数编辑] 自动选中运行中模型:', this.models[runningIdx].filename);
                    }
                  }

                  if (!foundRunning) {
                    this.activeModelIndex = -1; // 默认不选中
                  }
                  console.log('[参数编辑] 成功加载文件列表，共', this.models.length, '个文件');
                  return;
                } else {
                  console.warn('[参数编辑] 文件列表为空或格式不正确:', payload);
                  // 如果返回空列表，也使用空列表，不使用示例文件
                  this.models = [];
                  this.activeModelIndex = -1;
                  return;
                }
              } catch (wsErr) {
                console.error('[参数编辑] 获取文件列表失败:', wsErr);
                // WebSocket 请求失败，使用空列表
                this.models = [];
                this.activeModelIndex = -1;
                return;
              }
            }

            // 如果 WebSocket 未连接，使用本地示例
            await this.loadSampleFiles();
            this.activeModelIndex = 0;
            this.expandedModules = { 0: true, 1: true };
          } catch (err) {
            console.error('加载模型列表失败:', err);
            // 出错时使用空列表，避免显示错误的示例文件
            this.models = [];
            this.activeModelIndex = -1;
          }
        },

        /**
         * 加载本地示例文件（模拟模式）
         */
        async loadSampleFiles() {
          const models = [];
          for (const filename of Object.keys(sampleFiles)) {
            // 现在 parseBinByServer 只传路径/文件名，后端根据此查找本地文件
            const parsed = await parseBinByServer(filename);
            models.push(parsed && parsed.success ? parsed : { success: false, filename, modules: [], errors: parsed.errors || [{ message: parsed.error || '解析失败', lineNum: 0 }], warnings: [], raw: sampleFiles[filename] });
          }
          this.models = models;
          console.log('[模拟] 使用本地示例文件');
        },
        async switchPage(page) {
          if (this.activePage === page) return;
          // 只有从“参数编辑”切换走时才检查
          if (this.activePage === 'model') {
            if (await this.confirmUnsavedChanges()) {
              this.activePage = page;
            }
          } else {
            this.activePage = page;
          }
        },
        async confirmUnsavedChanges() {
          if (!this.hasModified) return true;
          try {
            // 使用 distinguishCancelAndClose 来区分“放弃修改”和“取消切换”
            const action = await this.$confirm('当前文件有未保存的修改，是否保存？', '提示', {
              confirmButtonText: '保存并切换',
              cancelButtonText: '放弃修改并切换',
              distinguishCancelAndClose: true,
              type: 'warning'
            }).then(() => 'save').catch(action => action === 'cancel' ? 'discard' : 'cancel');

            if (action === 'save') {
              await this.handleSave();
              return true;
            } else if (action === 'discard') {
              // 放弃修改：标记旧模型为失败/未加载，以便下次进入时重新从服务器读取
              const oldModel = this.models[this.activeModelIndex];
              if (oldModel) {
                oldModel.success = false;
                oldModel.modules = [];
              }
              this.hasModified = false;
              return true;
            } else {
              // 取消：留在原地
              return false;
            }
          } catch (e) {
            return false;
          }
        },
        async handleSelectModel(index) {
          if (this.activeModelIndex === index) return;
          if (await this.confirmUnsavedChanges()) {
            this.selectModel(index);
          }
        },
        async selectModel(index) {
          this.activeModelIndex = index;
          const model = this.models[index];
          if (!model) return;

          // 如果文件内容未加载，从服务器读取
          if (!model.success && model.path && this.wsConnected) {
            try {
              model.loading = true;
              const resp = await wsClient.readLocalFile(model.path);
              // 根据 WSClient 的实现，resp 已经是解析后的 data 对象（或者是整个消息）
              const payload = (resp && resp.data !== undefined) ? resp.data : resp;

              if (payload && (payload.success === true || payload.ret === true)) {
                // 如果是 {ret:true, data: {...}} 结构，则解包 data
                const result = (payload.ret === true && payload.data) ? payload.data : payload;

                if (result.success !== false) {
                  Object.assign(model, {
                    success: true,
                    filename: result.filename || model.filename,
                    modules: result.modules || [],
                    raw: result.content || '',
                    path: model.path,
                    modified: false,
                    loading: false,
                    errors: result.errors || [],
                    warnings: result.warnings || []
                  });
                } else {
                  throw new Error(result.desc || result.msg || '文件解析失败');
                }
              } else {
                throw new Error(payload?.desc || payload?.msg || '读取文件失败');
              }
            } catch (err) {
              console.error('读取文件失败:', err);
              model.loading = false;
              model.success = false;
              model.errors = [{ message: err.message || '读取失败', lineNum: 0 }];
              this.$message.error(`读取文件失败: ${err.message || err}`);
            }
          }

          this.showRaw = false;
          this.hasModified = false;
          // 自动展开运行中的模块，否则默认展开第一个
          if (this.currentModel && this.isFileRunning(this.currentModel.filename)) {
            const runningModuleIndex = this.currentModel.modules.findIndex(m => m.name === this.runningModule);
            if (runningModuleIndex !== -1) {
              this.expandedModules = { [runningModuleIndex]: true };
            } else {
              this.expandedModules = { 0: true };
            }
          } else {
            this.expandedModules = { 0: true };
          }
        },
        toggleModule(index) { this.$set(this.expandedModules, index, !this.expandedModules[index]); },
        updateArrayParam(mod, param, value) {
          param.value = value.trim().split(/\s+/).map(v => {
            const num = parseFloat(v);
            return isNaN(num) ? v : num;
          });
          this.hasModified = true;
        },
        toggleConnect() {
          this.deviceConnected = !this.deviceConnected;
          if (!this.deviceConnected) this.isModelRunning = false;
        },
        isFileRunning(filename) {
          if (!this.isModelRunning || !this.runningFile || !filename) return false;
          // 标准化处理：去掉路径前缀、忽略后缀差异
          const normalize = (s) => String(s).split('/').pop().split('\\').pop().replace(/\.(bin|json)$/i, '');
          return normalize(this.runningFile) === normalize(filename);
        },
        isModuleRunning(filename, moduleName) {
          return this.isFileRunning(filename) && this.runningModule === moduleName;
        },

        // 参数字典相关方法
        // 模型字典相关方法（来自 data/model_dictionary.json）
        getParamDef(paramName) { return (this.modelDictionary && this.modelDictionary.parameters || {})[paramName]; },
        getModuleDef(moduleName) { return (this.modelDictionary && this.modelDictionary.modules || {})[moduleName]; },
        getModuleDisplayName(moduleName) {
          const def = this.getModuleDef(moduleName);
          return def ? `${def.name} (${moduleName})` : moduleName;
        },
        getPrecision(paramName) {
          const def = this.getParamDef(paramName);
          if (!def || !def.step) return 2;
          const str = def.step.toString();
          const decimal = str.indexOf('.');
          return decimal === -1 ? 0 : str.length - decimal - 1;
        },
        isOutOfRange(param) {
          const def = this.getParamDef(param.name);
          if (!def || def.min === undefined || param.type !== 'single') return false;

          // 确保转换为数字进行比较，避免字符串比较导致的边界问题（如 "0.00" 与 0）
          const val = parseFloat(param.value);
          const min = parseFloat(def.min);
          const max = parseFloat(def.max);

          if (isNaN(val)) return false;

          // 使用微小的容差处理浮点数边界（例如 0.00 应该等于 0）
          return val < (min - 1e-9) || val > (max + 1e-9);
        },
        isNumericParam(param) {
          return typeof param.value === 'number' || !isNaN(parseFloat(param.value));
        },

        // 单值参数更新（修复删除后无法调节的问题）
        updateSingleParam(param, value) {
          // 当值为 null 或 undefined 时，使用默认值或0
          if (value === null || value === undefined || isNaN(value)) {
            const def = this.getParamDef(param.name);
            param.value = def && def.default !== undefined ? def.default : 0;
          } else {
            param.value = value;
          }
          this.hasModified = true;
        },

        // 数组操作方法
        addArrayItem(param) {
          const lastValue = param.value.length > 0 ? param.value[param.value.length - 1] : 0;
          param.value.push(typeof lastValue === 'number' ? 0 : '');
          this.hasModified = true;
        },
        removeArrayItem(param, index) {
          param.value.splice(index, 1);
          this.hasModified = true;
        },
        updateArrayItem(param, index, value) {
          if (value === null || value === undefined || isNaN(value)) {
            param.value[index] = 0;
          } else {
            param.value[index] = value;
          }
          this.hasModified = true;
        },
        updateArrayItemStr(param, index, value) {
          param.value[index] = value;
          this.hasModified = true;
        },

        // 矩阵操作方法
        addMatrixRow(param) {
          if (param.value.length > 0) {
            const cols = param.value[0].length;
            param.value.push(new Array(cols).fill(0));
          } else {
            param.value.push([0, 0, 0]);
          }
          this.hasModified = true;
        },
        removeMatrixRow(param, rowIndex) {
          if (param.value.length > 1) {
            param.value.splice(rowIndex, 1);
            this.hasModified = true;
          } else {
            this.$message.warning('至少保留一行数据');
          }
        },
        updateMatrixCell(param, rowIndex, colIndex, value) {
          if (value === null || value === undefined || isNaN(value)) {
            param.value[rowIndex][colIndex] = 0;
          } else {
            param.value[rowIndex][colIndex] = value;
          }
          this.hasModified = true;
        },

        // ============================================================
        // API 接口调用方法
        // 【说明】以下方法需要对接后端 Python 接口
        // ============================================================

        /**
         * 保存文件到本地
         * 【接口】WebSocket: file.save
         */
        async handleSave() {
          if (!this.currentModel || !this.currentModel.path) return;

          try {
            const binData = {
              filename: this.currentModel.filename,
              modules: this.currentModel.modules
            };
            const content = this.generateBinContent(); // 生成文本内容供本地 raw 视图更新

            if (this.wsConnected) {
              // 需求：bin_json 以对象/字典形式发送，由 WSClient 统一序列化
              await wsClient.saveLocalFile(this.currentModel.path, binData);
              this.$message.success('文件已保存到服务器本地');
            } else {
              console.log('[模拟] 保存文件:', this.currentModel.filename);
              this.$message.success('文件已保存 (模拟)');
            }
            this.hasModified = false;
            // 更新 raw 内容
            this.currentModel.raw = content;
          } catch (err) {
            this.$message.error(`保存失败: ${err.message}`);
          }
        },

        /**
         * 另存为文件到用户本地电脑
         */
        async handleSaveAs() {
          if (!this.currentModel) return;

          try {
            const content = this.generateBinContent();
            const filename = this.currentModel.filename || 'model.bin';

            // 优先尝试使用现代浏览器的 File System Access API (提供真正的“另存为”对话框)
            if (window.showSaveFilePicker) {
              try {
                const handle = await window.showSaveFilePicker({
                  suggestedName: filename,
                  types: [{
                    description: '模型文件',
                    accept: { 'text/plain': ['.bin'] },
                  }],
                });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                this.$message.success('文件已保存到本地');
                return;
              } catch (pickerErr) {
                // 如果用户取消了选择，直接返回
                if (pickerErr.name === 'AbortError') return;
                console.warn('showSaveFilePicker failed, falling back to download:', pickerErr);
              }
            }

            // 兜底方案：传统的 <a> 标签下载方式
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            this.$message.success('已触发浏览器下载');
          } catch (err) {
            console.error('另存为失败:', err);
            this.$message.error(`保存失败: ${err.message || err}`);
          }
        },

        // --- 模型文件/模块新增 ---
        handleCreateNewModel() {
          this.newModelFilename = '';
          this.dialogNewModelVisible = true;
        },
        async confirmCreateNewModel() {
          const name = this.newModelFilename.trim();
          if (!name) return;
          const filename = name.endsWith('.bin') ? name : name + '.bin';

          try {
            // 构造新模型的对象结构
            const binData = {
              filename: filename,
              modules: []
            };
            const content = `# New Model: ${filename}\n# Created at: ${new Date().toLocaleString()}\n`;

            if (this.wsConnected) {
              // 直接保存到 resource/loader/ 文件夹下，使用文件名作为路径
              const path = filename;

              // 调用保存接口保存到服务器本地，传入对象
              await wsClient.saveLocalFile(path, binData);
              this.$message.success(`模型文件 ${filename} 创建成功`);
              this.dialogNewModelVisible = false;

              // 刷新列表
              await this.parseAllFiles();
              // 选中新创建的文件
              const idx = this.models.findIndex(m => m.path === path || m.filename === filename);
              if (idx !== -1) {
                await this.selectModel(idx);
              }
            } else {
              // 模拟：直接加到本地列表
              this.models.push({
                filename,
                path: filename,
                raw: content,
                modules: [],
                success: true,
                modified: false,
                errors: [],
                warnings: []
              });
              this.$message.success(`模型文件 ${filename} 创建成功 (模拟)`);
              this.dialogNewModelVisible = false;
              // 选中新创建的文件
              const idx = this.models.findIndex(m => m.filename === filename);
              if (idx !== -1) this.activeModelIndex = idx;
            }
          } catch (err) {
            this.$message.error(`创建失败: ${err.message || err}`);
          }
        },
        handleOpenAddModuleDialog() {
          if (!this.currentModel) return;
          this.selectedModuleType = '';
          this.dialogAddModuleVisible = true;
        },
        getModuleDesc(type) {
          if (!type || !this.modelDictionary || !this.modelDictionary.modules || !this.modelDictionary.modules[type]) return '无描述';
          return this.modelDictionary.modules[type].description || '无描述';
        },
        confirmAddModule() {
          if (!this.selectedModuleType || !this.currentModel) return;

          // 检查模块是否已存在
          if (this.currentModel.modules && this.currentModel.modules.some(m => m.name === this.selectedModuleType)) {
            this.$message.warning('该模块已存在，请勿重复添加');
            return;
          }

          const modDef = this.modelDictionary.modules[this.selectedModuleType];
          if (!modDef) return;

          // 根据定义构建新模块对象
          const newModule = {
            name: this.selectedModuleType,
            params: []
          };

          // 如果定义里有参数列表，则初始化参数
          if (modDef.parameters && Array.isArray(modDef.parameters)) {
            modDef.parameters.forEach(pName => {
              const pDef = this.modelDictionary.parameters[pName];
              if (pDef) {
                let initialValue;
                if (pDef.type === 'array') {
                  initialValue = pDef.default !== undefined ? [...pDef.default] : [];
                } else if (pDef.type === 'matrix') {
                  initialValue = pDef.default !== undefined ? pDef.default.map(row => [...row]) : [[0, 0, 0]];
                } else {
                  initialValue = pDef.default !== undefined ? pDef.default : (pDef.min !== undefined ? pDef.min : 0);
                }

                newModule.params.push({
                  name: pName,
                  type: pDef.type || 'single',
                  value: initialValue
                });
              }
            });
          }

          // 添加到当前模型
          if (!this.currentModel.modules) this.$set(this.currentModel, 'modules', []);
          this.currentModel.modules.push(newModule);
          this.hasModified = true;
          this.dialogAddModuleVisible = false;

          // 展开新模块
          const newIdx = this.currentModel.modules.length - 1;
          this.$set(this.expandedModules, newIdx, true);

          this.$message.success(`已添加模块: ${this.selectedModuleType}`);
        },
        handleOpenAddParamDialog(moduleIndex) {
          if (!this.currentModel || !this.currentModel.modules || moduleIndex < 0) return;
          const module = this.currentModel.modules[moduleIndex];
          if (!module) return;

          // 检查模块是否正在运行
          if (this.isModuleRunning(this.currentModel.filename, module.name)) {
            this.$message.warning('该模块正在运行中，无法添加参数');
            return;
          }

          this.selectedModuleIndexForParam = moduleIndex;
          this.selectedParamName = '';
          this.dialogAddParamVisible = true;
        },
        confirmAddParam() {
          if (!this.selectedParamName || this.selectedModuleIndexForParam < 0 || !this.currentModel) return;

          const module = this.currentModel.modules[this.selectedModuleIndexForParam];
          if (!module) return;

          // 检查参数是否已存在
          if (module.params.some(p => p.name === this.selectedParamName)) {
            this.$message.warning('该参数已存在');
            return;
          }

          // 获取参数定义
          const pDef = this.modelDictionary.parameters[this.selectedParamName];
          if (!pDef) {
            this.$message.error('参数定义不存在');
            return;
          }

          // 检查模块是否允许此参数
          const modDef = this.modelDictionary.modules[module.name];
          if (modDef && modDef.allowed_param_ids && pDef.id) {
            if (!modDef.allowed_param_ids.includes(pDef.id)) {
              this.$message.error(`模块 ${module.name} 不允许使用参数 ${this.selectedParamName} (ID: ${pDef.id})`);
              return;
            }
          }

          // 构建新参数对象
          let initialValue;
          let paramType = 'single'; // 默认统一使用 single 类型适配 UI

          if (pDef.type === 'array') {
            paramType = 'array';
            initialValue = pDef.default !== undefined ? [...pDef.default] : [];
          } else if (pDef.type === 'matrix') {
            paramType = 'matrix';
            initialValue = pDef.default !== undefined ? pDef.default.map(row => [...row]) : [[0, 0, 0]];
          } else if (pDef.type === 'boolean') {
            paramType = 'single'; // 布尔值也映射为 single
            initialValue = pDef.default !== undefined ? pDef.default : (pDef.options && pDef.options.length > 0 ? pDef.options[0] : 0);
          } else {
            paramType = 'single'; // number 等其他类型映射为 single
            initialValue = pDef.default !== undefined ? pDef.default : (pDef.min !== undefined ? pDef.min : 0);
          }

          const newParam = {
            name: this.selectedParamName,
            type: paramType,
            value: initialValue
          };

          // 添加到模块
          if (!module.params) this.$set(module, 'params', []);
          module.params.push(newParam);
          this.hasModified = true;
          this.dialogAddParamVisible = false;

          this.$message.success(`已添加参数: ${this.selectedParamName}`);
        },
        handleRemoveParam(moduleIndex, paramIndex) {
          if (!this.currentModel || !this.currentModel.modules || moduleIndex < 0) return;
          const module = this.currentModel.modules[moduleIndex];
          if (!module || !module.params || paramIndex < 0 || paramIndex >= module.params.length) return;

          // 检查模块是否正在运行
          if (this.isModuleRunning(this.currentModel.filename, module.name)) {
            this.$message.warning('该模块正在运行中，无法删除参数');
            return;
          }

          const param = module.params[paramIndex];

          this.$confirm(`确定要从模块 ${module.name} 中移除参数 ${param.name} 吗？`, '移除参数', {
            confirmButtonText: '移除',
            cancelButtonText: '取消',
            type: 'info'
          }).then(() => {
            module.params.splice(paramIndex, 1);
            this.hasModified = true;
            this.$message.success(`已移除参数: ${param.name}`);
          }).catch(() => { });
        },
        async handleDeleteModel(model, index) {
          // 安全限制：正在运行的模型文件不能删除
          if (this.isFileRunning(model.filename)) {
            this.$message.error('该模型文件正在运行中，无法删除');
            return;
          }
          try {
            await this.$confirm(`确定要删除模型文件 ${model.filename} 吗？此操作不可恢复。`, '确认删除', {
              confirmButtonText: '删除',
              cancelButtonText: '取消',
              type: 'warning'
            });

            if (this.wsConnected && model.path) {
              await wsClient.deleteLocalFile(model.path);
              this.$message.success('文件已删除');
              // 刷新文件列表
              await this.parseAllFiles();
              if (this.activeModelIndex >= this.models.length) {
                this.activeModelIndex = Math.max(-1, this.models.length - 1);
              }
            } else {
              this.models.splice(index, 1);
              this.$message.success('文件已删除 (模拟)');
            }
          } catch (err) {
            if (err !== 'cancel') {
              this.$message.error(`删除失败: ${err.message}`);
            }
          }
        },
        handleRemoveModule(index) {
          if (!this.currentModel || !this.currentModel.modules) return;
          const mod = this.currentModel.modules[index];

          // 安全限制：如果该模块正在运行，则不能移除
          if (this.isModuleRunning(this.currentModel.filename, mod.name)) {
            this.$message.error('该模块正在运行中，无法移除');
            return;
          }

          this.$confirm(`确定要从模型中移除模块 ${mod.name} 吗？`, '移除模块', {
            confirmButtonText: '移除',
            cancelButtonText: '取消',
            type: 'info'
          }).then(() => {
            this.currentModel.modules.splice(index, 1);
            this.hasModified = true;
            this.$message.success(`已移除模块: ${mod.name}`);
          }).catch(() => { });
        },

        /**
         * 应用参数到设备
         * 【接口】WebSocket: apply_params_to_device
         */
        async handleApply() {
          if (!this.canApply || !this.currentModel) return;

          try {
            // 获取当前正在运行的模块
            if (!this.runningModule) {
              this.$message.warning('当前没有运行中的模块，无法应用参数');
              return;
            }

            const activeModule = this.currentModel.modules.find(m => m.name === this.runningModule);
            if (!activeModule) {
              this.$message.warning(`当前模型文件中未找到运行中的模块: ${this.runningModule}`);
              return;
            }

            // 构建 module_info 字典：参数名 -> 参数值
            const moduleInfo = {};
            activeModule.params.forEach(p => {
              moduleInfo[p.name] = p.value;
            });

            if (this.wsConnected) {
              await wsClient.applyParamsToDevice(this.device_id, this.loader_num, moduleInfo);
              this.$message.success('参数已成功应用到运行模块');
            } else {
              console.log('[模拟] 应用参数到设备模块:', this.runningModule, moduleInfo);
              this.$message.success('参数已应用到模块 (模拟)');
            }
          } catch (err) {
            this.$message.error(`应用失败: ${err.message}`);
          }
        },

        /**
         * 上传到云端
         * 【接口】WebSocket: upload_to_cloud
         */
        async handleUploadCloud() {
          if (!this.currentModel || !this.currentModel.path) return;

          try {
            if (this.wsConnected) {
              await wsClient.uploadToCloud(this.currentModel.path);
              this.$message.success('已上传到云端');
            } else {
              console.log('[模拟] 上传云端');
              this.$message.success('已上传到云端 (模拟)');
            }
          } catch (err) {
            this.$message.error(`上传失败: ${err.message}`);
          }
        },

        /**
         * 从云端获取文件列表
         * 【接口】WebSocket: cloud.list
         */
        async handleGetCloudList() {
          try {
            if (this.wsConnected) {
              const data = await wsClient.getCloudFileList(this.deviceSN);
              console.log('云端文件列表:', data.files);
              // TODO: 显示文件列表对话框
              this.$message.success(`获取到 ${data.files.length} 个云端文件`);
            } else {
              console.log('[模拟] 获取云端文件列表');
              this.$message.info('云端文件列表 (模拟)');
            }
          } catch (err) {
            this.$message.error(`获取失败: ${err.message}`);
          }
        },

        /**
         * 导入文件到设备（从服务器本地导入）
         * 【接口】WebSocket: load_model
         */
        /**
         * 刷新设备信息（手动刷新时调用，会请求寄存器获取最新状态）
         * 【接口】WebSocket: device.status
         */
        async refreshDeviceInfo() {
          try {
            // 先同步状态推送中的信息
            this.syncDeviceInfoFromStatus();
            // 然后请求寄存器获取最新的 MFILE 等状态
            await this.refreshDeviceInfoFromSignals();
            this.$message.success('设备信息已刷新');
          } catch (err) {
            console.error('刷新设备信息失败:', err);
          }
        },

        /**
         * 读取单个寄存器
         * 【接口】WebSocket: register.read
         * @param {Object} reg - 寄存器对象
         */
        async readRegister(reg, retryCount = 0) {
          if (!this.deviceConnected) {
            this.$message.warning('设备未连接');
            return;
          }

          reg.loading = true;

          try {
            if (this.wsConnected) {
              const resp = await wsClient.waitRegValue(this.device_id, this.loader_num, reg.name);
              // 处理响应：可能是 {data: {...}} 或直接是 {...}
              let payload = resp;
              if (resp && typeof resp === 'object') {
                if (resp.data !== undefined) {
                  // 如果 data 是字符串，尝试解析
                  if (typeof resp.data === 'string') {
                    try {
                      payload = JSON.parse(resp.data);
                    } catch (e) {
                      payload = resp.data;
                    }
                  } else {
                    payload = resp.data;
                  }
                }
              }

              // wait_reg_value 将值返回在 desc 字段，ret 表示成功
              if (payload && (payload.ret === true || payload.ret === 'true')) {
                const value = payload.desc !== undefined ? String(payload.desc) : '';

                // 如果值为空或null，且重试次数小于3次，则重试
                if ((value === '' || value === 'null' || value === 'Null' || value === 'NULL') && retryCount < 3) {
                  console.log(`[Register] ${reg.name} 读取值为空，重试 ${retryCount + 1}/3`);
                  reg.loading = false;
                  await new Promise(resolve => setTimeout(resolve, 300)); // 等待300ms后重试
                  return this.readRegister(reg, retryCount + 1);
                }

                reg.value = value;
                reg.readError = false;
                if (retryCount === 0) {
                  this.$message.success(`寄存器 ${reg.name} 读取成功`);
                } else {
                  this.$message.success(`寄存器 ${reg.name} 读取成功（重试${retryCount}次）`);
                }
              } else {
                throw new Error(payload && payload.desc ? String(payload.desc) : '读取失败');
              }
            } else {
              // 模拟模式
              console.log(`[模拟] 读取寄存器 ${reg.name}`);
              if (reg.type === 'int') {
                reg.value = Math.floor(Math.random() * 10000);
              } else {
                reg.value = reg.value || 'sample_string';
              }
              reg.readError = false;
              this.$message.success(`寄存器 ${reg.name} 读取成功 (模拟)`);
            }
          } catch (err) {
            // 如果失败且重试次数小于3次，则重试
            if (retryCount < 3) {
              console.log(`[Register] ${reg.name} 读取失败，重试 ${retryCount + 1}/3:`, err.message);
              reg.loading = false;
              await new Promise(resolve => setTimeout(resolve, 300)); // 等待300ms后重试
              return this.readRegister(reg, retryCount + 1);
            }
            // 读取失败：把值标记为"异常值"，并在 UI 上高亮区分
            reg.value = '读取失败';
            reg.readError = true;
            this.$message.error(`读取失败: ${err.message}`);
          } finally {
            reg.loading = false;
          }
        },

        /**
         * 写入单个寄存器
         * 【接口】WebSocket: register.write
         * @param {Object} reg - 寄存器对象
         */
        async writeRegister(reg) {
          if (!this.deviceConnected) {
            this.$message.warning('设备未连接');
            return;
          }

          if (reg.inputValue === null || reg.inputValue === '') {
            this.$message.warning('请输入要写入的值');
            return;
          }

          const writeValue = reg.inputValue;

          try {
            if (this.wsConnected) {
              const resp = await wsClient.setRegValue(this.device_id, this.loader_num, reg.name, writeValue);
              const payload = (resp && resp.data !== undefined) ? resp.data : resp;
              if (payload && payload.ret === false) throw new Error(payload.desc || '写入失败');

              // 写入成功后，通过 wait_reg_value 获取实际值，而不是直接套用输入值
              try {
                const readResp = await wsClient.waitRegValue(this.device_id, this.loader_num, reg.name);
                let readPayload = readResp;
                if (readResp && typeof readResp === 'object') {
                  if (readResp.data !== undefined) {
                    if (typeof readResp.data === 'string') {
                      try {
                        readPayload = JSON.parse(readResp.data);
                      } catch (e) {
                        readPayload = readResp.data;
                      }
                    } else {
                      readPayload = readResp.data;
                    }
                  }
                }

                if (readPayload && (readPayload.ret === true || readPayload.ret === 'true')) {
                  const actualValue = readPayload.desc !== undefined ? String(readPayload.desc) : '';
                  if (reg.access === 'readwrite' || reg.access === 'read') {
                    reg.value = actualValue;
                  }
                }
              } catch (readErr) {
                console.warn(`[Register] 写入后读取实际值失败:`, readErr);
                // 如果读取失败，仍然使用输入值（作为fallback）
                if (reg.access === 'readwrite') {
                  reg.value = writeValue;
                }
              }
            } else {
              // 模拟模式
              console.log(`[模拟] 写入寄存器 0x${reg.address.toString(16).toUpperCase()} = ${writeValue}`);
              if (reg.access === 'readwrite') {
                reg.value = writeValue;
              }
            }

            reg.inputValue = null;
            reg.modified = true;

            this.$message.success(`寄存器 ${reg.name} 写入成功`);

            // 3秒后取消高亮
            setTimeout(() => { reg.modified = false; }, 3000);
          } catch (err) {
            this.$message.error(`写入失败: ${err.message}`);
          }
        },

        /**
         * 刷新所有可读寄存器
         * 【接口】WebSocket: register.readAll
         */
        async refreshAllRegisters() {
          if (!this.deviceConnected) {
            this.$message.warning('设备未连接');
            return;
          }

          this.registerLoading = true;
          const readableRegs = this.registers.filter(r => r.access !== 'write');

          for (const reg of readableRegs) {
            reg.loading = true;
          }

          try {
            if (this.wsConnected) {
              const resp = await wsClient.getSignals(this.device_id, this.loader_num);
              // 处理响应：get_signals 返回的是数组格式 [{name:"CCV", value:"100"}, ...]
              let list = [];
              if (Array.isArray(resp)) {
                list = resp;
              } else if (resp && typeof resp === 'object') {
                // 如果响应是对象，尝试从 data 字段获取
                if (resp.data !== undefined) {
                  if (Array.isArray(resp.data)) {
                    list = resp.data;
                  } else if (typeof resp.data === 'string') {
                    try {
                      const parsed = JSON.parse(resp.data);
                      list = Array.isArray(parsed) ? parsed : [];
                    } catch (e) {
                      console.warn('[register] Failed to parse get_signals response:', e);
                    }
                  }
                } else if (Array.isArray(resp.list)) {
                  list = resp.list;
                }
              }

              const byName = new Map();
              for (const item of list) {
                if (item && item.name !== undefined && item.name !== null) {
                  byName.set(String(item.name), item.value !== undefined ? String(item.value) : '');
                }
              }

              const returned = new Set();
              for (const reg of readableRegs) {
                if (byName.has(reg.name)) {
                  reg.value = byName.get(reg.name);
                  reg.readError = false;
                  reg.loading = false;
                  returned.add(reg.name);
                }
              }
              // 未返回的数据视为"读取失败"（只对可读寄存器）
              for (const reg of readableRegs) {
                if (!returned.has(reg.name)) {
                  reg.value = '读取失败';
                  reg.readError = true;
                  reg.loading = false;
                }
              }

              if (list.length > 0) {
                this.$message.success(`已刷新 ${returned.size}/${readableRegs.length} 个寄存器`);
              } else {
                this.$message.warning('未获取到寄存器数据，请检查设备连接');
              }
            } else {
              // 模拟模式
              console.log('[模拟] 刷新所有寄存器');
              await new Promise(resolve => setTimeout(resolve, 500));
              for (const reg of readableRegs) {
                if (reg.type === 'int') {
                  reg.value = Math.floor(Math.random() * 10000);
                }
                reg.readError = false;
                reg.loading = false;
              }
              this.$message.success('所有寄存器已刷新 (模拟)');
            }
          } catch (err) {
            this.$message.error(`刷新失败: ${err.message}`);
            for (const reg of readableRegs) {
              reg.loading = false;
              reg.value = '读取失败';
              reg.readError = true;
            }
          } finally {
            this.registerLoading = false;
          }
        },

        // ============================================================
        // socket.md(9~13) 在 UI 内的简单对接入口（当前页面用弹窗收集参数）
        // ============================================================
        async handleGetFileInfo() {
          try {
            const { value } = await this.$prompt('请输入要查询的文件/目录名（可留空）', 'get_file_info', {
              confirmButtonText: '查询',
              cancelButtonText: '取消',
              inputValue: ''
            });
            const resp = await wsClient.getFileInfo(this.device_id, this.loader_num, value || '');
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            console.log('[get_file_info]', payload);
            this.$message.success('已获取文件信息（详见控制台 console.log）');
          } catch {
            // cancel
          }
        },
        async loadResourceNode(node, resolve) {
          try {
            let path = 'loader';
            if (node.level > 0) {
              // 构建完整路径
              const pathParts = [];
              let current = node;
              while (current && current.level > 0) {
                pathParts.unshift(current.data.label);
                current = current.parent;
              }
              path = 'loader/' + pathParts.join('/');
            }

            console.log('[ResourceTree] Loading path:', path);
            const resp = await wsClient.obtainLoaderDirStructure(path);
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            const list = Array.isArray(payload.result) ? payload.result : [];

            const nodes = list.map(item => {
              const label = item.label || '';
              // 需求：如果文件名中未带 .xxx 结尾，都默认为目录
              const isLeaf = label.indexOf('.') !== -1;
              return {
                label,
                isLeaf,
                path: path + '/' + label
              };
            });

            resolve(nodes);
          } catch (err) {
            console.error('[ResourceTree] Load failed:', err);
            this.$message.error('加载资源列表失败: ' + err.message);
            resolve([]);
          }
        },
        handleResourceNodeClick(data, node) {
          // 仅当是文件（带 . 的名称）时才允许选中路径
          if (data.label && data.label.indexOf('.') !== -1) {
            // buildFullPath 返回的是从 level 1 开始的路径，
            // 即相对于 loader/ 目录的相对路径（例如 "project1/example.bin"）
            this.selectedResourcePath = this.buildFullPath(node);
          } else {
            this.selectedResourcePath = '';
          }
        },
        handleLoadModelToDevice() {
          // 重置选择并打开弹窗
          this.selectedResourcePath = '';
          this.importDeviceType = 'current';
          this.dialogImportDeviceVisible = true;
          // 每次打开也尝试刷新一下
          this.resourceTreeKey++;
        },
        refreshResourceTree() {
          this.resourceTreeKey++;
          this.selectedResourcePath = '';
        },
        handleResourceNodeExpand(data, node) {
          // 需求：用户可以反复点击目录前的小三角按钮去刷新当前目录下有哪些文件
          // 通过重置 loaded 状态并手动触发 loadData 实现实时刷新
          node.loaded = false;
          node.loadData();
        },
        async confirmImportDevice() {
          if (!this.selectedResourcePath) {
            this.$message.warning('请先选择要导入的文件');
            return;
          }

          try {
            const modelzip = this.selectedResourcePath;
            // 提取 project 名：路径的第一级目录名，或者是文件名去掉扩展名
            const parts = modelzip.split('/');
            const project = parts.length > 1 ? parts[0] : modelzip.split('.')[0];

            const allDevices = this.importDeviceType === 'all';

            this.$message.info(`正在准备导入: ${modelzip}...`);

            let resp;
            if (allDevices) {
              // 导入所有设备：不需要 device_id 和 loader_num
              resp = await wsClient.loadModel(null, null, modelzip, project, true);
            } else {
              // 导入当前设备
              resp = await wsClient.loadModel(this.device_id, this.loader_num, modelzip, project, false);
            }

            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && payload.ret === false) throw new Error(payload.desc || 'load_model failed');
            this.$message.success((payload && payload.desc) || `导入指令已发送（${allDevices ? '所有设备' : '当前设备'}）`);
            this.dialogImportDeviceVisible = false;
          } catch (err) {
            this.$message.error('导入失败: ' + (err.message || err));
          }
        },
        async handleDownloadCloudModel() {
          try {
            const p1 = await this.$prompt('请输入 project（工程名）', 'download_cloud_models', {
              confirmButtonText: '下一步',
              cancelButtonText: '取消',
              inputValue: 'project1'
            });
            const project = p1.value;
            const p2 = await this.$prompt('请输入 model_name（云端文件名，如 xxx.zip）', 'download_cloud_models', {
              confirmButtonText: '下一步',
              cancelButtonText: '取消',
              inputValue: 'example.zip'
            });
            const model_name = p2.value;
            const p3 = await this.$prompt('请输入 model_id（整数）', 'download_cloud_models', {
              confirmButtonText: '下载',
              cancelButtonText: '取消',
              inputValue: '0',
              inputPattern: /^\d+$/,
              inputErrorMessage: 'model_id 必须是数字'
            });
            const model_id = Number(p3.value);
            const resp = await wsClient.downloadCloudModels(this.device_id, this.loader_num, model_name, model_id, project);
            const payload = (resp && resp.data !== undefined) ? resp.data : resp;
            if (payload && payload.ret === false) throw new Error(payload.desc || 'download_cloud_models failed');
            this.$message.success((payload && payload.desc) || '云端导入请求已发送');
            // 刷新文件列表
            await this.parseAllFiles();
          } catch (err) {
            if (err && err.message && err !== 'cancel') this.$message.error('云端导入失败: ' + err.message);
          }
        },

        /**
         * 生成bin文件内容
         */
        generateBinContent() {
          if (!this.currentModel || !this.currentModel.modules) return '';
          let content = '';
          for (const mod of this.currentModel.modules) {
            content += `${mod.name}\n`;
            for (const param of mod.params) {
              if (param.type === 'matrix') {
                content += `${param.name}:\n`;
                for (const row of param.value) {
                  content += `    ${row.join(' ')}\n`;
                }
              } else if (param.type === 'array') {
                content += `${param.name}:${param.value.join(' ')}\n`;
              } else {
                content += `${param.name}:${param.value}\n`;
              }
            }
            content += '\n';
          }
          // 需求：内容结尾新增一行 "END" 作为结束符号
          content += 'END\n';
          return content;
        },

        // ============================================================
        // WebSocket 相关方法
        // ============================================================

        /**
         * 初始化 WebSocket 连接
         */
        initWebSocket() {
          const self = this;

          // 监听连接事件
          wsClient.on('connected', () => {
            self.wsConnected = true;
            self.$message.success('WebSocket 已连接');
            // 连接后：拉取实验室列表 + 启动状态上报推送 + 拉寄存器定义
            self.loadLocationInfo();
            wsClient.startGetConnectStatus().catch(() => { });
            self.lastConnectStatusTime = Date.now(); // 初始化时间戳
            self.hasRequestedConnectStatus = false; // 重置请求标志
            self.loadRegisterSheets(); // 先加载 Sheet 配置
            self.loadRegisterDefinitions()
              .then(() => self.refreshDeviceInfoFromSignals());

            // 启动 get_connect_status 监控定时器
            self.startConnectStatusMonitor();
          });

          wsClient.on('disconnected', () => {
            self.wsConnected = false;
            self.$message.warning('WebSocket 连接已断开');
            // 清除监控定时器
            self.stopConnectStatusMonitor();
            // 断开连接时将所有设备状态置灰
            self.markAllDevicesAsDisconnected();
          });

          wsClient.on('reconnectFailed', () => {
            self.$message.error('WebSocket 重连失败，请检查服务器');
          });

          wsClient.on('error', (err) => {
            console.error('[WS] 错误:', err);
          });

          // 监听定时寄存器刷新推送（socket.md：name=refresh_signals，第31条）
          wsClient.on('refresh_signals', (data) => {
            // 处理定时刷新的寄存器值推送
            try {
              const signals = Array.isArray(data) ? data : (data && Array.isArray(data.data) ? data.data : []);
              if (signals.length > 0) {
                const m = self.signalsToMap(signals);
                // 更新当前活动页签的寄存器值
                const currentSheet = self.registerSheets.find(s => s.id === self.activeSheetId);
                if (currentSheet && self.activePage === 'register') {
                  const names = currentSheet.id === 'root' ? self.registers.map(r => r.name) : currentSheet.registerNames;
                  self.registers.forEach(reg => {
                    if (names.includes(reg.name) && m.has(reg.name)) {
                      reg.value = m.get(reg.name);
                      reg.readError = false;
                    }
                  });
                }
              }
            } catch (err) {
              console.warn('[UI] refresh_signals handler error:', err);
            }
          });

          // 监听设备状态推送
          wsClient.on('device.statusUpdate', (data) => {
            self.handleDeviceStatusUpdate(data);
          });

          // 监听寄存器变化推送
          wsClient.on('register.changed', (data) => {
            self.handleRegisterChanged(data);
          });

          // 监听 loader 连接/运行状态推送（socket.md：name=get_connect_status）
          wsClient.on('get_connect_status', (data) => {
            self.connectStatus = data || {};
            // 更新最后收到消息的时间戳
            self.lastConnectStatusTime = Date.now();
            // 收到消息后重置请求标志
            self.hasRequestedConnectStatus = false;

            // 自动选中第一个设备（仅在尚未选中时）
            try {
              if (!self.selectedDeviceKey) {
                // 新格式: { lab: [ { ip, port, value: [device,...] }, ... ] }
                const firstLab = self.connectStatus && typeof self.connectStatus === 'object' ? Object.values(self.connectStatus)[0] : null;
                const cabinets = Array.isArray(firstLab) ? firstLab : [];
                let found = false;

                for (const cab of cabinets) {
                  const devices = Array.isArray(cab.value) ? cab.value : [];
                  if (devices.length > 0) {
                    const d = devices[0];
                    if (d && d.ip !== undefined && d.loader_num !== undefined) {
                      self.device_id = String(d.ip);
                      self.loader_num = Number(d.loader_num);
                      self.selectedDeviceKey = `${String(d.ip)}#${Number(d.loader_num)}`;
                      found = true;
                      break;
                    }
                  } else if (cab && cab.ip !== undefined && cab.loader_num !== undefined) {
                    // 兼容旧格式推送
                    self.device_id = String(cab.ip);
                    self.loader_num = Number(cab.loader_num);
                    self.selectedDeviceKey = `${String(cab.ip)}#${Number(cab.loader_num)}`;
                    found = true;
                    break;
                  }
                }
              }
            } catch (e) {
              console.warn('[UI] Auto-select failed:', e);
            }

            // 每次状态推送后，同步当前选中设备的连接/运行显示，避免默认值误判
            try {
              const entry = self.currentDeviceEntry;
              if (entry) {
                self.deviceConnected = !!entry.connect;
                // 使用统一的方法从推送消息中同步设备信息
                self.syncDeviceInfoFromStatus(entry);
              } else {
                self.deviceConnected = false;
                self.isModelRunning = false;
                self.runningFile = '';
              }
            } catch (e) {
              console.warn('[UI] Status sync failed:', e);
            }
          });

          // OTA 进度推送（socket.md 15）
          wsClient.on('update_ota_progress', (data) => {
            try {
              const ip = data && (data.ip || data.device_id);
              const loader_num = data && data.loader_num;
              const p = Number(data && data.progress);
              if (ip === undefined || loader_num === undefined) return;
              const k = self.otaKey(ip, loader_num);
              if (Number.isFinite(p)) self.$set(self.otaProgress, k, p);
              self.$set(self.otaStatus, k, { status: 'running', desc: `升级中… ${Number.isFinite(p) ? p.toFixed(1) : ''}%` });
            } catch (e) { }
          });

          // OTA 最终结果（文档里 name=update_loaders）
          wsClient.on('update_loaders', (data) => {
            try {
              const ip = data && (data.ip || data.device_id);
              const loader_num = data && data.loader_num;
              if (ip === undefined || loader_num === undefined) return;
              const k = self.otaKey(ip, loader_num);
              const st = data && data.loader_ota_status ? String(data.loader_ota_status) : '';
              const ok = st.toLowerCase() === 'success';
              self.$set(self.otaProgress, k, ok ? 100 : (self.otaProgress[k] || 0));
              self.$set(self.otaStatus, k, { status: ok ? 'success' : 'error', desc: (data && data.desc) || st || (ok ? 'success' : 'failed') });
              // 清除升级标记
              if (self.otaUpdatingKey === k) {
                self.otaUpdatingKey = '';
              }
            } catch (e) { }
          });

          // 尝试连接（静默失败，因为可能没有服务器）
          wsClient.connect().catch(err => {
            console.log('[WS] 初始连接失败，使用模拟模式');
          });
        },

        /**
         * 启动 get_connect_status 监控定时器
         * 每10秒检查一次，如果超过10秒没收到消息，主动请求一次
         */
        startConnectStatusMonitor() {
          this.stopConnectStatusMonitor(); // 先清除旧的定时器

          this.connectStatusCheckTimer = setInterval(() => {
            this.checkConnectStatus();
          }, 10000); // 每10秒检查一次
        },

        /**
         * 停止 get_connect_status 监控定时器
         */
        stopConnectStatusMonitor() {
          if (this.connectStatusCheckTimer) {
            clearInterval(this.connectStatusCheckTimer);
            this.connectStatusCheckTimer = null;
          }
        },

        /**
         * 检查 get_connect_status 是否超时
         * 如果超过10秒没收到消息，主动请求一次（只请求一次，避免不停请求）
         */
        async checkConnectStatus() {
          if (!this.wsConnected) return;

          const now = Date.now();
          const timeSinceLastMessage = now - this.lastConnectStatusTime;

          // 如果超过10秒没收到消息，且还没请求过，主动请求一次
          if (timeSinceLastMessage > 10000 && !this.hasRequestedConnectStatus) {
            console.log('[WS] get_connect_status 超时，主动请求一次');
            this.hasRequestedConnectStatus = true;
            try {
              await wsClient.startGetConnectStatus();
              // 等待3秒，如果还没收到消息，则认为异常
              setTimeout(() => {
                const stillTimeout = Date.now() - this.lastConnectStatusTime > 13000;
                if (stillTimeout && this.wsConnected) {
                  console.warn('[WS] get_connect_status 请求后仍无响应，将设备状态置灰');
                  this.markAllDevicesAsDisconnected();
                }
              }, 3000);
            } catch (err) {
              console.error('[WS] get_connect_status 请求失败:', err);
              this.markAllDevicesAsDisconnected();
            }
          }
        },

        /**
         * 将所有设备状态置灰（表示未连接）
         */
        markAllDevicesAsDisconnected() {
          // 更新 connectStatus，将所有设备的 connect 设为 false
          if (this.connectStatus && typeof this.connectStatus === 'object') {
            const updatedStatus = {};
            for (const [labKey, cabinets] of Object.entries(this.connectStatus)) {
              updatedStatus[labKey] = cabinets.map(cab => {
                if (Array.isArray(cab.value)) {
                  // 新格式：有 value 数组
                  return {
                    ...cab,
                    value: cab.value.map(dev => ({
                      ...dev,
                      connect: false
                    }))
                  };
                } else {
                  // 旧格式：直接是设备对象
                  return {
                    ...cab,
                    connect: false
                  };
                }
              });
            }
            this.connectStatus = updatedStatus;
          }

          // 更新当前选中设备的状态
          const entry = this.currentDeviceEntry;
          if (entry) {
            this.deviceConnected = false;
            this.isModelRunning = false;
            this.runningFile = '';
          }
        },

        /**
         * 处理设备状态更新推送
         */
        handleDeviceStatusUpdate(data) {
          if (data.connected !== undefined) this.deviceConnected = data.connected;
          if (data.running_file) {
            this.runningFile = data.running_file;
            // 如果推送中没有明确提供 running_module，则从路径中提取
            if (!data.running_module) {
              const parts = String(data.running_file).split(/[\/\\]/);
              this.runningModule = parts[parts.length - 1];
            }
          }
          if (data.running_module) this.runningModule = data.running_module;
          if (data.current !== undefined) this.realtimeData.current = data.current;
          if (data.voltage !== undefined) this.realtimeData.voltage = data.voltage;
          if (data.power !== undefined) this.realtimeData.power = data.power;
          if (data.temperature !== undefined) this.realtimeData.temperature = data.temperature;
        },

        /**
         * 处理寄存器变化推送
         */
        handleRegisterChanged(data) {
          const reg = this.registers.find(r => r.address === data.address);
          if (reg) {
            reg.value = data.value;
            reg.modified = true;
            setTimeout(() => { reg.modified = false; }, 3000);
          }
        },

        /**
         * 检查WebSocket是否可用，否则使用模拟模式
         */
        async wsRequest(action, fallback) {
          if (this.wsConnected) {
            try {
              return await wsClient.request(action.name, action.params);
            } catch (err) {
              console.error('[WS] 请求失败:', err);
              this.$message.error('通信失败: ' + err.message);
              throw err;
            }
          } else {
            // 模拟模式
            console.log('[模拟] ' + action.name, action.params);
            return fallback ? fallback() : { success: true };
          }
        },
        /**
         * 初始化悬浮面板拖拽逻辑
         */
        initFloatingPanelDrag() {
          const panel = document.getElementById('floating-panel');
          const handle = panel.querySelector('.drag-handle');
          let isDragging = false;
          let startY = 0;
          let startTop = 0;

          handle.onmousedown = (e) => {
            isDragging = true;
            startY = e.clientY;
            startTop = panel.offsetTop;
            document.body.style.cursor = 'grabbing';
            panel.style.transition = 'none'; // 拖拽时禁用过渡
          };

          window.onmousemove = (e) => {
            if (!isDragging) return;
            const deltaY = e.clientY - startY;
            let newTop = startTop + deltaY;

            // 限制拖拽范围
            const minTop = 50;
            const maxTop = window.innerHeight - panel.offsetHeight - 50;
            newTop = Math.max(minTop, Math.min(maxTop, newTop));

            panel.style.top = `${newTop}px`;
            panel.style.transform = 'none'; // 拖拽后清除居中定位偏移
          };

          window.onmouseup = () => {
            if (!isDragging) return;
            isDragging = false;
            document.body.style.cursor = '';
            panel.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
          };
        }
      },
      mounted() {
        // 先加载模型字典，再加载模型列表
        this.loadModelDictionary().finally(() => this.parseAllFiles());
        const runningIndex = this.models.findIndex(m => m.filename === this.runningFile);
        if (runningIndex !== -1) this.selectModel(runningIndex);

        // 初始化 WebSocket 连接
        this.initWebSocket();

        // 无 WebSocket 时也能通过 HTTP 拉取寄存器定义
        this.loadRegisterDefinitions();

        // 初次加载模型列表（用于顶部横栏下拉框）
        // 连接上 WS 后也可手动点“刷新”再次拉取
        this.refreshModelOptions();

        // 加载设备规格配置
        this.loadDeviceSpecsConfig();

        // 初始化悬浮面板拖拽
        this.$nextTick(() => {
          this.initFloatingPanelDrag();
        });

        // 页面刷新时额外请求一次 get_connect_status
        window.addEventListener('beforeunload', (e) => {
          if (this.hasModified) {
            const msg = '当前文件有未保存的修改，刷新或关闭页面将丢失修改，是否继续？';
            e.returnValue = msg;
            return msg;
          }
          if (this.wsConnected) {
            // 页面刷新时请求一次状态
            wsClient.startGetConnectStatus().catch(() => { });
            // 调用 stop_all_timers 关闭后端定时器
            wsClient.stopAllTimers().catch(() => { });
          }
          // 清除前端定时器
          this.stopConnectStatusMonitor();
        });
      },
      beforeDestroy() {
        // 组件销毁时清除定时器
        this.stopConnectStatusMonitor();
        // 调用 stop_all_timers 关闭后端定时器
        if (this.wsConnected) {
          wsClient.stopAllTimers().catch(() => { });
        }
      }
    });
  </script>
</body>

</html>