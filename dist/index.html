<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>电子负载上位机</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.14/lib/theme-chalk/index.css"><script src="https://unpkg.com/vue@2.7.14/dist/vue.min.js"></script><script src="https://unpkg.com/element-ui@2.15.14/lib/index.js"></script><style>:root{--primary-color:#2563eb;--primary-dark:#1d4ed8;--primary-light:#3b82f6;--primary-bg:rgba(37, 99, 235, 0.08);--success-color:#10b981;--warning-color:#f59e0b;--error-color:#ef4444;--info-color:#6366f1;--running-color:#8b5cf6;--bg-page:#f8fafc;--bg-white:#ffffff;--bg-gray:#f1f5f9;--bg-hover:#e2e8f0;--text-primary:#1e293b;--text-secondary:#64748b;--text-muted:#94a3b8;--border-color:#e2e8f0;--border-light:#f1f5f9;--shadow-sm:0 1px 2px rgba(0, 0, 0, 0.05);--shadow-md:0 4px 6px -1px rgba(0, 0, 0, 0.1);--font-sans:'Noto Sans SC',-apple-system,sans-serif;--font-mono:'JetBrains Mono',monospace;--sidebar-width:350px;--toolbar-height:52px}*,::after,::before{box-sizing:border-box;margin:0;padding:0}body,html{height:100%;font-family:var(--font-sans);font-size:14px;color:var(--text-primary);background:var(--bg-page)}#app{height:100%}.app-layout{display:flex;height:100%}.device-sidebar{width:var(--sidebar-width);background:var(--bg-white);border-right:1px solid var(--border-color);display:flex;flex-direction:column;flex-shrink:0}.sidebar-header{height:var(--toolbar-height);padding:0 16px;border-bottom:1px solid var(--border-color);font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px;box-sizing:border-box}.sidebar-title{font-size:15px;font-weight:600;color:var(--text-primary);user-select:none}.ws-indicator{width:8px;height:8px;border-radius:50%;background:var(--text-muted);margin-left:auto;transition:all .3s}.ws-indicator.connected{background:var(--success-color);box-shadow:0 0 6px var(--success-color)}.sidebar-section{padding:12px 12px 8px;border-bottom:1px solid var(--border-color)}.sidebar-section .section-title{font-size:12px;color:var(--text-secondary);margin-bottom:6px}.sidebar-scroll{flex:1;overflow:auto;padding:12px}.empty-hint{padding:14px 12px;border:1px dashed var(--border-color);border-radius:10px;background:var(--bg-gray);color:var(--text-secondary);text-align:center;font-size:12px}.empty-hint .muted{margin-top:4px;color:var(--text-muted);font-size:11px}.lab-block{margin-bottom:14px}.lab-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;font-size:12px;color:var(--text-secondary)}.lab-name{font-weight:600;color:var(--text-primary)}.lab-count{font-size:11px;color:var(--text-muted)}.cabinet-card{border:1px solid var(--border-color);border-radius:12px;background:var(--bg-white);overflow:hidden;margin-bottom:0;box-shadow:var(--shadow-sm)}.cabinet-img{position:relative;background:var(--bg-gray);padding:10px;border-bottom:1px solid var(--border-color)}.cabinet-img img{width:100%;height:120px;object-fit:cover;border-radius:10px;display:block}.cabinet-ip{position:absolute;top:14px;left:14px;font-family:var(--font-mono);font-size:11px;color:var(--text-primary);background:rgba(255,255,255,.9);border:1px solid var(--border-color);padding:2px 6px;border-radius:6px}.cabinet-block{margin-bottom:12px}.cabinet-stack{position:relative;height:190px;margin-top:8px}.cabinet-frame{position:absolute;inset:0;border-radius:12px;overflow:hidden;border:1px solid var(--border-color);background:var(--bg-gray);box-shadow:var(--shadow-sm);display:grid;grid-template-rows:44px 34px 1fr}.cabinet-frame-bg{position:absolute;inset:0;z-index:0}.cabinet-frame-bg img{width:100%;height:100%;object-fit:cover;display:block}.cabinet-row{position:relative;z-index:1;display:flex;align-items:center;padding:0 10px;border-bottom:1px solid rgba(226,232,240,.8);gap:8px}.cabinet-row.logo{background-color:#e2e8f0;border-bottom:1px solid rgba(31,41,55,.2)}.cabinet-row.ip{background:rgba(241,245,249,.95)}.cabinet-logo{height:22px;width:auto;display:block}.cabinet-ip-text{font-family:var(--font-mono);font-size:12px;color:var(--text-primary)}.cabinet-body{position:relative;z-index:1;padding:8px 10px 10px}.cabinet-device-grid{width:100%;height:100%;display:grid;grid-template-columns:repeat(6,1fr);gap:2px;align-items:end}.device-item{text-align:center;cursor:pointer}.device-pic{position:relative;height:78px;margin:0 auto}.device-item.selected .device-pic{border-radius:10px;box-shadow:0 0 0 2px rgba(37,99,235,.55),0 8px 18px rgba(37,99,235,.18);background:rgba(37,99,235,.06)}.device-item.selected .device-model{color:var(--primary-color);font-weight:600}.device-pic img{width:100%;height:100%;object-fit:contain;display:block}.rgb-dot{position:absolute;bottom:6px;right:6px;width:10px;height:10px;border-radius:50%;background:#94a3b8;box-shadow:none;border:2px solid rgba(255,255,255,.95);outline:1px solid rgba(0,0,0,.18)}.rgb-dot.connected{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.55)}.rgb-dot.running{background:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,.55)}.rgb-dot.alarm{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,.55)}.rgb-dot.upgrading{animation:ota-blink .5s infinite}@keyframes ota-blink{0%,50%{background:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,.55)}25%,75%{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,.55)}}.device-index{position:absolute;bottom:4px;left:4px;font-family:var(--font-mono);font-size:11px;color:#fff;background:rgba(15,23,42,.75);padding:1px 5px;border-radius:6px}.device-model{width:100%;word-break:break-all;margin-top:4px;font-size:10px;color:var(--text-secondary);white-space:normal;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.2;min-height:calc(1.2em * 2)}.device-card{margin:12px;background:linear-gradient(135deg,#f8fafc 0,#e2e8f0 100%);border:1px solid var(--border-color);border-radius:10px;overflow:hidden}.device-visual{height:140px;background:linear-gradient(180deg,#dbeafe 0,#bfdbfe 100%);display:flex;align-items:center;justify-content:center;position:relative}.device-image{width:120px;height:90px;background:linear-gradient(145deg,#374151 0,#1f2937 100%);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 6px 12px rgba(0,0,0,.2)}.device-screen{width:80px;height:36px;background:#000;border-radius:3px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-size:14px;color:#0f8;text-shadow:0 0 8px #0f8}.device-leds{display:flex;gap:6px}.led{width:6px;height:6px;border-radius:50%;background:#333}.led.power{background:var(--success-color);box-shadow:0 0 6px var(--success-color)}.led.run{background:var(--primary-light);box-shadow:0 0 6px var(--primary-light);animation:blink 1s infinite}@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}.device-info{padding:12px}.device-name{font-size:14px;font-weight:600;margin-bottom:6px}.device-sn{font-size:11px;color:var(--primary-color);font-family:var(--font-mono);background:var(--primary-bg);padding:2px 6px;border-radius:4px;display:inline-block;margin-bottom:8px}.device-meta{font-size:12px;color:var(--text-muted)}.meta-row{display:flex;justify-content:space-between;padding:2px 0}.meta-value{font-family:var(--font-mono);color:var(--text-secondary)}.connection-status{margin:0 12px 12px;padding:10px 12px;background:var(--bg-gray);border-radius:6px;display:flex;align-items:center;gap:8px}.status-indicator{width:8px;height:8px;border-radius:50%;background:var(--text-muted)}.status-indicator.connected{background:var(--success-color);box-shadow:0 0 6px var(--success-color)}.status-text{flex:1}.status-title{font-size:12px;font-weight:500}.status-desc{font-size:10px;color:var(--text-muted)}.connect-btn{margin:0 12px 12px}.connect-btn .el-button{width:100%}.running-model{margin:0 12px 12px;padding:10px 12px;background:linear-gradient(135deg,rgba(139,92,246,.1) 0,rgba(139,92,246,.05) 100%);border:1px solid rgba(139,92,246,.3);border-radius:6px}.running-model-header{display:flex;align-items:center;gap:6px;margin-bottom:8px}.running-model-header i{color:var(--running-color);animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}.running-model-title{font-size:11px;font-weight:500;color:var(--running-color)}.running-model-info{font-size:12px}.running-file{font-family:var(--font-mono);color:var(--text-primary);font-weight:500}.running-module{font-size:11px;color:var(--text-secondary);margin-top:2px}.run-status{margin:0 12px 12px;padding:10px;border:1px solid var(--border-color);border-radius:6px}.run-status-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:12px}.run-badge{padding:2px 6px;border-radius:8px;font-size:10px;font-weight:500}.run-badge.running{background:rgba(16,185,129,.1);color:var(--success-color)}.run-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}.stat-box{background:var(--bg-gray);padding:6px;border-radius:4px;text-align:center}.stat-value{font-size:14px;font-weight:600;font-family:var(--font-mono)}.stat-label{font-size:9px;color:var(--text-muted)}.main-area{flex:1;display:flex;flex-direction:column;min-width:0}.toolbar-title{font-size:16px;font-weight:600;margin-right:20px}.content-area{flex:1;display:flex;flex-direction:column;padding:16px 20px;overflow:hidden}.upgrade-panel{background:var(--bg-white);border:1px solid var(--border-color);border-radius:12px;box-shadow:var(--shadow-sm);padding:14px;overflow:hidden;display:flex;flex-direction:column;gap:12px}.upgrade-toolbar{display:flex;align-items:center;justify-content:space-between;gap:10px}.upgrade-title{font-size:14px;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:8px}.upgrade-hint{font-size:12px;color:var(--text-muted)}.upgrade-list{flex:1;overflow:auto;border-top:1px solid var(--border-light);padding-top:10px}.ota-ip-block{margin-bottom:14px}.ota-ip-header{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:8px}.ota-ip{font-family:var(--font-mono);font-size:12px;color:var(--text-primary);font-weight:700}.ota-device-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}.ota-device-card{border:1px solid var(--border-color);border-radius:10px;background:#fff;padding:10px;display:flex;flex-direction:column;gap:8px}.ota-row{display:flex;align-items:center;justify-content:space-between;gap:8px}.ota-name{font-weight:700;font-size:12px;color:var(--text-primary)}.ota-meta{font-size:11px;color:var(--text-secondary);font-family:var(--font-mono)}.ota-status{font-size:11px;color:var(--text-muted)}.page-tabs{display:flex;gap:4px;margin-bottom:12px;background:var(--bg-white);padding:3px;border-radius:8px;width:fit-content;box-shadow:var(--shadow-sm)}.page-tab{padding:6px 16px;font-size:12px;font-weight:500;color:var(--text-secondary);background:0 0;border:none;border-radius:5px;cursor:pointer;transition:all .2s}.page-tab:hover{color:var(--text-primary);background:var(--bg-gray)}.page-tab.active{color:var(--primary-color);background:var(--primary-bg)}.page-content{flex:1;background:var(--bg-white);border-radius:10px;box-shadow:var(--shadow-sm);overflow:hidden;display:none}.page-content.active{display:flex;flex-direction:column}.page-header{padding:12px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}.page-title{font-size:15px;font-weight:600}.btn-group{display:flex;gap:8px;align-items:center}.btn-divider{width:1px;height:20px;background:var(--border-color);margin:0 4px}.action-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;font-size:12px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-white);color:var(--text-secondary);cursor:pointer;transition:all .2s}.action-btn:hover{border-color:var(--primary-color);color:var(--primary-color);background:var(--primary-bg)}.action-btn.primary{background:var(--primary-color);border-color:var(--primary-color);color:#fff}.action-btn.primary:hover{background:var(--primary-dark)}.action-btn.success{background:var(--success-color);border-color:var(--success-color);color:#fff}.action-btn.success:hover{background:#059669}.action-btn:disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.action-btn i{font-size:14px}.page-body{flex:1;padding:16px 20px;overflow-y:auto}.model-layout{display:flex;gap:16px;height:100%}.model-list{width:220px;flex-shrink:0;border-right:1px solid var(--border-color);padding-right:16px;display:flex;flex-direction:column}.model-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:12px;font-weight:600;color:var(--text-secondary)}.sn-badge{font-size:10px;font-family:var(--font-mono);color:var(--primary-color);background:var(--primary-bg);padding:2px 6px;border-radius:4px}.model-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:all .2s;margin-bottom:4px;border:1px solid transparent;position:relative}.model-item:hover{background:var(--bg-gray)}.model-item.active{background:var(--primary-bg);border-color:var(--primary-color)}.model-item.has-error{border-color:var(--error-color);background:rgba(239,68,68,.05)}.model-item.is-running{background:linear-gradient(135deg,rgba(139,92,246,.15) 0,rgba(139,92,246,.08) 100%);border-color:var(--running-color)}.model-item.is-running .model-item-name{color:var(--running-color);font-weight:600}.model-item.is-running::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--running-color);border-radius:3px 0 0 3px}.model-item.drag-over{border:2px dashed var(--primary-color);background:var(--primary-bg)}.model-item i{color:var(--text-muted);font-size:16px}.model-item.active i{color:var(--primary-color)}.model-item.is-running i{color:var(--running-color)}.model-item-info{flex:1;min-width:0}.model-item-name{font-size:12px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.model-item-size{font-size:10px;color:var(--text-muted)}.model-item-badge{font-size:10px;padding:2px 6px;border-radius:4px}.model-item-badge.running{color:var(--running-color);background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.15);font-weight:500;display:flex;align-items:center;gap:3px;white-space:nowrap;flex-shrink:0}.model-item-badge.running i{font-size:12px;animation:blink 1.5s infinite}.model-item-btns,.module-btns{display:none;margin-left:4px}.model-item:hover .model-item-btns,.module-header:hover .module-btns{display:block}.delete-btn{color:var(--error-color)!important;padding:0!important}.delete-btn:hover{color:#fecaca!important}.model-editor{flex:1;display:flex;flex-direction:column;min-width:0}.editor-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border-color)}.editor-filename{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:500}.editor-filename i{color:var(--primary-color)}.modified-dot{width:8px;height:8px;border-radius:50%;background:var(--warning-color)}.module-section{margin-bottom:16px;border:1px solid var(--border-color);border-radius:8px;overflow:hidden}.module-section.is-running{border-color:var(--running-color);box-shadow:0 0 0 1px rgba(139,92,246,.2)}.module-header{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-gray);cursor:pointer;transition:background .2s}.module-section.is-running .module-header{background:linear-gradient(135deg,rgba(139,92,246,.15) 0,rgba(139,92,246,.08) 100%)}.module-header:hover{background:var(--bg-hover)}.module-toggle{width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:transform .2s}.module-toggle.expanded{transform:rotate(90deg)}.module-info{flex:1}.module-name-row{display:flex;align-items:center;gap:8px}.module-name{font-size:13px;font-weight:600;font-family:var(--font-mono);color:var(--primary-color)}.module-section.is-running .module-name{color:var(--running-color)}.module-name-cn{font-size:12px;color:var(--text-secondary);font-weight:400}.module-desc{font-size:11px;color:var(--text-muted);margin-top:2px}.module-count{font-size:11px;color:var(--text-muted);background:var(--bg-white);padding:2px 8px;border-radius:10px}.running-indicator{display:flex;align-items:center;gap:4px;font-size:10px;color:#fff;background:var(--running-color);padding:2px 10px;border-radius:12px;font-weight:500;box-shadow:0 2px 6px rgba(139,92,246,.3)}.running-indicator i{animation:blink 1s infinite}.module-body{display:none;padding:16px 20px}.module-body.expanded{display:block}.param-row{display:grid;grid-template-columns:1fr 200px 20px;gap:20px;align-items:start;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid transparent;background:var(--bg-white);box-shadow:0 1px 3px rgba(0,0,0,.02);transition:all .2s}.param-row:hover{background:#fcfaff;border-color:var(--primary-light);box-shadow:0 2px 8px rgba(139,92,246,.08)}.param-label-section{display:flex;flex-direction:column;gap:6px;padding-top:4px}.param-name-row{display:flex;flex-wrap:wrap;align-items:center;gap:8px}.param-key{font-size:13px;color:var(--text-primary);font-family:var(--font-mono);font-weight:600;word-break:break-all}.param-name-cn{font-size:11px;color:var(--primary-color);background:rgba(139,92,246,.1);padding:2px 8px;border-radius:4px}.param-desc{font-size:11px;color:var(--text-muted);line-height:1.5;margin-top:2px}.param-range{font-size:11px;color:var(--text-secondary);font-family:var(--font-mono);display:flex;align-items:center;gap:6px;margin-top:4px;background:#f0fdf4;padding:2px 8px;border-radius:4px;width:fit-content}.param-range i{font-size:12px;color:var(--success-color)}.param-input-section{display:flex;flex-direction:column;gap:8px;min-width:0}.param-actions{display:flex;align-items:center;height:28px;justify-content:center}.param-actions .delete-btn{color:#909399;padding:5px;transition:all .2s}.param-actions .delete-btn:hover{color:var(--error-color);background:rgba(239,68,68,.05);border-radius:4px}.param-input-row{display:flex;align-items:center;gap:12px;width:100%}.param-input-row .el-input,.param-input-row .el-input-number{flex:1;max-width:320px;min-width:150px}.param-unit{font-size:12px;color:var(--text-secondary);font-family:var(--font-mono);min-width:45px}.param-type-badge{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg-gray);color:var(--text-muted);text-transform:uppercase}.param-row.out-of-range{border-color:var(--warning-color);background:rgba(245,158,11,.05)}.range-warning{font-size:10px;color:var(--warning-color);display:flex;align-items:center;gap:4px}.array-display{background:var(--bg-gray);border-radius:6px;padding:10px;width:100%}.array-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border-color)}.array-label{font-size:11px;color:var(--text-muted);font-family:var(--font-mono)}.array-items{display:flex;flex-wrap:wrap;gap:6px}.array-item{display:flex;align-items:center;gap:4px;background:var(--bg-white);padding:4px 6px;border-radius:4px;border:1px solid var(--border-color)}.array-index{font-size:10px;color:var(--text-muted);font-family:var(--font-mono);min-width:24px}.array-item .el-input-number{width:120px}.array-item .el-input{width:110px}.array-item .el-button{padding:2px;color:var(--text-muted)}.array-item .el-button:hover{color:var(--error-color)}.matrix-display{background:var(--bg-gray);border-radius:6px;padding:10px;width:100%}.matrix-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border-color)}.matrix-size{font-size:11px;color:var(--text-muted);font-family:var(--font-mono)}.matrix-table{overflow-x:auto}.matrix-header{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-color);margin-bottom:6px}.matrix-header-cell{width:80px;text-align:center;font-size:10px;color:var(--text-muted);font-weight:500;flex-shrink:0}.matrix-row{display:flex;gap:8px;padding:4px 0;align-items:center}.matrix-row:hover{background:var(--bg-hover);margin:0 -6px;padding:4px 6px;border-radius:4px}.matrix-row-index{width:24px;font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-align:center;flex-shrink:0}.matrix-cell-input{width:100px!important;flex-shrink:0}.matrix-action-cell{width:24px;flex-shrink:0}.matrix-delete-btn{padding:2px;color:var(--text-muted);opacity:0;transition:opacity .2s}.matrix-row:hover .matrix-delete-btn{opacity:1}.matrix-delete-btn:hover{color:var(--error-color)}.data-path{font-size:11px;color:var(--text-muted);padding:8px 12px;background:var(--bg-gray);border-radius:6px;margin-bottom:12px;font-family:var(--font-mono);display:flex;align-items:center;gap:6px}.data-path i{color:var(--primary-color)}.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--text-muted)}.empty-state i{font-size:48px;margin-bottom:12px}.empty-state p{font-size:13px}.param-unknown{font-size:10px;color:var(--text-muted);font-style:italic}.device-overview-card{display:flex;gap:24px;padding:20px;background:var(--bg-white);border:1px solid var(--border-color);border-radius:12px;margin-bottom:20px}.device-photo{width:200px;height:200px;flex-shrink:0;border-radius:8px;overflow:hidden;position:relative;background:var(--bg-gray);display:flex;justify-content:center;align-items:center;align-self:center}.device-photo img{max-width:100%;max-height:100%;object-fit:contain}.device-photo-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;gap:8px}.device-photo-overlay i{font-size:32px;color:var(--warning-color)}.device-overview-info{flex:1;display:flex;flex-direction:column}.device-overview-content{display:flex;gap:0;flex:1}.device-overview-main{width:180px;flex-shrink:0}.device-overview-side{flex:1;display:flex;flex-direction:column;position:relative}.device-overview-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.device-header-left{display:flex;align-items:center;gap:12px}.device-model-name{font-size:20px;font-weight:600;color:var(--text-primary)}.device-info-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}.info-item{display:flex;flex-direction:column;gap:2px}.info-label{font-size:11px;color:var(--text-muted)}.info-value{font-size:14px;color:var(--text-primary);font-weight:500}.info-value.sn{font-family:var(--font-mono);color:var(--primary-color);background:var(--primary-bg);padding:2px 8px;border-radius:4px;display:inline-block}.info-value.mono{font-family:var(--font-mono)}.info-value.highlight{color:var(--success-color)}.running-model-info{margin-top:-45px;margin-left:-30px;padding:16px 20px;background:linear-gradient(135deg,rgba(37,99,235,.05) 0,rgba(37,99,235,.02) 100%);border:1px solid rgba(37,99,235,.15);border-radius:12px;display:flex;flex-direction:column;height:calc(100% + 45px)}.running-model-flex-container{display:flex;gap:20px;align-items:center;flex:1}.running-model-info.stopped{background:var(--bg-gray);border-color:var(--border-color);justify-content:center;align-items:center;margin-top:0;height:100%}.running-model-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:var(--running-color);color:#fff;border-radius:12px;font-size:11px;font-weight:500;margin-bottom:16px;align-self:flex-start}.running-model-badge i{animation:pulse 2s infinite}.running-model-badge.stopped{background:var(--text-muted);margin-bottom:0;align-self:center}.running-model-badge.stopped i{animation:none}.running-model-detail{display:flex;flex-direction:column;gap:12px;font-size:13px;flex:1}.running-label{color:var(--text-muted);font-size:11px}.running-item{display:flex;flex-direction:column;gap:4px}.running-value{color:var(--text-primary);font-family:var(--font-mono);font-weight:600;word-break:break-all;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.module-part-image,.module-part-placeholder{width:240px;height:180px;flex-shrink:0;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border-color)}.module-part-placeholder{border:1px dashed var(--primary-color);background:rgba(255,255,255,.6);flex-direction:column;color:var(--text-muted);font-size:10px}.module-part-image img{max-width:100%;max-height:100%;object-fit:contain}.module-part-placeholder i{font-size:24px;margin-bottom:6px;color:var(--primary-color)}.realtime-section,.spec-section{margin-bottom:20px}.section-title{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border-color)}.section-title i{color:var(--primary-color)}.spec-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}.spec-card{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-white);border:1px solid var(--border-color);border-radius:10px}.spec-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}.spec-content{display:flex;flex-direction:column}.spec-value{font-size:18px;font-weight:600;color:var(--text-primary);font-family:var(--font-mono)}.spec-label{font-size:11px;color:var(--text-muted)}.realtime-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}.realtime-card{padding:16px;background:var(--bg-white);border:1px solid var(--border-color);border-radius:10px;position:relative}.realtime-value{font-size:28px;font-weight:600;color:var(--text-primary);font-family:var(--font-mono)}.realtime-unit{font-size:14px;color:var(--text-muted);margin-left:4px}.realtime-label{display:block;font-size:12px;color:var(--text-muted);margin-top:4px}.realtime-bar{height:4px;background:var(--bg-gray);border-radius:2px;margin-top:12px;overflow:hidden}.realtime-bar-fill{height:100%;background:var(--primary-color);border-radius:2px;transition:width .3s ease}.register-page{display:flex;flex-direction:column;height:100%}.register-filters{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-color);flex-shrink:0}.register-table-container{flex:1;overflow:auto;margin-top:12px}.register-table{width:100%;border-collapse:collapse;font-size:13px}.register-table thead{position:sticky;top:0;z-index:10}.register-table th{background:var(--bg-gray);color:var(--text-secondary);font-weight:500;text-align:left;padding:8px 10px;border-bottom:2px solid var(--border-color);white-space:nowrap}.register-table td{padding:8px 10px;border-bottom:1px solid var(--border-light);vertical-align:middle}.register-table tr:hover{background:var(--primary-bg)}.register-table tr.reg-modified{background:rgba(245,158,11,.08)}.register-table tr.reg-read-error{background:rgba(239,68,68,.06)}.reg-value.error{color:var(--error-color);font-weight:600}.reg-range{margin-top:4px;font-size:11px;color:var(--text-muted);font-family:var(--font-mono)}.reg-name{font-weight:500;color:var(--text-primary)}.reg-desc{font-size:12px;color:var(--text-muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.reg-value-cell{min-width:180px}.reg-value{font-family:var(--font-mono);padding:4px 8px;border-radius:4px;display:inline-block}.reg-value.readonly{background:var(--bg-gray);color:var(--text-primary)}.reg-input-wrap{display:flex;flex-direction:column;gap:4px}.reg-current-value{font-size:11px;color:var(--text-muted);font-family:var(--font-mono)}.reg-input{padding:6px 10px;border:1px solid var(--border-color);border-radius:4px;font-family:var(--font-mono);font-size:13px;width:100%;min-width:120px;max-width:400px;transition:all .2s}.reg-input:focus{outline:0;border-color:var(--primary-color);box-shadow:0 0 0 2px var(--primary-bg)}.reg-input::placeholder{font-family:var(--font-sans);font-size:12px;color:var(--text-muted)}.reg-actions{white-space:nowrap}.reg-actions .el-button{padding:5px 10px;font-size:12px}.register-stats{display:flex;align-items:center;gap:12px;padding:12px 0;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-muted);flex-shrink:0}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg-gray)}::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}.non-modal-drawer.el-drawer__wrapper{pointer-events:none;z-index:2000}.non-modal-drawer .el-drawer{pointer-events:auto;box-shadow:-2px 0 12px rgba(0,0,0,.1)}.cabinet-device-grid{position:relative;z-index:1}.register-table tr[draggable=true]{cursor:grab}.register-table tr[draggable=true]:active{cursor:grabbing}.register-table tr.drag-over-row{border-top:2px solid var(--primary-color)}.tab-label-zone{display:inline-block;height:100%;padding:0 10px;margin:0 -15px;cursor:pointer;position:relative;transition:all .2s}.tab-label-zone.drag-over-tab{background-color:rgba(var(--primary-rgb),.1);box-shadow:inset 0 -2px 0 var(--primary-color)}.root-tab-label{color:var(--primary-color);font-weight:800!important}.root-tab-label i{margin-right:4px}.el-tabs__item.is-active .root-tab-label{background:#eff6ff;border-radius:4px 4px 0 0}.context-menu{position:fixed;z-index:3000;background:#fff;border:1px solid var(--border-color);border-radius:4px;box-shadow:0 2px 12px rgba(0,0,0,.1);padding:5px 0;min-width:120px}.context-menu-item{padding:8px 12px;font-size:12px;color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:space-between}.context-menu-item:hover{background-color:var(--bg-gray);color:var(--primary-color)}.context-menu-item.danger:hover{background-color:#fef2f2;color:var(--danger-color)}.context-menu-divider{height:1px;background-color:var(--border-color);margin:4px 0}.context-submenu{position:absolute;left:100%;top:0;background:#fff;border:1px solid var(--border-color);border-radius:4px;box-shadow:0 2px 12px rgba(0,0,0,.1);padding:5px 0;display:none;min-width:120px}.context-menu-item:hover>.context-submenu{display:block}.floating-panel{position:fixed;right:8px;top:50%;transform:translateY(-50%);z-index:2000;background:var(--bg-white);border:none;border-radius:30px;box-shadow:-2px 0 8px rgba(0,0,0,.05);display:flex;flex-direction:column;padding:6px 3px;gap:4px;transition:all .3s cubic-bezier(.4,0,.2,1);user-select:none;width:28px}.floating-panel:hover{width:44px;padding:10px 6px;gap:4px;box-shadow:-4px 0 20px rgba(139,92,246,.15)}.floating-item{position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer;width:22px;height:22px;border-radius:4px;transition:all .3s cubic-bezier(.4,0,.2,1);color:var(--text-secondary)}.floating-panel:hover .floating-item{width:32px;height:32px;border-radius:8px}.floating-item:hover{background:var(--primary-bg);color:var(--primary-color)}.floating-item i{font-size:16px;transition:all .3s cubic-bezier(.4,0,.2,1)}.floating-panel:hover .floating-item i{font-size:20px}.floating-item:hover i{transform:scale(1.2)}.floating-item span{position:absolute;right:100%;margin-right:15px;background:rgba(45,45,45,.9);color:#fff;padding:5px 12px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:all .2s cubic-bezier(.4,0,.2,1);transform:translateX(10px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.floating-item:hover span{opacity:1;transform:translateX(0)}.floating-item span::after{content:'';position:absolute;left:100%;top:50%;transform:translateY(-50%);border:6px solid transparent;border-left-color:rgba(45,45,45,.9)}.drag-handle{height:0;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:move;color:var(--text-muted);opacity:0;transition:all .3s ease;background:0 0}.floating-panel:hover .drag-handle{height:24px;opacity:1;margin-top:2px}.drag-handle i{font-size:16px}.el-message{min-width:300px;box-shadow:0 4px 12px rgba(0,0,0,.12);border:none!important}.el-message--success{background-color:#f0fdf4!important}.el-message--error{background-color:#fef2f2!important}.el-message--warning{background-color:#fffbeb!important}.el-message--info{background-color:#f0f9ff!important}.toolbar{height:var(--toolbar-height);background:var(--bg-white);border-bottom:1px solid var(--border-color);display:flex;align-items:center;padding:0 20px;gap:20px;box-sizing:border-box}.toolbar .bar-section{display:flex;align-items:center;gap:12px}.toolbar .bar-divider{width:1px;height:24px;background:var(--border-color)}.toolbar .bar-label{font-size:13px;font-weight:500;color:var(--text-secondary);white-space:nowrap}::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}</style></head><body><div id="app"><div class="app-layout"><aside class="device-sidebar"><div class="sidebar-header"><span class="sidebar-title"><img class="cabinet-logo" src="img/logo.png" alt="logo"></span><el-tooltip :content="wsConnected ? 'WebSocket已连接' : 'WebSocket未连接'" placement="right"><span class="ws-indicator" :class="{ connected: wsConnected }"></span></el-tooltip></div><div class="sidebar-section"><div class="section-title"><span>实验室</span><el-tag v-if="!isLocationRegistered" size="mini" type="danger" effect="plain" style="font-weight:400;transform:scale(.85)">未注册</el-tag></div><div style="display:flex;gap:6px"><el-select v-model="selectedLocation" size="mini" placeholder="请选择实验室" style="flex:1" @change="onLocationChanged"><el-option v-if="selectedLocation === '未设置' && !isLocationRegistered" key="未设置" label="未设置（请选择实验室）" value="未设置" disabled="disabled"></el-option><el-option v-for="loc in locationList" :key="loc" :label="loc" :value="loc"></el-option></el-select><el-button size="mini" type="primary" icon="el-icon-check" circle @click="handleSaveLocation" title="保存实验室位置"></el-button></div></div><div class="sidebar-scroll"><div v-if="!hasConnectStatus" class="empty-hint"><i class="el-icon-info"></i><div>暂无状态数据</div><div class="muted">等待 get_connect_status 推送…</div></div><div v-for="lab in labView" :key="lab.labKey" class="lab-block"><div class="lab-header"><span class="lab-name">{{ lab.labKey }}</span> <span class="lab-count">{{ lab.cabinets.length }} 机箱</span></div><div v-for="cab in lab.cabinets" :key="cab.ip" class="cabinet-block"><div class="cabinet-stack"><div class="cabinet-frame"><div class="cabinet-row ip"><span class="cabinet-ip-text">IP: {{ cab.ip }}</span></div><div class="cabinet-body"><div class="cabinet-device-grid"><div v-for="dev in cab.devices" :key="dev.loader_num" class="device-item" :class="{ selected: isSelectedDevice(dev), disconnected: !toBool(dev.connect) }" @click="selectDevice(dev)" title="单击选中该设备"><div class="device-pic"><img src="img/device.png" alt="device"> <span class="rgb-dot" :class="deviceLedClass(dev)"></span> <span class="device-index">{{ dev.loader_num + 1 }}</span></div><div class="device-model" :title="dev.loader_name || dev.running_model || ''">{{ dev.loader_name || dev.running_model || '—' }}</div></div></div></div></div></div></div></div></div></aside><div class="main-area"><div class="toolbar"><div class="bar-section" style="flex:1"><span class="bar-label">模型选择</span><el-cascader v-model="selectedModelPath" :options="modelOptions" :props="{ expandTrigger: 'hover' }" size="mini" clearable placeholder="请选择项目/模型" style="width:280px"></el-cascader><el-button size="mini" icon="el-icon-refresh" @click="refreshModelOptions" :loading="modelOptionsLoading">刷新</el-button><el-radio-group v-model="runMode" size="mini" style="margin-left:10px" :disabled="isModelRunning"><el-radio-button label="model">模型</el-radio-button><el-radio-button label="regen">回灌</el-radio-button></el-radio-group></div><div class="bar-divider"></div><div class="bar-section"><el-button size="mini" type="success" icon="el-icon-video-play" @click="startSelectedModel" :disabled="!canStartSelected">启动</el-button><el-button size="mini" type="danger" icon="el-icon-video-pause" @click="stopSelectedModel" :disabled="!canStopSelected">停止</el-button></div></div><div class="content-area"><div class="page-tabs"><button class="page-tab" :class="{ active: activePage === 'info' }" @click="switchPage('info')">设备信息</button> <button class="page-tab" :class="{ active: activePage === 'model' }" @click="switchPage('model')">参数编辑</button> <button class="page-tab" :class="{ active: activePage === 'register' }" @click="switchPage('register')">寄存器管理</button></div><el-dialog title="模型管理" :visible.sync="dialogModelVisible" width="520px"><div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px"><div style="color:var(--text-muted);font-size:12px">设备文件根目录下的 project1/project2… 会在这里展示（log 文件夹不展示在模型管理里）。</div><el-button size="mini" icon="el-icon-refresh" @click="loadModelTree" :loading="modelTreeLoading" :disabled="!wsConnected">刷新</el-button></div><el-tree v-if="modelTreeData && modelTreeData.length" :data="modelTreeData" node-key="label" :props="{ label: 'label', children: 'children' }" :default-expand-all="false" accordion></el-tree><div v-else style="color:var(--text-muted);font-size:12px">{{ wsConnected ? (modelTreeLoading ? '加载中…' : '暂无项目目录') : 'WebSocket 未连接' }}</div><span slot="footer" class="dialog-footer"><el-button size="mini" @click="dialogModelVisible = false">关闭</el-button></span></el-dialog><el-dialog title="日志拉取" :visible.sync="dialogLogVisible" width="650px"><div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px"><div style="color:var(--text-muted);font-size:12px">仅展示设备 log 目录下的日志文件。</div><el-button size="mini" icon="el-icon-refresh" @click="loadLogTree" :loading="logTreeLoading" :disabled="!wsConnected">刷新</el-button></div><div v-if="logTreeData && logTreeData.length" style="max-height:500px;overflow-y:auto;border:1px solid var(--border-color);border-radius:4px;padding:10px"><el-tree :data="logTreeData" node-key="label" :props="{ label: 'label', children: 'children' }" :default-expand-all="true" :expand-on-click-node="true" highlight-current><span slot-scope="{ node, data }" style="display:flex;align-items:center;justify-content:space-between;width:100%;padding-right:10px"><span><i :class="data.children && data.children.length ? 'el-icon-folder' : 'el-icon-document'" style="margin-right:8px;color:var(--text-muted)"></i> {{ data.label }} </span><span><el-button v-if="!data.children || data.children.length === 0" type="text" size="mini" icon="el-icon-download" @click.stop="handlePullLog(data, node)">下载</el-button><el-button type="text" size="mini" icon="el-icon-delete" style="color:#f56c6c" @click.stop="handleDeleteLog(data, node)">删除</el-button></span></span></el-tree></div><div v-else style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">{{ wsConnected ? (logTreeLoading ? '加载中…' : '暂无目录/文件') : 'WebSocket 未连接' }}</div><span slot="footer" class="dialog-footer"><el-button size="mini" @click="dialogLogVisible = false">关闭</el-button></span></el-dialog><el-dialog title="从设备获取文件" :visible.sync="dialogFetchVisible" width="650px"><div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px"><div style="color:var(--text-muted);font-size:12px">从设备存储中选择一个文件（排除 log 目录）同步到本地服务器。</div><el-button size="mini" icon="el-icon-refresh" @click="loadFetchTree" :loading="fetchTreeLoading" :disabled="!wsConnected">刷新</el-button></div><div v-if="fetchTreeData && fetchTreeData.length" style="max-height:500px;overflow-y:auto;border:1px solid var(--border-color);border-radius:4px;padding:10px"><el-tree :data="fetchTreeData" node-key="label" :props="{ label: 'label', children: 'children' }" :default-expand-all="false" highlight-current><span slot-scope="{ node, data }" style="display:flex;align-items:center;justify-content:space-between;width:100%;padding-right:10px"><span><i :class="data.children && data.children.length ? 'el-icon-folder' : 'el-icon-document'" style="margin-right:8px;color:var(--text-muted)"></i> {{ data.label }} </span><span><el-button v-if="!data.children || data.children.length === 0" type="text" size="mini" icon="el-icon-bottom" @click.stop="confirmFetchFile(data, node)">获取到本地</el-button><el-button type="text" size="mini" icon="el-icon-delete" style="color:#f56c6c" @click.stop="handleDeleteFetchFile(data, node)">删除</el-button></span></span></el-tree></div><div v-else style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">{{ wsConnected ? (fetchTreeLoading ? '加载中…' : '暂无可用文件') : 'WebSocket 未连接' }}</div><span slot="footer" class="dialog-footer"><el-button size="mini" @click="dialogFetchVisible = false">取消</el-button></span></el-dialog><el-dialog title="设备升级（云端/近端）" :visible.sync="dialogUpgradeVisible" width="1100px"><div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px"><div style="color:var(--text-muted);font-size:12px">当前展示：loader 名称 / SN / 当前版本 / 云端版本。</div><el-button size="mini" type="primary" icon="el-icon-refresh" @click="checkCloudNewVersion" :loading="otaLoading" :disabled="!wsConnected">获取云端版本</el-button></div><div style="margin-bottom:10px;font-size:12px;color:var(--text-secondary)">{{ otaCloudStatusText }}</div><el-table :data="upgradeRows" size="mini" border style="width:100%"><el-table-column prop="ip" label="IP" width="140"></el-table-column><el-table-column prop="loader_name" label="Loader名称" width="140"></el-table-column><el-table-column prop="sn" label="SN号" width="140"></el-table-column><el-table-column prop="current_version" label="当前版本" width="120"></el-table-column><el-table-column label="云端版本" width="120"><template slot-scope="scope"><span v-if="scope.row.target_version">{{ scope.row.target_version }}</span> <span v-else style="color:var(--text-muted)">{{ otaCloudStatus === 'error' ? '获取失败' : (otaCloudStatus === 'empty' ? '无新版本' : (otaCloudStatus === 'never' ? '未获取' : '—')) }}</span></template></el-table-column><el-table-column label="进度" width="220"><template slot-scope="scope"><el-progress :percentage="Math.round(getOtaProgress(scope.row.ip, scope.row.loader_num))" :status="getOtaProgressStatus(scope.row.ip, scope.row.loader_num)" :stroke-width="10"></el-progress></template></el-table-column><el-table-column label="操作" width="200"><template slot-scope="scope"><el-button size="mini" type="success" @click="openLocalUpgrade(scope.row)" :disabled="!wsConnected || scope.row.is_upgrading">近端升级</el-button><el-button size="mini" type="primary" @click="startOta(scope.row.ip, scope.row.loader_num)" :disabled="!wsConnected || scope.row.is_upgrading">远端升级</el-button></template></el-table-column></el-table><span slot="footer" class="dialog-footer"><el-button size="mini" @click="dialogUpgradeVisible = false">关闭</el-button></span></el-dialog><el-dialog title="近端升级（输入 .hex 文件路径）" :visible.sync="dialogLocalUpgradeVisible" width="560px"><div style="margin-bottom:15px;font-size:12px;color:var(--text-muted)">目标设备：{{ localUpgradeTarget.ip }} #{{ localUpgradeTarget.loader_num }}（{{ localUpgradeTarget.loader_name || '' }}）</div><div style="margin:20px 0"><el-input v-model="localUpgradePath" placeholder="请输入 .hex 文件的绝对路径，例如：D:\workspace\aaa.hex" size="small" style="width:100%"><template slot="prepend">文件路径</template></el-input><div style="margin-top:10px;font-size:12px;color:var(--text-muted)"><i class="el-icon-info"></i> 请输入上位机（服务器）本地文件的完整绝对路径。</div></div><span slot="footer" class="dialog-footer"><el-button size="mini" @click="dialogLocalUpgradeVisible = false" :disabled="localUpgradeLoading">取消</el-button><el-button size="mini" type="primary" :disabled="!localUpgradePath || localUpgradeLoading || isAnyDeviceUpgrading" :loading="localUpgradeLoading" @click="confirmLocalUpgrade">{{ isAnyDeviceUpgrading ? '有设备正在升级中' : '开始近端升级' }}</el-button></span></el-dialog><el-drawer title="控制台" :visible.sync="drawerConsoleVisible" direction="rtl" size="420px" :modal="false" :wrapper-closable="false" custom-class="non-modal-drawer"><div style="display:flex;flex-direction:column;height:100%"><div style="flex:1;overflow:auto;border:1px solid var(--border-color);border-radius:10px;padding:10px;background:var(--bg-white)"><div v-if="!consoleHistory.length" style="color:var(--text-muted);font-size:12px">暂无历史记录</div><div v-for="(m, idx) in consoleHistory" :key="idx" style="margin-bottom:8px"><div style="font-size:11px;color:var(--text-muted)">{{ m.ts }} · {{ m.dir === 'out' ? '发送' : '返回' }}</div><pre style="white-space:pre-wrap;word-break:break-word;background:var(--bg-gray);padding:8px;border-radius:8px;font-family:var(--font-mono);font-size:12px;margin-top:4px">{{ m.text }}</pre></div></div><div style="margin-top:10px;padding:10px;background:var(--bg-gray);border:2px solid var(--border-color);border-radius:6px"><div style="display:flex;gap:8px;align-items:center"><el-input v-model="consoleInput" size="small" placeholder="输入控制台命令，例如 120GET:CCV" style="flex:1" @keyup.enter.native="sendConsoleCmd"></el-input><el-button size="small" type="primary" @click="sendConsoleCmd" :disabled="!wsConnected || !consoleInput">发送</el-button></div></div><div style="margin-top:6px;font-size:12px;color:var(--text-muted)">当前设备：{{ device_id }} #{{ loader_num }}</div></div></el-drawer><el-dialog title="新增寄存器 Sheet" :visible.sync="dialogAddSheetVisible" width="400px"><el-form label-width="80px"><el-form-item label="名称"><el-input v-model="newSheetName" placeholder="例如：关键参数" @keyup.enter.native="confirmAddSheet"></el-input></el-form-item></el-form><div slot="footer" class="dialog-footer"><el-button size="small" @click="dialogAddSheetVisible = false">取消</el-button><el-button size="small" type="primary" @click="confirmAddSheet">确定</el-button></div></el-dialog><div v-if="contextMenuVisible" class="context-menu" :style="{ left: contextMenuPos.x + 'px', top: contextMenuPos.y + 'px' }" @click.stop><div class="context-menu-item">添加到页签 <i class="el-icon-arrow-right"></i><div class="context-submenu"><div v-for="s in registerSheets.filter(x => x.id !== 'root')" :key="s.id" class="context-menu-item" @click="addRegToSheet(contextMenuReg, s.id)">{{ s.name }}</div><div v-if="registerSheets.length <= 1" class="context-menu-item muted">暂无自定义页签</div></div></div><div v-if="activeSheetId !== 'root'" class="context-menu-item danger" @click="removeRegFromCurrentSheet(contextMenuReg)">从当前页签删除</div></div><div class="page-content" :class="{ active: activePage === 'info' }"><div class="page-header"><h2 class="page-title">设备信息</h2><el-button size="mini" icon="el-icon-refresh" @click="refreshDeviceInfo">刷新</el-button></div><div class="page-body"><div class="device-overview-card"><div class="device-photo"><img src="img/device_info.png" alt="设备图片"><div class="device-photo-overlay" v-if="!deviceConnected"><i class="el-icon-warning"></i> <span>设备未连接</span></div></div><div class="device-overview-info"><div class="device-overview-header"><div class="device-header-left"><h3 class="device-model-name">{{ currentDeviceName }}</h3><el-tag :type="deviceConnected ? 'success' : 'info'" size="small">{{ deviceConnected ? '在线' : '离线' }}</el-tag></div></div><div class="device-overview-content"><div class="device-overview-main"><div class="device-info-grid"><div class="info-item"><span class="info-label">设备序列号</span> <span class="info-value sn">{{ deviceInfo.sn || '--' }}</span></div><div class="info-item"><span class="info-label">软件版本</span> <span class="info-value">{{ deviceInfo.softwareVersion || '--' }}</span></div><div class="info-item"><span class="info-label">硬件版本</span> <span class="info-value">{{ deviceInfo.hardwareVersion || '--' }}</span></div><div class="info-item"><span class="info-label">运行时间</span> <span class="info-value highlight">{{ deviceInfo.runTime || '--' }}</span></div></div></div><div class="device-overview-side"><div class="running-model-info" v-if="deviceConnected && isModelRunning"><div class="running-model-badge"><i class="el-icon-video-play"></i> <span>模型运行中</span></div><div class="running-model-flex-container"><div v-if="currentRunningModuleImg" class="module-part-image"><img :src="currentRunningModuleImg" alt="部件图片"></div><div v-else class="module-part-placeholder"><i class="el-icon-picture-outline"></i> <span>部件预览</span></div><div class="running-model-detail"><div class="running-item"><span class="running-label">文件:</span> <span class="running-value">{{ runningFile }}</span></div><div class="running-item"><span class="running-label">模块:</span> <span class="running-value">{{ getModuleDisplayName(runningModule) }}</span></div></div></div></div><div class="running-model-info stopped" v-else-if="deviceConnected"><div class="running-model-badge stopped"><i class="el-icon-video-pause"></i> <span>模型未运行</span></div></div></div></div></div></div><div class="spec-section"><h4 class="section-title"><i class="el-icon-data-analysis"></i> 设备规格</h4><div class="spec-grid"><div class="spec-card"><div class="spec-icon" style="background:rgba(37,99,235,.1);color:var(--primary-color)"><i class="el-icon-s-data"></i></div><div class="spec-content"><span class="spec-value">{{ currentSpecs.max_current_a }} A</span> <span class="spec-label">最大电流</span></div></div><div class="spec-card"><div class="spec-icon" style="background:rgba(16,185,129,.1);color:var(--success-color)"><i class="el-icon-lightning"></i></div><div class="spec-content"><span class="spec-value">±{{ Math.abs(currentSpecs.max_voltage_v) }} V</span> <span class="spec-label">最大电压</span></div></div><div class="spec-card"><div class="spec-icon" style="background:rgba(245,158,11,.1);color:var(--warning-color)"><i class="el-icon-odometer"></i></div><div class="spec-content"><span class="spec-value">{{ currentSpecs.max_power_w }} W</span> <span class="spec-label">最大功率</span></div></div><div class="spec-card"><div class="spec-icon" style="background:rgba(139,92,246,.1);color:var(--running-color)"><i class="el-icon-time"></i></div><div class="spec-content"><span class="spec-value">{{ currentSpecs.sample_rate_khz }} kHz</span> <span class="spec-label">采样率</span></div></div></div></div><div class="realtime-section" v-if="deviceConnected"><h4 class="section-title"><i class="el-icon-data-line"></i> 实时数据</h4><div class="realtime-grid"><div class="realtime-card"><span class="realtime-value">{{ realtimeData.current.toFixed(0) }}</span> <span class="realtime-unit">mA</span> <span class="realtime-label">电流</span><div class="realtime-bar"><div class="realtime-bar-fill" :style="{ width: (realtimeData.current / 100000 * 100) + '%' }"></div></div></div><div class="realtime-card"><span class="realtime-value">{{ realtimeData.voltage.toFixed(0) }}</span> <span class="realtime-unit">mV</span> <span class="realtime-label">电压</span><div class="realtime-bar"><div class="realtime-bar-fill" :style="{ width: (realtimeData.voltage / 600000 * 100) + '%', background: 'var(--success-color)' }"></div></div></div><div class="realtime-card"><span class="realtime-value">{{ realtimeData.power.toFixed(1) }}</span> <span class="realtime-unit">W</span> <span class="realtime-label">功率</span><div class="realtime-bar"><div class="realtime-bar-fill" :style="{ width: (realtimeData.power / 50000 * 100) + '%', background: 'var(--warning-color)' }"></div></div></div><div class="realtime-card"><span class="realtime-value">{{ realtimeData.temperature }}</span> <span class="realtime-unit">°C</span> <span class="realtime-label">温度</span><div class="realtime-bar"><div class="realtime-bar-fill" :style="{ width: (realtimeData.temperature / 80 * 100) + '%', background: realtimeData.temperature > 60 ? 'var(--error-color)' : 'var(--running-color)' }"></div></div></div></div></div></div></div><div class="page-content" :class="{ active: activePage === 'model' }"><div class="page-header"><h2 class="page-title">参数编辑</h2><div class="btn-group"><el-tooltip content="云端上传（暂未开放）" placement="top"><button class="action-btn" :disabled="true" @click="handleUploadCloud"><i class="el-icon-upload2"></i>云端上传</button></el-tooltip><el-tooltip content="云端下载（暂未开放）" placement="top"><button class="action-btn" :disabled="true" @click="handleDownloadCloudModel"><i class="el-icon-download"></i>云端下载</button></el-tooltip><span class="btn-divider"></span><el-tooltip content="从设备获取文件" placement="top"><button class="action-btn" :disabled="!wsConnected" @click="handleDownloadDevice"><i class="el-icon-top"></i>模型导出</button></el-tooltip><el-tooltip content="将资源导入到设备存储" placement="top"><button class="action-btn" :disabled="!wsConnected" @click="handleLoadModelToDevice"><i class="el-icon-bottom"></i>模型导入</button></el-tooltip><span class="btn-divider"></span><el-tooltip content="保存到本地文件" placement="top" :open-delay="500"><button class="action-btn primary" :disabled="!currentModel || !hasModified" @click="handleSave"><i class="el-icon-folder-checked"></i>保存</button></el-tooltip><el-tooltip content="另存为新文件" placement="top" :open-delay="500"><button class="action-btn primary" :disabled="!currentModel || !currentModel.success" @click="handleSaveAs"><i class="el-icon-document-add"></i>另存为</button></el-tooltip><el-tooltip content="更新设备输出（立即生效）" placement="top" :open-delay="500"><button class="action-btn success" :disabled="!canApply" @click="handleApply"><i class="el-icon-video-play"></i>应用</button></el-tooltip></div></div><div class="page-body"><div v-if="runMode === 'regen'" class="empty-state" style="height:100%;padding:60px 20px"><i class="el-icon-info" style="font-size:48px;color:var(--text-muted)"></i><p style="margin-top:20px;color:var(--text-secondary)">回灌模式下不支持参数编辑</p><p style="margin-top:10px;font-size:12px;color:var(--text-muted)">请切换到"模型"模式进行参数编辑</p></div><template v-else><div class="data-path"><i class="el-icon-folder"></i> <span>数据目录: wcar_resource/loader/model</span></div><div class="model-layout"><div class="model-list"><div class="model-list-header"><span>模型文件</span><div style="display:flex;gap:5px;align-items:center"><el-button type="text" size="mini" icon="el-icon-plus" @click="handleCreateNewModel" title="新建模型文件"></el-button></div></div><div v-for="(model, index) in models" :key="index" class="model-item" :class="{ 
                      active: activeModelIndex === index,
                      'has-error': model.errors && model.errors.length > 0,
                      'is-running': isFileRunning(model.filename),
                      'drag-over': dragOverModelIndex === index
                    }" @click="handleSelectModel(index)" draggable="true" @dragstart="handleModelDragStart($event, index)" @dragover.prevent="handleModelDragOver($event, index)" @dragleave="handleModelDragLeave($event)" @drop="handleModelDrop($event, index)"><i :class="model.success ? 'el-icon-document' : 'el-icon-document-delete'"></i><div class="model-item-info"><div class="model-item-name">{{ model.filename }}</div><div class="model-item-size">{{ model.modules ? model.modules.length + ' 个模块' : '解析失败' }}</div></div><div class="model-item-btns" @click.stop><el-button type="text" size="mini" icon="el-icon-delete" class="delete-btn" @click="handleDeleteModel(model, index)" v-if="!isFileRunning(model.filename)" title="删除模型文件"></el-button></div><span v-if="isFileRunning(model.filename)" class="model-item-badge running" title="该模型正在运行中"><i class="el-icon-video-play"></i> <span>运行中</span></span></div></div><div class="model-editor" v-if="currentModel"><div class="editor-toolbar"><div class="editor-filename"><i class="el-icon-document"></i> <span>{{ currentModel.filename }}</span> <span class="modified-dot" v-if="hasModified"></span><el-tag v-if="isFileRunning(currentModel.filename)" size="mini" type="warning" effect="dark" style="margin-left:8px"><i class="el-icon-video-play"></i> 运行中</el-tag></div><div style="display:flex;gap:10px"><el-button type="text" size="mini" icon="el-icon-circle-plus-outline" @click="handleOpenAddModuleDialog">添加模块</el-button><el-button type="text" size="mini" icon="el-icon-view" @click="showRaw = !showRaw">{{ showRaw ? '编辑视图' : '文本视图' }}</el-button></div></div><div v-if="currentModel.errors && currentModel.errors.length" style="margin:10px;padding:10px;background:#fef0f0;border:1px solid #fde2e2;border-radius:4px;color:#f56c6c;font-size:12px"><div style="font-weight:700;margin-bottom:5px"><i class="el-icon-error"></i> 解析错误:</div><div v-for="(err, ei) in currentModel.errors" :key="ei">• {{ err.message }} <span v-if="err.lineNum">(第 {{ err.lineNum }} 行)</span></div></div><div v-if="currentModel.warnings && currentModel.warnings.length" style="margin:10px;padding:10px;background:#fdf6ec;border:1px solid #faecd8;border-radius:4px;color:#e6a23c;font-size:12px"><div style="font-weight:700;margin-bottom:5px"><i class="el-icon-warning"></i> 警告:</div><div v-for="(wrn, wi) in currentModel.warnings" :key="wi">• {{ wrn.message }} <span v-if="wrn.lineNum">(第 {{ wrn.lineNum }} 行)</span></div></div><div v-if="showRaw" style="flex:1;overflow:auto"><pre style="background:var(--bg-gray);padding:12px;border-radius:6px;font-family:var(--font-mono);font-size:12px;line-height:1.6;white-space:pre-wrap">{{ currentModel.raw }}</pre></div><div v-else style="flex:1;overflow-y:auto"><div v-if="currentModel.modules && currentModel.modules.length"><div v-for="(mod, mi) in currentModel.modules" :key="mi" class="module-section" :class="{ 'is-running': isModuleRunning(currentModel.filename, mod.name) }"><div class="module-header" @click="toggleModule(mi)"><span class="module-toggle" :class="{ expanded: expandedModules[mi] }"><i class="el-icon-arrow-right"></i></span><div class="module-info"><div class="module-name-row"><span class="module-name">{{ mod.name }}</span> <span class="module-name-cn" v-if="getModuleDef(mod.name)">{{ getModuleDef(mod.name).name }}</span></div><div class="module-desc" v-if="getModuleDef(mod.name)">{{ getModuleDef(mod.name).description }}</div></div><span v-if="isModuleRunning(currentModel.filename, mod.name)" class="running-indicator"><i class="el-icon-video-play"></i> 运行中 </span><span class="module-count">{{ mod.params.length }} 参数</span><div class="module-btns" @click.stop><el-button type="text" size="mini" icon="el-icon-delete" class="delete-btn" @click="handleRemoveModule(mi)" v-if="!isModuleRunning(currentModel.filename, mod.name)" title="删除此模块"></el-button></div></div><div class="module-body" :class="{ expanded: expandedModules[mi] }"><div v-if="expandedModules[mi]" style="padding:8px;border-bottom:1px solid var(--border-color);margin-bottom:8px"><el-button type="text" size="mini" icon="el-icon-plus" @click="handleOpenAddParamDialog(mi)" :disabled="isModuleRunning(currentModel.filename, mod.name)">添加参数</el-button></div><div v-for="(param, pi) in mod.params" :key="pi" class="param-row" :class="{ 'out-of-range': isOutOfRange(param) }"><div class="param-label-section"><div class="param-name-row"><span class="param-key">{{ param.name }}</span> <span class="param-name-cn" v-if="getParamDef(param.name)">{{ getParamDef(param.name).description }} </span><span class="param-unknown" v-else>未定义</span></div><div class="param-range" v-if="getParamDef(param.name) && getParamDef(param.name).min !== undefined"><i class="el-icon-info"></i> 范围: {{ getParamDef(param.name).min }} ~ {{ getParamDef(param.name).max }} <span v-if="getParamDef(param.name).default !== undefined">(默认: {{ getParamDef(param.name).default }})</span></div></div><div class="param-input-section"><template v-if="param.type === 'single'"><div class="param-input-row"><el-input-number v-if="isNumericParam(param)" :value="param.value" size="mini" controls-position="right" :min="getParamDef(param.name) ? getParamDef(param.name).min : -Infinity" :max="getParamDef(param.name) ? getParamDef(param.name).max : Infinity" :step="getParamDef(param.name) ? (getParamDef(param.name).step || 1) : 1" :precision="getPrecision(param.name)" @change="updateSingleParam(param, $event)"></el-input-number><el-input v-else v-model="param.value" size="mini" @input="hasModified = true"></el-input><span class="param-type-badge">{{ param.type }}</span></div><div class="range-warning" v-if="isOutOfRange(param)"><i class="el-icon-warning"></i> 值超出建议范围</div></template><template v-else-if="param.type === 'array'"><div class="array-display"><div class="array-header"><span class="array-label">数组 [{{ param.value.length }}]</span><el-button type="text" size="mini" icon="el-icon-plus" @click="addArrayItem(param)"></el-button></div><div class="array-items"><div v-for="(item, idx) in param.value" :key="idx" class="array-item"><span class="array-index">[{{ idx }}]</span><el-input-number v-if="typeof item === 'number'" :value="item" size="mini" controls-position="right" @change="updateArrayItem(param, idx, $event)"></el-input-number><el-input v-else :value="item" size="mini" @input="updateArrayItemStr(param, idx, $event)"></el-input><el-button type="text" size="mini" icon="el-icon-delete" @click="removeArrayItem(param, idx)"></el-button></div></div></div></template><template v-else-if="param.type === 'matrix'"><div class="matrix-display"><div class="matrix-toolbar"><span class="matrix-size">{{ param.value.length }} × {{ param.value[0] ? param.value[0].length : 0 }}</span><el-button type="text" size="mini" icon="el-icon-plus" @click="addMatrixRow(param)">添加行</el-button></div><div class="matrix-table"><div class="matrix-header" v-if="getParamDef(param.name) && getParamDef(param.name).columns"><span class="matrix-row-index">#</span> <span v-for="(col, ci) in getParamDef(param.name).columns" :key="ci" class="matrix-header-cell">{{ col }}</span> <span class="matrix-action-cell"></span></div><div v-for="(row, ri) in param.value" :key="ri" class="matrix-row"><span class="matrix-row-index">{{ ri }}</span><el-input-number v-for="(cell, ci) in row" :key="ci" :value="cell" size="mini" controls-position="right" class="matrix-cell-input" @change="updateMatrixCell(param, ri, ci, $event)"></el-input-number><el-button type="text" size="mini" icon="el-icon-delete" class="matrix-delete-btn" @click="removeMatrixRow(param, ri)"></el-button></div></div></div></template></div><div class="param-actions"><el-button type="text" size="mini" icon="el-icon-delete" class="delete-btn" @click="handleRemoveParam(mi, pi)" :disabled="isModuleRunning(currentModel.filename, mod.name)" title="删除此参数"></el-button></div></div></div></div></div><div v-else class="empty-state"><i class="el-icon-warning-outline"></i><p>该文件解析失败</p></div></div></div><div v-else class="model-editor"><div class="empty-state" style="height:100%"><i class="el-icon-folder-opened"></i><p>请从左侧选择一个模型文件</p></div></div></div></template></div></div><el-dialog title="新建模型文件" :visible.sync="dialogNewModelVisible" width="400px"><el-form label-width="80px"><el-form-item label="文件名"><el-input v-model="newModelFilename" placeholder="请输入文件名（不含扩展名）"><template slot="append">.bin</template></el-input></el-form-item></el-form><div slot="footer"><el-button size="mini" @click="dialogNewModelVisible = false">取消</el-button><el-button size="mini" type="primary" @click="confirmCreateNewModel">确定</el-button></div></el-dialog><el-dialog title="添加模块" :visible.sync="dialogAddModuleVisible" width="500px"><el-form label-width="100px"><el-form-item label="模块类型"><el-select v-model="selectedModuleType" placeholder="请选择模块类型" style="width:100%" filterable><el-option v-for="mod in availableModules" :key="mod.id" :label="mod.name + ' (' + mod.id + ')'" :value="mod.id"><span style="float:left">{{ mod.name }}</span> <span style="float:right;color:#8492a6;font-size:13px">{{ mod.id }}</span></el-option></el-select></el-form-item><div v-if="selectedModuleType" style="margin-top:10px;padding:10px;background:#f8f9fa;border-radius:4px"><div style="font-weight:700;margin-bottom:5px">模块描述:</div><div style="font-size:13px;color:#606266">{{ getModuleDesc(selectedModuleType) }}</div></div></el-form><div slot="footer"><el-button size="mini" @click="dialogAddModuleVisible = false">取消</el-button><el-button size="mini" type="primary" @click="confirmAddModule" :disabled="!selectedModuleType">确定</el-button></div></el-dialog><el-dialog title="添加参数" :visible.sync="dialogAddParamVisible" width="500px"><el-form label-width="100px"><el-form-item label="参数类型"><el-select v-model="selectedParamName" placeholder="请选择参数" style="width:100%" filterable><el-option v-for="param in availableParamsForModule" :key="param.name" :label="param.displayName" :value="param.name"><span style="float:left">{{ param.displayName }}</span> <span style="float:right;color:#8492a6;font-size:13px">ID: {{ param.id }}</span></el-option></el-select></el-form-item><div v-if="selectedParamName" style="margin-top:10px;padding:10px;background:#f8f9fa;border-radius:4px"><div style="font-weight:700;margin-bottom:5px">参数描述:</div><div style="font-size:13px;color:#606266">{{ getParamDef(selectedParamName) ? getParamDef(selectedParamName).description : '无描述' }}</div></div></el-form><div slot="footer"><el-button size="mini" @click="dialogAddParamVisible = false">取消</el-button><el-button size="mini" type="primary" @click="confirmAddParam" :disabled="!selectedParamName">确定</el-button></div></el-dialog><el-dialog title="资源导入设备" :visible.sync="dialogImportDeviceVisible" width="600px"><div style="margin-bottom:15px"><el-radio-group v-model="importDeviceType" size="mini"><el-radio label="current">导入当前设备</el-radio></el-radio-group></div><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px"><div style="color:var(--text-muted);font-size:12px">请选择要导入的资源 (来自上位机 wcar_resource/loader 目录)：</div><el-button size="mini" icon="el-icon-refresh" @click="refreshResourceTree" :loading="resourceTreeLoading">刷新</el-button></div><div v-loading="resourceTreeLoading || resourceLoadingCount > 0" style="max-height:400px;overflow-y:auto;border:1px solid var(--border-color);border-radius:4px;padding:10px"><el-tree :key="resourceTreeKey" node-key="path" :props="{ label: 'label', children: 'children', isLeaf: 'isLeaf' }" lazy :load="loadResourceNode" show-checkbox ref="resourceTree" @check="handleResourceCheck" @node-expand="handleResourceNodeExpand" :expand-on-click-node="false" @node-click="handleResourceNodeClick"><span slot-scope="{ node, data }" style="display:flex;align-items:center;gap:8px"><i :class="node.isLeaf ? 'el-icon-document' : 'el-icon-folder'" style="color:var(--text-muted)"></i> <span>{{ data.label }}</span></span></el-tree></div><div v-if="selectedResourceNodes.length" style="margin-top:15px;font-size:12px;color:var(--primary-color)"><strong>已选择 {{ selectedResourceNodes.length }} 个资源</strong> <span v-if="resourceLoadingCount > 0" style="margin-left:10px;color:var(--text-muted)"><i class="el-icon-loading"></i> 正在递归加载子目录...</span></div><div slot="footer"><el-button size="mini" @click="dialogImportDeviceVisible = false" :disabled="isImporting">取消</el-button><el-button size="mini" type="primary" @click="confirmImportDevice" :disabled="!selectedResourceNodes.length || isImporting || resourceLoadingCount > 0" :loading="isImporting">开始导入</el-button></div></el-dialog><div class="page-content" :class="{ active: activePage === 'register' }"><div class="page-header"><h2 class="page-title">寄存器管理</h2><div class="page-header-actions"><el-input v-model="registerSearch" placeholder="搜索寄存器..." prefix-icon="el-icon-search" size="mini" style="width:200px;margin-right:10px" clearable></el-input><el-button size="mini" icon="el-icon-refresh" @click="refreshSheetRegisters(currentSheet)" :loading="registerLoading">刷新当前页</el-button></div></div><div class="page-body register-page" style="display:flex;flex-direction:column"><div style="display:flex;align-items:center;background:var(--bg-white);border-bottom:1px solid var(--border-color);padding-left:10px"><el-tabs v-model="activeSheetId" type="card" @tab-remove="handleSheetRemove" style="margin-bottom:-1px"><el-tab-pane v-for="(sheet, index) in registerSheets" :key="sheet.id" :name="sheet.id" :closable="sheet.id !== 'root'"><span slot="label" class="tab-label-zone" :class="{ 
                        'root-tab-label': sheet.id === 'root',
                        'drag-over-tab': dragOverTabIndex === index
                      }" :draggable="sheet.id !== 'root'" @dragstart="handleTabDragStart($event, index)" @dragover.prevent="handleTabDragOver($event, index)" @dragleave="handleTabDragLeave($event)" @drop="handleDropOnTab($event, index)"><i v-if="sheet.id === 'root'" class="el-icon-collection"></i> <span @dblclick="renameSheet(sheet)">{{ sheet.name }}</span> <i v-if="sheet.timerEnabled" class="el-icon-timer" style="color:var(--primary-color);margin-left:4px" title="自动刷新中"></i></span></el-tab-pane></el-tabs><el-button size="mini" type="text" icon="el-icon-plus" style="margin-left:10px;padding:8px" @click="handleSheetAdd" title="新建页签（上限5个）"></el-button></div><div v-if="activeSheetId !== 'root'" style="padding:8px 12px;display:flex;align-items:center;gap:15px;border-bottom:1px solid var(--border-color);margin-bottom:5px;background:#f8fafc"><div style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:5px">自动刷新:<el-switch v-model="currentSheet.timerEnabled" size="mini" @change="toggleSheetTimer(currentSheet)"></el-switch></div><div v-if="currentSheet.timerEnabled" style="font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:5px">间隔:<el-input-number v-model="currentSheet.timerInterval" size="mini" :min="500" :max="20000" :step="500" style="width:100px" @change="saveRegisterSheets(); startSheetTimer(currentSheet);"></el-input-number>ms</div><div style="flex:1;text-align:right;font-size:11px;color:var(--text-muted)">提示：可从“全量寄存器”拖拽条目到其他页签；双击页签重命名。</div></div><div class="register-table-container" style="flex:1;overflow:auto;margin-top:5px"><table class="register-table"><thead><tr><th width="65" style="text-align:center">ID</th><th width="100">名称</th><th width="70" style="text-align:center"><el-dropdown trigger="click" @command="v => registerTypeFilter = v"><span class="el-dropdown-link" style="cursor:pointer;font-size:12px;color:inherit">类型<i class="el-icon-arrow-down el-icon--right"></i></span><el-dropdown-menu slot="dropdown"><el-dropdown-item command="all" :disabled="registerTypeFilter === 'all'">全部类型</el-dropdown-item><el-dropdown-item command="int" :disabled="registerTypeFilter === 'int'">数值型</el-dropdown-item><el-dropdown-item command="string" :disabled="registerTypeFilter === 'string'">字符串型</el-dropdown-item></el-dropdown-menu></el-dropdown></th><th width="70" style="text-align:center"><el-dropdown trigger="click" @command="v => registerFilter = v"><span class="el-dropdown-link" style="cursor:pointer;font-size:12px;color:inherit">权限<i class="el-icon-arrow-down el-icon--right"></i></span><el-dropdown-menu slot="dropdown"><el-dropdown-item command="all" :disabled="registerFilter === 'all'">全部权限</el-dropdown-item><el-dropdown-item command="read" :disabled="registerFilter === 'read'">只读</el-dropdown-item><el-dropdown-item command="write" :disabled="registerFilter === 'write'">只写</el-dropdown-item><el-dropdown-item command="readwrite" :disabled="registerFilter === 'readwrite'">读写</el-dropdown-item></el-dropdown-menu></el-dropdown></th><th width="110">当前值</th><th width="350">新值</th><th>描述</th><th width="140">操作</th></tr></thead><tbody><tr v-for="(reg, index) in filteredRegisters" :key="reg.name" draggable="true" @dragstart="handleDragStart($event, reg, index)" @dragover.prevent="handleDragOverRow($event, index)" @dragleave="handleDragLeaveRow($event)" @drop="handleDropOnRow($event, index)" @contextmenu.prevent="showContextMenu($event, reg)" :class="{ 
                        'reg-modified': reg.modified, 
                        'reg-read-error': reg.readError,
                        'drag-over-row': dragOverRowIndex === index 
                      }"><td class="reg-id" style="text-align:center">0x{{ reg.address.toString(16).toUpperCase().padStart(4, '0') }}</td><td class="reg-name">{{ reg.name }}</td><td style="text-align:center"><el-tag size="mini" :type="reg.type === 'int' ? '' : 'warning'">{{ reg.type === 'int' ? '数值' : '字符串' }}</el-tag></td><td style="text-align:center"><el-tag size="mini" :type="reg.access === 'read' ? 'info' : (reg.access === 'write' ? 'danger' : 'success')">{{ reg.access === 'read' ? '只读' : (reg.access === 'write' ? '只写' : '读写') }}</el-tag></td><td class="reg-value" :class="{ 'text-danger': reg.readError }"><template v-if="reg.access !== 'write'">{{ reg.readError ? '读取失败' : (reg.value !== null ? reg.value : '--') }}</template><span v-else class="muted">--</span></td><td class="reg-write"><div v-if="reg.access !== 'read'" class="reg-input-wrap"><input v-if="reg.type === 'int'" type="number" class="reg-input" v-model.number="reg.inputValue" @keyup.enter="writeRegister(reg)" :placeholder="reg.access === 'write' ? '输入后写入' : '新值'" :min="reg.min !== null ? reg.min : undefined" :max="reg.max !== null ? reg.max : undefined"> <input v-else type="text" class="reg-input" v-model="reg.inputValue" @keyup.enter="writeRegister(reg)" :placeholder="reg.access === 'write' ? '输入后写入' : '新值'"></div><span v-else class="muted">只读</span></td><td class="reg-desc"><div>{{ reg.description }}</div><div v-if="reg.type === 'int' && reg.min !== null && reg.max !== null" class="reg-range">范围: {{ reg.min }} ~ {{ reg.max }}</div></td><td class="reg-actions"><el-button v-if="reg.access !== 'write'" size="mini" icon="el-icon-refresh" :loading="reg.loading" @click="readRegister(reg)">读取</el-button><el-button v-if="reg.access !== 'read'" size="mini" type="primary" icon="el-icon-upload2" :disabled="reg.inputValue === '' || reg.inputValue === null" @click="writeRegister(reg)">写入</el-button></td></tr></tbody></table><div v-if="filteredRegisters.length === 0" class="empty-state" style="padding:40px"><i class="el-icon-folder-opened"></i><p>没有匹配的寄存器</p></div></div><div class="register-stats"><span>共 {{ registers.length }} 个寄存器</span> <span>|</span> <span>只读: {{ registers.filter(r => r.access === 'read').length }}</span> <span>只写: {{ registers.filter(r => r.access === 'write').length }}</span> <span>读写: {{ registers.filter(r => r.access === 'readwrite').length }}</span></div></div></div></div></div></div><div id="floating-panel" class="floating-panel"><div class="floating-item" @click="openUpgradeDialog" title="设备升级"><i class="el-icon-upload"></i> <span>设备升级</span></div><div class="floating-item" @click="openLogDialog" title="日志拉取"><i class="el-icon-document"></i> <span>日志拉取</span></div><div class="floating-item" @click="openConsoleDrawer" title="控制台"><i class="el-icon-monitor"></i> <span>控制台</span></div><div class="drag-handle" title="上下拖动调整位置"><i class="el-icon-rank"></i></div></div></div><script>let _originalMessage=Vue.prototype.$message,modelDictionary=(Vue.prototype.$message=function(e){var t={duration:1500,offset:75,showClose:!0};return"string"==typeof e?_originalMessage({...t,message:e}):_originalMessage({...t,...e})},["success","warning","info","error"].forEach(t=>{Vue.prototype.$message[t]=e=>((e="string"==typeof e?{message:e}:e).type=t,Vue.prototype.$message(e))}),{parameters:{},modules:{}});class WSClient{constructor(e=null){e=e||window.WS_URL||("https:"===window.location.protocol?"wss:":"ws:")+`//${window.location.hostname}:28657/ws`,this.url=e,this.ws=null,this.connected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectInterval=3e3,this.topic="LOADER",this.messageId=0,this.pendingRequests=new Map,this.listeners=new Map,this.requestTimeout=3e4}connect(){return new Promise((e,t)=>{this.ws&&this.ws.readyState===WebSocket.OPEN?e():(this.ws=new WebSocket(this.url),this.ws.onopen=()=>{console.log("[WS] 连接成功"),this.connected=!0,this.reconnectAttempts=0;try{this.ws.send("Hello, I am loader")}catch(e){console.warn("[WS] hello handshake failed:",e)}this.emit("connected"),e()},this.ws.onclose=e=>{console.log("[WS] 连接关闭",e.code,e.reason),this.connected=!1,this.emit("disconnected"),this.tryReconnect()},this.ws.onerror=e=>{console.error("[WS] 连接错误",e),this.emit("error",e),t(e)},this.ws.onmessage=e=>{this.handleMessage(e.data)})})}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1}tryReconnect(){this.reconnectAttempts>=this.maxReconnectAttempts?(console.log("[WS] 达到最大重连次数，停止重连"),this.emit("reconnectFailed")):(this.reconnectAttempts++,console.log(`[WS] 尝试重连 (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`),setTimeout(()=>{this.connect().catch(()=>{})},this.reconnectInterval))}handleMessage(t){try{if("string"==typeof t){var s=JSON.parse(t);if(Array.isArray(s)){if(0<this.pendingRequests.size){let e=null;for(var i of this.pendingRequests.keys())(null===e||Number(i)>Number(e))&&(e=i);var a,r,n=null!==e?this.pendingRequests.get(e):null;if(n)return{resolve:a,timer:r}=n,clearTimeout(r),this.pendingRequests.delete(e),void a({topic:this.topic,cmd_id:e,name:"anonymous.array",data:s})}this.emit("anonymous.array",s)}else{var e=s.cmd_id??s.id,o=null!=e?String(e):null;if(o&&this.pendingRequests.has(o)){var{resolve:l,reject:d,timer:c}=this.pendingRequests.get(o);clearTimeout(c),this.pendingRequests.delete(o);let t=s;if(void 0!==s.data)if("string"==typeof s.data)try{var h=JSON.parse(s.data);t=h}catch(e){t=s.data}else t=s.data;void(!1!==t.success&&!1!==t.ok&&(void 0===t.code||0===t.code)||!1!==t.success?l(t):d(new Error(t.error||t.msg||t.desc||"请求失败")))}else{if(s&&s.name){let e=s.data;if("string"==typeof s.data&&(s.data.startsWith("{")||s.data.startsWith("[")))try{e=JSON.parse(s.data)}catch(e){}"refresh_signals"===s.name?this.emit("refresh_signals",e):this.emit(s.name,e)}s&&s.type&&this.emit(s.type,s.data)}}}}catch(e){console.error("[WS] 消息解析失败:",e,"原始数据:",t)}}request(l,d={},c=null){return new Promise((t,s)=>{if(this.connected){var i=1e3*Date.now()+ ++this.messageId%1e3;let e=String(i);var a=(window.WS_METHOD_MAP||{})[l]||l,r="string"==typeof d?d:JSON.stringify(d||{}),r={topic:this.topic,cmd_id:i,name:a,data:r},n=c||this.requestTimeout,o=setTimeout(()=>{this.pendingRequests.delete(e),s(new Error("请求超时"))},n);this.pendingRequests.set(e,{resolve:t,reject:s,timer:o}),console.log("[WS] 发送请求:",a,d,"cmd_id=",i,"timeout=",n),this.ws.send(JSON.stringify(r))}else s(new Error("WebSocket 未连接"))})}send(e,t={}){var s;return this.connected?(s=1e3*Date.now()+ ++this.messageId%1e3,e=(window.WS_METHOD_MAP||{})[e]||e,t="string"==typeof t?t:JSON.stringify(t||{}),this.ws.send(JSON.stringify({topic:this.topic,cmd_id:s,name:e,data:t})),!0):(console.warn("[WS] 未连接，无法发送"),!1)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){this.listeners.has(e)&&-1!==(t=(e=this.listeners.get(e)).indexOf(t))&&e.splice(t,1)}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(e=>e(t))}startGetConnectStatus(){return this.request("start_get_connect_status",{})}stopAllTimers(){return this.request("stop_all_timers",{})}queryLocationInfo(){return this.request("query_location_info",{})}getModels(e,t,s="component_emulation"){return this.request("get_models",{device_id:e,loader_num:t,sim_type:s})}startLoader(e,t,s,i="component_emulation"){return this.request("start_loader",{device_id:e,loader_num:t,model:s,sim_type:i},3e4)}stopLoader(e,t,s,i="component_emulation"){return this.request("stop_loader",{device_id:e,loader_num:t,model:s,sim_type:i},3e4)}getSignals(e,t,s){s=Array.isArray(s)?s:s?[s]:[];return this.request("get_signals",{device_id:e,loader_num:t,regs:s})}scheduleRefreshSignals(e,t,s,i){s=Array.isArray(s)?s:s?[s]:[];return this.request("schedule_refresh_signals",{device_id:e,loader_num:t,regs:s,period:i})}stopRefreshRegs(){return this.request("stop_refresh_regs",{})}setSignals(e,t,s){return this.request("set_signals",{device_id:e,loader_num:t,signals:s})}getFileInfo(e,t,s=""){return this.request("get_file_info",{device_id:e,loader_num:t,name:s})}obtainLoaderDirStructure(e="loader"){return this.request("obtain_loader_dir_structure",{path:e})}loadModel(e,t,s,i,a=!1){return a?this.request("load_model",{modelzip:s,project:i,all_devices:!0}):this.request("load_model",{device_id:e,loader_num:t,modelzip:s,project:i,all_devices:!1})}downloadCloudModels(e,t,s,i,a){return this.request("download_cloud_models",{device_id:e,loader_num:t,model_name:s,model_id:i,project:a})}sendCmd(e,t,s,i=!1){return this.request("send_cmd",{device_id:e,loader_num:t,cmd:s,multi_frames:i})}checkLoadersNewVersion(){return this.request("check_loaders_new_version",{})}updateOneLoader(e,t){return this.request("update_one_loader",{device_id:e,loader_num:t},3e5)}setRegValue(e,t,s,i){return this.request("set_reg_value",{device_id:e,loader_num:t,reg_name:s,reg_value:String(i)})}waitRegValue(e,t,s){return this.request("wait_reg_value",{device_id:e,loader_num:t,reg_name:s})}saveLocationInfo(e){return this.request("save_location_info",{location:e})}getLocalFileList(){return this.request("get_local_file_list",{})}readLocalFile(e){return this.request("read_local_file",{path:e})}saveLocalFile(e,t){return this.request("save_local_file",{path:e,bin_json:t})}saveAsLocalFile(e,t){return this.request("save_as_local_file",{path:e,bin_json:t})}uploadToCloud(e){return this.request("upload_to_cloud",{path:e})}downloadFromDevice(e,t,s){return this.request("download_from_device",{device_id:e,loader_num:t,path:s})}applyParamsToDevice(e,t,s){return this.request("apply_params_to_device",{device_id:e,loader_num:t,module_info:s})}stopAllTimers(){return this.request("stop_all_timers",{})}deleteLocalFile(e){return this.request("delete_local_file",{path:e})}delFile(e,t,s){return this.request("del_file",{device_id:e,loader_num:t,path:s})}loaderOta(e,t,s){return this.request("loader_ota",{device_id:e,loader_num:t,path:s},3e5)}pullLoaderLog(e,t,s){return this.request("pull_loader_log",{device_id:e,loader_num:t,path:s})}loadModelBatch(e,t,s){return this.request("load_model_batch",{device_id:e,loader_num:t,models_list:s})}saveFile(e,t,s){return this.request("file.save",{device_sn:e,filename:t,content:s})}saveFileAs(e,t,s){return this.request("file.saveAs",{device_sn:e,filename:t,content:s})}readFile(e,t){return this.request("file.read",{device_sn:e,filename:t})}deleteFile(e,t){return this.request("file.delete",{device_sn:e,filename:t})}listFiles(e){return this.request("file.list",{device_sn:e})}}let wsClient=new WSClient;async function parseBinByServer(e){var t;if(wsClient&&wsClient.connected)return(t=!0===(t=(t=await wsClient.readLocalFile(e))&&void 0!==t.data?t.data:t).ret&&t.data?t.data:t)&&!1!==t.success?{success:!0,filename:t.filename||e.split("/").pop(),modules:t.modules||[],raw:t.content||"",path:e,errors:t.errors||[],warnings:t.warnings||[]}:{success:!1,error:t.desc||t.msg||"解析失败"};try{return await(await fetch("/api/bin/parse",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})})).json()}catch(e){return{success:!1,error:e.message}}}let sampleFiles={"example.bin":`#这是一个模型文件
#后车窗
WINDOW_R
up_limit:2200
down_limit:0
vout_gain:1.5
current_output_gain:0.5
stuck_mode:2000
matrix1:3 4 5

#尾门锁
TAIL_GATE_LOCK
signal_tailgate_1:1
signal_tailgate_2:1
vout_gain:1.2
current_output_gain:0.3
example_factor:
    0 0 0
    1 2.3 4.51
    2 3.4 6.66`,"motor_control.bin":`#电机控制模型
MOTOR_CTRL
max_speed:3000
min_speed:0
acceleration:100
deceleration:150
pid_kp:1.5
pid_ki:0.2
pid_kd:0.05

BRAKE_CTRL
brake_force:80
release_delay:50`,"test_out_of_range.bin":`#范围测试
WINDOW_R
up_limit:99999
vout_gain:15.5
current_output_gain:0.5`};new Vue({el:"#app",data:{wsConnected:!1,deviceConnected:!1,deviceSN:"",device_id:"127.0.0.1",loader_num:0,locationList:[],selectedLocation:"",isLocationRegistered:!1,connectStatus:null,selectedDeviceKey:"",lastConnectStatusTime:0,connectStatusCheckTimer:null,hasRequestedConnectStatus:!1,deviceSignalCache:{},otaLoading:!1,otaGroups:[],otaProgress:{},otaStatus:{},otaUpdatingKey:"",otaTimeoutTimer:null,otaCloudStatus:"never",otaCloudMsg:"",otaCloudCheckedAt:"",dialogModelVisible:!1,dialogUpgradeVisible:!1,dialogLogVisible:!1,dialogFetchVisible:!1,dialogLocalUpgradeVisible:!1,drawerConsoleVisible:!1,localUpgradeTarget:{ip:"",loader_num:0,loader_name:""},selectedHexFile:null,selectedHexName:"",selectedHexPath:"",hexFileList:[],localUpgradeLoading:!1,localUpgradeTab:"file",localUpgradePath:"",consoleInput:"",consoleHistory:[],modelTreeLoading:!1,modelTreeData:[],logTreeLoading:!1,logTreeData:[],fetchTreeLoading:!1,fetchTreeData:[],selectedLogPath:"",selectedResourcePath:"",selectedResourceNodes:[],resourceTreeLoading:!1,resourceTreeKey:0,resourceLoadingCount:0,isImporting:!1,deviceSpecsConfig:null,deviceNameFromRegister:"",modelOptionsLoading:!1,modelOptions:[],selectedModelPath:[],runMode:"model",activeTool:"model",activePage:"info",activeModelIndex:0,hasModified:!1,showRaw:!1,expandedModules:{},models:[],isModelRunning:!1,runningFile:"",runningModule:"",deviceInfo:{sn:"",hardwareVersion:"",softwareVersion:"",runTime:""},realtimeData:{current:0,voltage:0,power:0,temperature:0},registerSearch:"",registerFilter:"all",registerTypeFilter:"all",registerLoading:!1,registers:[],registerDefsAll:[],activeSheetId:"root",registerSheets:[{id:"root",name:"全量寄存器",registerNames:[],timerEnabled:!1,timerInterval:5e3,timerId:null}],dialogAddSheetVisible:!1,newSheetName:"",dragOverRowIndex:null,dragOverTabIndex:null,dragOverModelIndex:null,draggedRegName:"",contextMenuVisible:!1,contextMenuPos:{x:0,y:0},contextMenuReg:null,modelDictionary:{parameters:{},modules:{}},dialogNewModelVisible:!1,newModelFilename:"",dialogAddModuleVisible:!1,selectedModuleType:"",dialogAddParamVisible:!1,selectedParamName:"",selectedModuleIndexForParam:-1,dialogImportDeviceVisible:!1,importDeviceType:"current"},watch:{async activeSheetId(e,t){if(t&&t!==e&&this.wsConnected){try{await wsClient.stopRefreshRegs(),console.log("[Sheet] 切换页签，已停止定时刷新寄存器")}catch(e){console.error("[Sheet] 停止定时刷新失败:",e)}e=this.registerSheets.find(e=>e.id===t);e&&e.timerEnabled&&(e.timerId=null,e.timerEnabled=!1)}}},computed:{currentSheet(){return this.registerSheets.find(e=>e.id===this.activeSheetId)||this.registerSheets[0]},filteredRegisters(){var e=this.currentSheet;let t=[];return(t="root"===e.id?this.registers:(e.registerNames||[]).map(t=>this.registers.find(e=>e.name===t)).filter(Boolean)).filter(e=>{if(this.registerSearch){var t=this.registerSearch.toLowerCase(),s=e.name.toLowerCase().includes(t),t=e.description.toLowerCase().includes(t);if(!s&&!t)return!1}return!("all"!==this.registerFilter&&e.access!==this.registerFilter||"all"!==this.registerTypeFilter&&e.type!==this.registerTypeFilter)})},currentDeviceEntry(){var e,t=this.connectStatus&&"object"==typeof this.connectStatus?this.connectStatus:{};for(e of Object.values(t))if(Array.isArray(e))for(var s of e)if(s)if(Array.isArray(s.value)){for(var i of s.value)if(i&&String(i.ip)===String(this.device_id)&&Number(i.loader_num)===Number(this.loader_num))return i}else if(String(s.ip)===String(this.device_id)&&Number(s.loader_num)===Number(this.loader_num))return s;return null},currentDeviceName(){var e=this.currentDeviceEntry,e=e&&e.name?String(e.name).trim():"";return e||(this.deviceNameFromRegister||"").trim()||"X-Loader"},currentHardwareVersion(){var e=this.currentDeviceEntry,e=e&&e.hversion?String(e.hversion).trim():"";return e||(this.deviceInfo&&this.deviceInfo.hardwareVersion?String(this.deviceInfo.hardwareVersion).trim():"")||"default"},currentSpecs(){var e=this.deviceSpecsConfig||{},t=e[this.currentDeviceName]||e.default||{};return t[this.currentHardwareVersion]||t.default||e.default&&e.default.default||{max_current_a:100,max_voltage_v:600,max_power_w:5e4,sample_rate_khz:100}},currentModel(){return this.models[this.activeModelIndex]||null},currentRunningModuleImg(){var e;return this.deviceConnected&&this.isModelRunning&&this.runningModule&&(e=this.getModuleDef(this.runningModule))?e.img:null},canApply(){return this.deviceConnected&&this.isModelRunning&&this.currentModel&&this.currentModel.success&&this.isFileRunning(this.currentModel.filename)},canStartSelected(){return Array.isArray(this.selectedModelPath)&&2<=this.selectedModelPath.length},canStopSelected(){return this.deviceConnected&&this.isModelRunning},isAnyDeviceUpgrading(){var e,t,s=this.connectStatus&&"object"==typeof this.connectStatus?this.connectStatus:{};for(e of Object.values(s))if(Array.isArray(e))for(var i of e)if(i)for(t of Array.isArray(i.value)?i.value:[i])if(t&&t.is_upgrade)return!0;return!!Object.values(this.otaStatus).some(e=>e&&"running"===e.status)},hasConnectStatus(){return this.connectStatus&&"object"==typeof this.connectStatus&&0<Object.keys(this.connectStatus).length},availableModules(){return this.modelDictionary&&this.modelDictionary.modules?Object.entries(this.modelDictionary.modules).map(([e,t])=>({id:e,name:t.name||e})):[]},availableParamsForModule(){if(this.selectedModuleIndexForParam<0||!this.currentModel||!this.currentModel.modules)return[];var e=this.currentModel.modules[this.selectedModuleIndexForParam];if(!e||!this.modelDictionary||!this.modelDictionary.modules)return[];var t=this.modelDictionary.modules[e.name];if(!t)return[];let s=t.allowed_param_ids||[],i=new Set(e.params.map(e=>e.name)),a=[];return this.modelDictionary.parameters&&Object.entries(this.modelDictionary.parameters).forEach(([e,t])=>{t.id&&s.includes(t.id)&&(i.has(e)||a.push({name:e,id:t.id,displayName:`${t.name||e} (${e})`}))}),a.sort((e,t)=>e.id-t.id),a},currentSimType(){return"regen"===this.runMode?"data_replay":"component_emulation"},otaCloudMap(){var e,t={};for(e of this.otaGroups||[]){var s,i=e&&e.ip?String(e.ip):"";for(s of e.devices||[])t[this.otaKey(i,s.loader_num)]={target_version:s.target_version||"",current_version:s.current_version||"",sn:s.sn||"",loader_name:s.loader_name||"",progress:s.progress}}return t},otaCloudStatusText(){return"never"===this.otaCloudStatus?"云端版本：未获取":"ok"===this.otaCloudStatus?`云端版本：已获取（${this.otaCloudCheckedAt||""}）`:"empty"===this.otaCloudStatus?`云端版本：无新版本（${this.otaCloudCheckedAt||""}）`:"error"===this.otaCloudStatus?`云端版本：获取失败（${this.otaCloudMsg||""}）`:"云端版本：未知"},upgradeRows(){let r=[];var e,t=this.connectStatus&&"object"==typeof this.connectStatus?this.connectStatus:{},s=e=>{var t,s,i,a;e&&void 0!==e.ip&&void 0!==e.loader_num&&(t=String(e.ip),s=Number(e.loader_num),i=this.otaKey(t,s),a=this.otaCloudMap[i]||{},r.push({ip:t,loader_num:s,loader_name:e.loader_name||a.loader_name||"loader-"+s,sn:e.sn||a.sn||"",running_text:this.toBool(e.running)?"运行中":"未运行",current_version:e.version||a.current_version||"",target_version:a.target_version||"",is_upgrading:!!e.is_upgrade||this.otaStatus[i]&&"running"===this.otaStatus[i].status}))};for(e of Object.values(t))if(Array.isArray(e))for(var i of e)i&&(Array.isArray(i.value)?i.value.forEach(s):s(i));return r.sort((e,t)=>e.ip===t.ip?e.loader_num-t.loader_num:e.ip.localeCompare(t.ip)),r},labView(){var e,t,s=this.connectStatus&&"object"==typeof this.connectStatus?this.connectStatus:{},i=[];for([e,t]of Object.entries(s)){var a,r=[];for(a of Array.isArray(t)?t:[])if(a){let t="unknown",e=[];if(Array.isArray(a.value)){t=a.ip||"unknown",e=a.value;var n,o=this.createEmptySlots(t);for(n of e)this.fillSlot(o,n,t);r.push({ip:t,devices:o})}else{t=a.ip||"unknown";let e=r.find(e=>e.ip===t);e||(e={ip:t,devices:this.createEmptySlots(t)},r.push(e)),this.fillSlot(e.devices,a,t)}}i.push({labKey:e,cabinets:r})}return i}},methods:{createEmptySlots(s){return new Array(6).fill(null).map((e,t)=>({ip:s,loader_num:t,connect:!1,running:!1,interrupt:!1,high_temp_alarm:!1,busy:!1,running_model:""}))},fillSlot(e,t,s){var i=Number(t.loader_num);Number.isFinite(i)&&0<=i&&i<6&&(s=String(s)+"#"+i,s=this.deviceSignalCache&&this.deviceSignalCache[s]?this.deviceSignalCache[s]:null,e[i]={...e[i],...t,loader_num:i,connect:this.toBool(t.connect),running:this.toBool(t.running),interrupt:this.toBool(t.interrupt),high_temp_alarm:this.toBool(t.high_temp_alarm),busy:this.toBool(t.busy),running_model:s&&s.MFILE?s.MFILE:t.loader_name||t.running_model||t.name||""})},formatSN(e){if(!e)return"--";var t=Number(e);if(isNaN(t))return String(e);var s=t.toString(16).padStart(8,"0").toLowerCase(),i=[];for(let e=0;e<s.length;e+=2)i.push(s.substring(e,e+2));return i.join("-")},signalsToMap(e){var t,e=e&&void 0!==e.data?e.data:e,s=Array.isArray(e)?e:e&&Array.isArray(e.data)?e.data:[],i=new Map;for(t of s)t&&void 0!==t.name&&i.set(String(t.name),t.value);return!s.length&&e&&void 0!==e.name&&void 0!==e.value&&i.set(String(e.name),e.value),!s.length&&e&&e.data&&void 0!==e.data.name&&void 0!==e.data.value&&i.set(String(e.data.name),e.data.value),i},loadRegisterSheets(){try{var e,t=localStorage.getItem("xloader_register_sheets");t&&((e=JSON.parse(t)).find(e=>"root"===e.id)||e.unshift({id:"root",name:"全量寄存器",registerNames:[],timerEnabled:!1,timerInterval:5e3,timerId:null}),e.forEach(e=>e.timerId=null),this.registerSheets=e)}catch(e){console.error("[Sheet] Load failed:",e)}},saveRegisterSheets(){try{var e=this.registerSheets.map(e=>({id:e.id,name:e.name,registerNames:e.registerNames,timerEnabled:e.timerEnabled,timerInterval:e.timerInterval}));localStorage.setItem("xloader_register_sheets",JSON.stringify(e))}catch(e){console.error("[Sheet] Save failed:",e)}},handleSheetAdd(){5<=this.registerSheets.length?this.$message.warning("最多只能创建 5 个页签（包括全量寄存器），请删除不需要的页签后再试。"):(this.newSheetName="",this.dialogAddSheetVisible=!0)},handleSheetRemove(s){"root"!==s&&this.$confirm("确定删除该页签吗？其内的寄存器分组信息将丢失。","提示",{type:"warning"}).then(()=>{var e,t=this.registerSheets.findIndex(e=>e.id===s);-1!==t&&((e=this.registerSheets[t]).timerId&&clearInterval(e.timerId),this.registerSheets.splice(t,1),this.activeSheetId===s&&(this.activeSheetId="root"),this.saveRegisterSheets())}).catch(()=>{})},confirmAddSheet(){var e,t=this.newSheetName.trim();t&&(e="sheet_"+Date.now(),this.registerSheets.push({id:e,name:t,registerNames:[],timerEnabled:!1,timerInterval:5e3,timerId:null}),this.activeSheetId=e,this.dialogAddSheetVisible=!1,this.saveRegisterSheets())},renameSheet(t){"root"!==t.id&&this.$prompt("请输入新的 Sheet 名称","改名",{inputValue:t.name,inputPattern:/\S+/,inputErrorMessage:"名称不能为空"}).then(({value:e})=>{t.name=e,this.saveRegisterSheets()})},async toggleSheetTimer(t){if(t.timerEnabled){for(var e of this.registerSheets)if(e.id!==t.id&&e.timerEnabled&&(e.timerId=null,this.$set(e,"timerEnabled",!1),this.wsConnected))try{await wsClient.stopRefreshRegs(),console.log("[Sheet] 已停止其他页签的定时刷新:",e.name)}catch(e){console.error("[Sheet] 停止定时刷新失败:",e)}this.$set(t,"timerEnabled",!0),this.startSheetTimer(t)}else{if(t.timerId=null,this.wsConnected)try{await wsClient.stopRefreshRegs(),console.log("[Sheet] 定时刷新已停止:",t.name)}catch(e){return console.error("[Sheet] 停止定时刷新失败:",e),void this.$set(t,"timerEnabled",!0)}this.$set(t,"timerEnabled",!1)}this.saveRegisterSheets()},startSheetTimer(t){if(t.timerId&&(clearInterval(t.timerId),t.timerId=null),this.wsConnected&&this.deviceConnected){var s="root"===t.id?this.registers.map(e=>e.name):t.registerNames;if(s.length){let e=t.timerInterval||5e3;try{wsClient.scheduleRefreshSignals(this.device_id,this.loader_num,s,e).then(()=>{console.log(`[Sheet] 定时刷新已启动: ${t.name}, 周期: ${e}ms`)}).catch(e=>{console.error("[Sheet] 启动定时刷新失败:",e)})}catch(e){console.error("[Sheet] 启动定时刷新异常:",e)}}}},async refreshSheetRegisters(e){if(this.deviceConnected){let s="root"===e.id?this.registers.map(e=>e.name):e.registerNames;if(s.length)try{var i=await wsClient.getSignals(this.device_id,this.loader_num,s);let t=this.signalsToMap(i);this.registers.forEach(e=>{s.includes(e.name)&&t.has(e.name)&&(e.value=t.get(e.name),e.readError=!1)})}catch(e){console.warn("[Sheet] Auto-refresh failed:",e)}}},handleDragStart(e,t,s){e.dataTransfer.setData("type","register"),e.dataTransfer.setData("regName",t.name),e.dataTransfer.setData("fromSheetId",this.activeSheetId),e.dataTransfer.setData("fromIndex",s),this.draggedRegName=t.name},handleTabDragStart(e,t){"root"!==this.registerSheets[t].id&&(e.dataTransfer.setData("type","tab"),e.dataTransfer.setData("fromTabIndex",t))},handleModelDragStart(e,t){e.dataTransfer.setData("type","model"),e.dataTransfer.setData("fromModelIndex",t),e.target.style.opacity="0.5",e.target.addEventListener("dragend",()=>{e.target.style.opacity="1"},{once:!0})},handleModelDragOver(e,t){this.dragOverModelIndex=t},handleModelDragLeave(e){this.dragOverModelIndex=null},handleModelDrop(e,t){var s,i;this.dragOverModelIndex=null,"model"!==e.dataTransfer.getData("type")||(e=parseInt(e.dataTransfer.getData("fromModelIndex")),isNaN(e))||e===t||(s=this.models[this.activeModelIndex],[e]=(i=[...this.models]).splice(e,1),i.splice(t,0,e),this.models=i,s&&(this.activeModelIndex=this.models.indexOf(s)))},handleDragOverRow(e,t){"root"!==this.activeSheetId&&(this.dragOverRowIndex=t)},handleTabDragOver(e,t){this.dragOverTabIndex=t},handleTabDragLeave(e){this.dragOverTabIndex=null},handleDropOnRow(e,t){var s,i,a,r,n;this.dragOverRowIndex=null,"register"===e.dataTransfer.getData("type")&&(a=e.dataTransfer.getData("fromSheetId"),e=e.dataTransfer.getData("regName"),"root"!==this.activeSheetId)&&a===this.activeSheetId&&(i=[...(s=this.currentSheet).registerNames],a=this.filteredRegisters[t])&&(r=i.indexOf(e),n=i.indexOf(a.name),-1!==r)&&-1!==n&&([t]=i.splice(r,1),i.splice(n,0,t),s.registerNames=i,this.saveRegisterSheets())},handleDropOnTab(e,t){this.dragOverTabIndex=null;var s,i,a=e.dataTransfer.getData("type"),r=this.registerSheets[t];r&&("tab"===a?(i=parseInt(e.dataTransfer.getData("fromTabIndex")),isNaN(i)||i===t||"root"===r.id||([i]=(s=[...this.registerSheets]).splice(i,1),s.splice(t,0,i),this.registerSheets=s,this.saveRegisterSheets())):"register"===a&&(t=e.dataTransfer.getData("regName"),i=e.dataTransfer.getData("fromSheetId"),t)&&i!==r.id&&!r.registerNames.includes(t)&&(r.registerNames.push(t),this.saveRegisterSheets(),this.$message.success("已复制到页签: "+r.name)))},showContextMenu(e,t){this.contextMenuReg=t,this.contextMenuPos={x:e.clientX,y:e.clientY},this.contextMenuVisible=!0;let s=()=>{this.contextMenuVisible=!1,document.removeEventListener("click",s)};document.addEventListener("click",s)},addRegToSheet(e,t){var s=this.registerSheets.find(e=>e.id===t);s&&e&&(s.registerNames.includes(e.name)?this.$message.warning("该寄存器已存在于目标页签"):(s.registerNames.push(e.name),this.saveRegisterSheets(),this.$message.success("已添加到页签: "+s.name))),this.contextMenuVisible=!1},removeRegFromCurrentSheet(t){var e;"root"!==this.activeSheetId&&t&&((e=this.currentSheet).registerNames=e.registerNames.filter(e=>e!==t.name),this.saveRegisterSheets(),this.$message.success("已从当前页签删除"),this.contextMenuVisible=!1)},async refreshDeviceInfoFromSignals(){var t,s;if(this.wsConnected)try{if(this.deviceConnected){var i=["NAME","VERSION","HVERSION","SN","MFILE"];let e=new Map;try{var a=await wsClient.getSignals(this.device_id,this.loader_num,i);e=this.signalsToMap(a)}catch(e){console.warn("[DeviceInfo] Failed to get essential registers:",e)}var r,n,o=e.get("NAME"),l=e.get("VERSION"),d=e.get("HVERSION"),c=e.get("SN"),h=e.get("MFILE"),u=(null!=o&&String(o).trim()&&(this.deviceNameFromRegister=String(o)),null!=c&&String(c).trim()&&(r=this.formatSN(c),this.deviceInfo.sn=r,this.deviceSN=String(c)),null!=d&&String(d).trim()&&(this.deviceInfo.hardwareVersion=String(d)),null!=l&&String(l).trim()&&(this.deviceInfo.softwareVersion=String(l)),null!=h?String(h).trim():""),m=this.otaKey(this.device_id,this.loader_num);this.$set(this.deviceSignalCache,m,{...this.deviceSignalCache[m]||{},MFILE:u});!u||u.toLowerCase().includes("example")||(t=u)&&-1!==(s=(t=String(t).toUpperCase()).indexOf("->"))&&"FAIL:MFILE"===t.substring(0,s).trim()?(this.isModelRunning=!1,this.runningFile="",this.runningModule=""):(this.isModelRunning=!0,2<=(n=u.split(/[\/\\]/)).length?(this.runningFile=n[0],this.runningModule=n[1]):(this.runningFile=u,this.runningModule=""))}else this.isModelRunning=!1,this.runningFile=""}catch(e){this.isModelRunning=!1,this.runningFile=""}},openModelDialog(){this.dialogModelVisible=!0,this.loadModelTree()},openUpgradeDialog(){this.dialogUpgradeVisible=!0},openLogDialog(){this.dialogLogVisible=!0,this.loadLogTree()},openConsoleDrawer(){this.drawerConsoleVisible=!0},toBool(e){return!0===e||!1!==e&&("true"===(e=String(e).toLowerCase().trim())||"1"===e||"yes"===e||"y"===e)},deviceLedClass(e){var t;return e&&this.toBool(e.connect)?(t=this.getDeviceKey(e),(t=this.otaStatus[t])&&"running"===t.status?"upgrading":this.toBool(e.interrupt)||this.toBool(e.high_temp_alarm)||this.toBool(e.busy)?"alarm":this.toBool(e.running)?"running":"connected"):""},getDeviceKey(e){return e?String(e.ip)+"#"+Number(e.loader_num):""},isSelectedDevice(e){return this.selectedDeviceKey&&this.selectedDeviceKey===this.getDeviceKey(e)},async selectDevice(t){if(t){var s=this.device_id,i=this.loader_num;let e=this.registerSheets.find(e=>e.timerEnabled);if(this.wsConnected&&e)try{await wsClient.stopRefreshRegs(),console.log("[Device] 切换设备，已停止原设备的定时刷新寄存器")}catch(e){console.error("[Device] 停止定时刷新失败:",e)}this.selectedDeviceKey=this.getDeviceKey(t),t.ip&&(this.device_id=String(t.ip)),Number.isFinite(Number(t.loader_num))&&(this.loader_num=Number(t.loader_num)),this.deviceConnected=!!t.connect,this.syncDeviceInfoFromStatus(t),!e||s===this.device_id&&i===this.loader_num?this.registerSheets.forEach(e=>{e.timerEnabled&&e.timerId&&(e.timerId=null,this.$set(e,"timerEnabled",!1))}):(this.registerSheets.forEach(e=>{e.timerEnabled&&(e.timerId=null,this.$set(e,"timerEnabled",!1))}),this.deviceConnected&&this.wsConnected&&e.id===this.activeSheetId&&this.$nextTick(()=>{this.$set(e,"timerEnabled",!0),this.startSheetTimer(e),console.log("[Device] 已在新设备上重新启动定时刷新:",e.name)}))}},syncDeviceInfoFromStatus(e){var t,s,i;(e=e||this.currentDeviceEntry)&&(this.deviceInfo={sn:this.formatSN(e.sn||this.deviceInfo.sn),hardwareVersion:e.hversion||this.deviceInfo.hardwareVersion||"",softwareVersion:e.version||this.deviceInfo.softwareVersion||"",runTime:null!=e.total_time&&""!==String(e.total_time)?e.total_time+" h":this.deviceInfo.runTime||""},e.sn&&(this.deviceSN=String(e.sn)),e.name&&(this.deviceNameFromRegister=String(e.name)),!this.deviceConnected||(s=!0===e.running||"true"===String(e.running).toLowerCase(),t=e.running_model||"",!s)||!t||t.toLowerCase().includes("example")||(s=t)&&-1!==(i=(s=String(s).toUpperCase()).indexOf("->"))&&"FAIL:MFILE"===s.substring(0,i).trim()?(this.isModelRunning=!1,this.runningFile="",this.runningModule=""):(this.isModelRunning=!0,2<=(s=t.split(/[\/\\]/)).length?(this.runningFile=s[0],this.runningModule=s[1]):(this.runningFile=t,this.runningModule="")),void 0!==e.voltage&&(this.realtimeData.voltage=Number(e.voltage)),void 0!==e.current&&(this.realtimeData.current=Number(e.current)),void 0!==e.power&&(this.realtimeData.power=Number(e.power)),void 0!==e.temperature)&&(this.realtimeData.temperature=Number(e.temperature))},otaKey(e,t){return String(e)+"#"+Number(t)},updateOtaStatus(e,t){this.$set(this.otaStatus,e,{...t,lastUpdate:Date.now()})},getOtaProgress(e,t){e=this.otaKey(e,t),t=this.otaProgress[e];return"number"==typeof t?t:0},getOtaProgressStatus(e,t){e=this.otaKey(e,t),t=this.otaStatus[e]||{};return"success"===t.status?"success":"error"===t.status||"failed"===t.status?"exception":void 0},getOtaStatusText(e,t){var s=this.otaKey(e,t),s=this.otaStatus[s];return s&&s.desc?s.desc:0<(s=this.getOtaProgress(e,t))&&s<100?`升级中… ${s.toFixed(1)}%`:"—"},async checkCloudNewVersion(){if(this.wsConnected){this.otaLoading=!0;try{var e=await wsClient.checkLoadersNewVersion(),t=e&&void 0!==e.data?e.data:e;if(t&&!1===t.ret)throw new Error(t.desc||"check failed");var s,i=t&&t.desc||[];this.otaGroups=Array.isArray(i)?i:[],this.otaCloudCheckedAt=(new Date).toLocaleString(),this.otaCloudMsg="",this.otaCloudStatus=this.otaGroups.length?"ok":"empty";for(s of this.otaGroups)for(var a of s.devices||[]){var r=this.otaKey(s.ip,a.loader_num),n=Number(a.progress);Number.isFinite(n)&&this.$set(this.otaProgress,r,n)}this.$message.success("已获取云端版本信息")}catch(e){this.otaCloudCheckedAt=(new Date).toLocaleString(),this.otaCloudStatus="error",this.otaCloudMsg=e&&e.message?e.message:String(e),this.$message.error("检查失败: "+(e.message||e))}finally{this.otaLoading=!1}}},async startOta(e,t){if(this.wsConnected){var s=this.otaKey(e,t);this.otaUpdatingKey=s,this.updateOtaStatus(s,{status:"running",desc:"已发起升级"}),this.$message.success("升级请求已发送");try{var i=await wsClient.updateOneLoader(String(e),Number(t)),a=i&&void 0!==i.data?i.data:i;if(a&&!1===a.ret)throw new Error(a.desc||"update failed")}catch(e){this.updateOtaStatus(s,{status:"error",desc:e.message||"升级失败"}),this.$message.error("升级失败: "+(e.message||e))}finally{this.otaUpdatingKey=""}}},openLocalUpgrade(e){this.localUpgradeTarget={ip:e.ip,loader_num:e.loader_num,loader_name:e.loader_name||""},this.localUpgradePath="",this.dialogLocalUpgradeVisible=!0},async confirmLocalUpgrade(){var e=(this.localUpgradePath||"").trim();if(e)if(e.toLowerCase().endsWith(".hex")){if(!this.localUpgradeLoading){this.dialogLocalUpgradeVisible=!1,this.localUpgradeLoading=!0;var t=this.otaKey(this.localUpgradeTarget.ip,this.localUpgradeTarget.loader_num);this.$message.success("近端升级已启动"),this.updateOtaStatus(t,{status:"running",desc:"近端升级中…"}),this.otaUpdatingKey=t;try{var s=await wsClient.loaderOta(this.localUpgradeTarget.ip,this.localUpgradeTarget.loader_num,e),i=s&&void 0!==s.data?s.data:s;if(i&&!1===i.ret)throw new Error(i.desc||"近端升级失败");this.localUpgradePath=""}catch(e){this.$message.error("近端升级失败: "+(e.message||e)),this.dialogLocalUpgradeVisible=!0}finally{this.localUpgradeLoading=!1}}}else this.$message.warning("文件路径必须以 .hex 结尾");else this.$message.warning("请输入 .hex 文件的绝对路径")},pushConsole(e,t){var s=(new Date).toLocaleString();this.consoleHistory.push({ts:s,dir:e,text:String(t??"")}),200<this.consoleHistory.length&&this.consoleHistory.splice(0,this.consoleHistory.length-200)},async sendConsoleCmd(){try{var e,t,s,i=String(this.consoleInput||"").trim();i&&(this.pushConsole("out",i),this.consoleInput="",s=(t=(e=await wsClient.sendCmd(this.device_id,this.loader_num,i,!1))&&void 0!==e.data?e.data:e)&&void 0!==t.desc?t.desc:JSON.stringify(t),this.pushConsole("in",s))}catch(e){this.pushConsole("in","ERROR: "+(e.message||e))}},normalizeTree(e){if(!e)return null;if(Array.isArray(e))return e.map(e=>this.normalizeTree(e)).filter(Boolean);var t=void 0!==e.label?String(e.label):void 0!==e.name?String(e.name):"";let s=[];return Array.isArray(e.children)?s=e.children:Array.isArray(e.desc)&&(s=e.desc),{label:t,children:s.map(e=>this.normalizeTree(e)).filter(Boolean)}},findNodeByLabel(e,t){var s,e=Array.isArray(e)?e:[],i=String(t).toLowerCase();for(s of e)if(s){if(s.label&&String(s.label).toLowerCase()===i)return s;var a=this.findNodeByLabel(s.children,i);if(a)return a}return null},async loadFileTreeRoot(){var e;return this.wsConnected?(e=(e=await wsClient.getFileInfo(this.device_id,this.loader_num,""))&&void 0!==e.data?e.data:e,e=this.normalizeTree(e),Array.isArray(e)?e:e&&!e.label&&e.children&&e.children.length?e.children:e&&(e.label||e.children&&e.children.length)?[e]:[]):[]},async loadModelTree(){this.modelTreeLoading=!0;try{var e=await this.loadFileTreeRoot(),t=e[0]||null,s=((t&&Array.isArray(t.children)?t.children:e)||[]).filter(e=>e&&e.label&&"log"!==e.label.toLowerCase());this.modelTreeData=s}catch(e){this.modelTreeData=[]}finally{this.modelTreeLoading=!1}},async loadLogTree(){this.logTreeLoading=!0;try{var e=await this.loadFileTreeRoot(),t=this.findNodeByLabel(e,"log");this.logTreeData=t?[t]:[]}catch(e){console.error("[LogTree] Failed:",e),this.logTreeData=[]}finally{this.logTreeLoading=!1}},async loadFetchTree(){this.fetchTreeLoading=!0;try{var e=await this.loadFileTreeRoot(),t=(Array.isArray(e)?e:[e]).filter(e=>e&&"log"!==String(e.label).toLowerCase());this.fetchTreeData=t}catch(e){console.error("[FetchTree] Failed:",e),this.fetchTreeData=[]}finally{this.fetchTreeLoading=!1}},async handleDownloadDevice(){this.dialogFetchVisible=!0,this.loadFetchTree()},async confirmFetchFile(e,t){if(e&&!(e.children&&0<e.children.length)){e=this.buildFullPath(t);try{this.$message.info(`正在从设备获取文件: ${e}...`),this.wsConnected?(await wsClient.downloadFromDevice(this.device_id,this.loader_num,e),this.$message.success("文件获取成功，已存入服务器本地"),this.dialogFetchVisible=!1,await this.parseAllFiles()):(this.$message.success("已从设备获取文件 (模拟)"),this.dialogFetchVisible=!1)}catch(e){this.$message.error("获取失败: "+(e.message||e))}}},async handleDeleteFetchFile(e,t){if(e&&e.label){t=this.buildFullPath(t),e=e.children&&0<e.children.length;try{await this.$confirm(`确定要从设备上删除${e?"目录":"文件"} "${t}" 吗？`+(e?"该操作将删除目录下所有内容！":""),"删除确认",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"});var s=await wsClient.delFile(this.device_id,this.loader_num,t),i=s&&void 0!==s.data?s.data:s;if(i&&(!1===i.ret||!1===i.success))throw new Error(i.desc||i.msg||"删除失败");this.$message.success(`${e?"目录":"文件"}删除成功`),this.loadFetchTree()}catch(e){"cancel"!==e&&this.$message.error("删除失败: "+(e.message||e))}}},buildFullPath(e){var t=[];let s=e;for(;s&&s.data&&0<s.level;)t.unshift(s.data.label),s=s.parent;return t.join("/")},async handlePullLog(e,t){if(e&&e.label){e=this.buildFullPath(t);try{this.$message.info(`正在拉取: ${e}...`);var s=await wsClient.pullLoaderLog(this.device_id,this.loader_num,e),i=s&&void 0!==s.data?s.data:s;if(i&&(!1===i.ret||!1===i.success))throw new Error(i.desc||i.msg||"拉取失败");this.$message.success("拉取成功")}catch(e){this.$message.error("拉取失败: "+(e.message||e))}}},async handleDeleteLog(e,t){if(e&&e.label){t=this.buildFullPath(t),e=e.children&&0<e.children.length;try{await this.$confirm(`确定要删除设备上的${e?"目录":"文件"} "${t}" 吗？`+(e?"该操作将删除目录下所有内容！":""),"删除确认",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"});var s=await wsClient.delFile(this.device_id,this.loader_num,t),i=s&&void 0!==s.data?s.data:s;if(i&&(!1===i.ret||!1===i.success))throw new Error(i.desc||i.msg||"删除失败");this.$message.success("删除成功"),this.loadLogTree()}catch(e){"cancel"!==e&&this.$message.error("删除失败: "+(e.message||e))}}},async loadDeviceSpecsConfig(){try{var e=await fetch("device_specs.json");this.deviceSpecsConfig=await e.json()}catch(e){console.warn("[spec] load device_specs.json failed:",e),this.deviceSpecsConfig=null}},async tryReadDeviceNameFromRegister(){try{let t=(this.registerDefsAll||this.registers||[]).find(e=>e&&"NAME"===e.name);if(t){var s,i,a=await wsClient.getSignals(this.device_id,this.loader_num,t.name),r=a&&void 0!==a.data?a.data:a;let e=null;r&&void 0!==r.value?e=r.value:r&&r.data&&void 0!==r.data.value?e=r.data.value:Array.isArray(r)?(s=r.find(e=>e&&e.name===t.name))&&void 0!==s.value&&(e=s.value):r&&Array.isArray(r.data)&&(i=r.data.find(e=>e&&e.name===t.name))&&void 0!==i.value&&(e=i.value),null!=e&&(this.deviceNameFromRegister=String(e))}}catch(e){}},async loadLocationInfo(){try{var e,t=await wsClient.queryLocationInfo(),s=t&&t.data?t.data:t;s&&s.location_list&&(this.locationList=s.location_list||[],(e=s.loader_location||"")?(this.selectedLocation=e,this.isLocationRegistered=!0):(this.selectedLocation="未设置",this.isLocationRegistered=!1))}catch(e){console.warn("[ws] query_location_info failed:",e),this.selectedLocation="未设置",this.isLocationRegistered=!1}},async handleSaveLocation(){if(this.selectedLocation&&"未设置"!==this.selectedLocation)try{var e=await wsClient.saveLocationInfo(this.selectedLocation),t=e&&e.data?e.data:e;!t||!0!==t.ret&&"true"!==t.ret?this.$message.error(t&&t.desc||"保存实验室位置失败"):(this.$message.success("实验室位置保存成功"),this.isLocationRegistered=!0)}catch(e){this.$message.error("保存失败: "+e.message)}else this.$message.warning("请先选择实验室")},onLocationChanged(){},async refreshModelOptions(){this.modelOptionsLoading=!0;try{var e=await wsClient.getModels(this.device_id,this.loader_num,this.currentSimType),t=e&&e.data?e.data:e;t&&(!0===t.ret||"true"===t.ret)?(this.modelOptions=t.desc||[],this.$message.success("模型列表已刷新")):(this.$message.error(t&&t.desc||"获取模型列表失败"),this.modelOptions=[])}catch(e){this.$message.error("获取模型列表失败: "+e.message)}finally{this.modelOptionsLoading=!1}},async startSelectedModel(){if(this.canStartSelected)try{var e=await wsClient.startLoader(this.device_id,this.loader_num,this.selectedModelPath,this.currentSimType),t=e&&e.data?e.data:e;t&&!1===t.ret?this.$message.error(t.desc||"启动失败"):this.$message.success(t&&t.desc||"已发送启动命令")}catch(e){this.$message.error("启动失败: "+e.message)}else this.$message.warning("请先选择项目/模型")},async stopSelectedModel(){if(this.canStopSelected)try{var t=this.runningFile||(Array.isArray(this.selectedModelPath)&&2<=this.selectedModelPath.length?this.selectedModelPath:["project1","model"]),s=await wsClient.stopLoader(this.device_id,this.loader_num,t,"data_replay");let e=s&&s.data?s.data:s;e&&!1===e.ret&&(console.log("[WS] data_replay 停止失败，尝试 component_emulation"),s=await wsClient.stopLoader(this.device_id,this.loader_num,t,"component_emulation"),e=s&&s.data?s.data:s),e&&!1===e.ret?this.$message.error(e.desc||"停止失败"):(this.isModelRunning=!1,this.runningFile="",this.runningModule="",this.$message.success(e&&e.desc||"已发送停止命令"))}catch(e){this.$message.error("停止失败: "+e.message)}else this.$message.warning("当前没有运行中的模型")},async loadModelDictionary(){try{try{var e=await fetch("model_dictionary.json",{cache:"no-cache"});if(e.ok){var t=await e.json();if(t&&t.parameters&&t.modules)return this.modelDictionary={parameters:t.parameters,modules:t.modules},void(modelDictionary=this.modelDictionary)}}catch(e){}if(this.wsConnected){var s=await wsClient.request("model.dictionary");if(s&&s.parameters&&s.modules)return this.modelDictionary={parameters:s.parameters,modules:s.modules},void(modelDictionary=this.modelDictionary)}var i=await(await fetch("/api/model/dictionary")).json();i&&i.parameters&&i.modules&&(this.modelDictionary={parameters:i.parameters,modules:i.modules},modelDictionary=this.modelDictionary)}catch(e){console.warn("[model] loadModelDictionary failed:",e)}},async loadRegisterDefinitions(){try{let e=null;try{var t,s=await fetch("register_definitions.json",{cache:"no-cache"});s.ok&&(t=await s.json(),e=t&&t.definitions)}catch(e){}var i,a;!e&&this.wsConnected&&(i=await wsClient.request("register.definitions"),e=i&&i.definitions),e||(a=await(await fetch("/api/register/definitions")).json(),e=a&&a.definitions),Array.isArray(e)&&(this.registerDefsAll=e,this.registers=e.map(e=>({address:"number"==typeof e.address?e.address:"string"==typeof e.id&&e.id.startsWith("0x")?parseInt(e.id,16):"number"==typeof e.id?e.id:0,name:e.name,type:e.type,access:e.access,description:e.description||"",min:"number"==typeof e.min?e.min:null,max:"number"==typeof e.max?e.max:null,value:null,inputValue:null,loading:!1,modified:!1,readError:!1})))}catch(e){console.warn("[register] loadRegisterDefinitions failed:",e)}},async parseAllFiles(){try{if(await this.loadModelDictionary(),this.wsConnected)try{var t,e=await wsClient.getLocalFileList(),s=e&&e.data?e.data:e;if(s&&!0===s.ret&&Array.isArray(s.desc)&&0<s.desc.length){this.models=s.desc.map(e=>({filename:e.filename||e.name||"unknown.bin",path:e.path||e.filename||e.name||"unknown.bin",success:!1,modules:[],raw:"",modified:!1,errors:[],warnings:[]}));let e=!1;return this.isModelRunning&&this.runningFile&&-1!==(t=this.models.findIndex(e=>this.isFileRunning(e.filename)))&&(this.selectModel(t),e=!0,console.log("[参数编辑] 自动选中运行中模型:",this.models[t].filename)),e||(this.activeModelIndex=-1),void console.log("[参数编辑] 成功加载文件列表，共",this.models.length,"个文件")}return console.warn("[参数编辑] 文件列表为空或格式不正确:",s),this.models=[],void(this.activeModelIndex=-1)}catch(e){return console.error("[参数编辑] 获取文件列表失败:",e),this.models=[],void(this.activeModelIndex=-1)}await this.loadSampleFiles(),this.activeModelIndex=0,this.expandedModules={0:!0,1:!0}}catch(e){console.error("加载模型列表失败:",e),this.models=[],this.activeModelIndex=-1}},async loadSampleFiles(){var e,t=[];for(e of Object.keys(sampleFiles)){var s=await parseBinByServer(e);t.push(s&&s.success?s:{success:!1,filename:e,modules:[],errors:s.errors||[{message:s.error||"解析失败",lineNum:0}],warnings:[],raw:sampleFiles[e]})}this.models=t,console.log("[模拟] 使用本地示例文件")},async switchPage(e){this.activePage!==e&&("model"===this.activePage&&!await this.confirmUnsavedChanges()||(this.activePage=e))},async confirmUnsavedChanges(){if(!this.hasModified)return!0;try{var e,t=await this.$confirm("当前文件有未保存的修改，是否保存？","提示",{confirmButtonText:"保存并切换",cancelButtonText:"放弃修改并切换",distinguishCancelAndClose:!0,type:"warning"}).then(()=>"save").catch(e=>"cancel"===e?"discard":"cancel");return"save"===t?(await this.handleSave(),!0):"discard"===t&&((e=this.models[this.activeModelIndex])&&(e.success=!1,e.modules=[]),!(this.hasModified=!1))}catch(e){return!1}},async handleSelectModel(e){this.activeModelIndex!==e&&await this.confirmUnsavedChanges()&&this.selectModel(e)},async selectModel(t){this.activeModelIndex=t;t=this.models[t];if(t){if(!t.success&&t.path&&this.wsConnected)try{t.loading=!0;var e=await wsClient.readLocalFile(t.path),s=e&&void 0!==e.data?e.data:e;if(!s||!0!==s.success&&!0!==s.ret)throw new Error(s?.desc||s?.msg||"读取文件失败");var i=!0===s.ret&&s.data?s.data:s;if(!1===i.success)throw new Error(i.desc||i.msg||"文件解析失败");Object.assign(t,{success:!0,filename:i.filename||t.filename,modules:i.modules||[],raw:i.content||"",path:t.path,modified:!1,loading:!1,errors:i.errors||[],warnings:i.warnings||[]})}catch(e){console.error("读取文件失败:",e),t.loading=!1,t.success=!1,t.errors=[{message:e.message||"读取失败",lineNum:0}],this.$message.error("读取文件失败: "+(e.message||e))}this.showRaw=!1,this.hasModified=!1,this.currentModel&&this.isFileRunning(this.currentModel.filename)?(e=this.currentModel.modules.findIndex(e=>e.name===this.runningModule),this.expandedModules=-1!==e?{[e]:!0}:{0:!0}):this.expandedModules={0:!0}}},toggleModule(e){this.$set(this.expandedModules,e,!this.expandedModules[e])},updateArrayParam(e,t,s){t.value=s.trim().split(/\s+/).map(e=>{var t=parseFloat(e);return isNaN(t)?e:t}),this.hasModified=!0},toggleConnect(){this.deviceConnected=!this.deviceConnected,this.deviceConnected||(this.isModelRunning=!1)},isFileRunning(e){var t;return!!(this.isModelRunning&&this.runningFile&&e)&&(t=e=>String(e).split("/").pop().split("\\").pop().replace(/\.(bin|json)$/i,""))(this.runningFile)===t(e)},isModuleRunning(e,t){return this.isFileRunning(e)&&this.runningModule===t},getParamDef(e){return(this.modelDictionary&&this.modelDictionary.parameters||{})[e]},getModuleDef(e){return(this.modelDictionary&&this.modelDictionary.modules||{})[e]},getModuleDisplayName(e){var t=this.getModuleDef(e);return t?t.name+` (${e})`:e},getPrecision(e){var t,e=this.getParamDef(e);return e&&e.step?-1===(t=(e=e.step.toString()).indexOf("."))?0:e.length-t-1:2},isOutOfRange(e){var t,s=this.getParamDef(e.name);return!(!s||void 0===s.min||"single"!==e.type||(e=parseFloat(e.value),t=parseFloat(s.min),s=parseFloat(s.max),isNaN(e)))&&(e<t-1e-9||s+1e-9<e)},isNumericParam(e){return"number"==typeof e.value||!isNaN(parseFloat(e.value))},updateSingleParam(e,t){var s;null==t||isNaN(t)?(s=this.getParamDef(e.name),e.value=s&&void 0!==s.default?s.default:0):e.value=t,this.hasModified=!0},addArrayItem(e){var t=0<e.value.length?e.value[e.value.length-1]:0;e.value.push("number"==typeof t?0:""),this.hasModified=!0},removeArrayItem(e,t){e.value.splice(t,1),this.hasModified=!0},updateArrayItem(e,t,s){null==s||isNaN(s)?e.value[t]=0:e.value[t]=s,this.hasModified=!0},updateArrayItemStr(e,t,s){e.value[t]=s,this.hasModified=!0},addMatrixRow(e){var t;0<e.value.length?(t=e.value[0].length,e.value.push(new Array(t).fill(0))):e.value.push([0,0,0]),this.hasModified=!0},removeMatrixRow(e,t){1<e.value.length?(e.value.splice(t,1),this.hasModified=!0):this.$message.warning("至少保留一行数据")},updateMatrixCell(e,t,s,i){null==i||isNaN(i)?e.value[t][s]=0:e.value[t][s]=i,this.hasModified=!0},async handleSave(){if(this.currentModel&&this.currentModel.path)try{var e={filename:this.currentModel.filename,modules:this.currentModel.modules},t=this.generateBinContent();this.wsConnected?(await wsClient.saveLocalFile(this.currentModel.path,e),this.$message.success("文件已保存到服务器本地")):(console.log("[模拟] 保存文件:",this.currentModel.filename),this.$message.success("文件已保存 (模拟)")),this.hasModified=!1,this.currentModel.raw=t}catch(e){this.$message.error("保存失败: "+e.message)}},async handleSaveAs(){if(this.currentModel)try{var e=this.generateBinContent(),t=this.currentModel.filename||"model.bin";if(window.showSaveFilePicker)try{var s=await(await window.showSaveFilePicker({suggestedName:t,types:[{description:"模型文件",accept:{"text/plain":[".bin"]}}]})).createWritable();return await s.write(e),await s.close(),void this.$message.success("文件已保存到本地")}catch(e){if("AbortError"===e.name)return;console.warn("showSaveFilePicker failed, falling back to download:",e)}var i=new Blob([e],{type:"text/plain"}),a=URL.createObjectURL(i),r=document.createElement("a");r.href=a,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),this.$message.success("已触发浏览器下载")}catch(e){console.error("另存为失败:",e),this.$message.error("保存失败: "+(e.message||e))}},handleCreateNewModel(){this.newModelFilename="",this.dialogNewModelVisible=!0},async confirmCreateNewModel(){var e=this.newModelFilename.trim();if(e){let s=e.endsWith(".bin")?e:e+".bin";try{var i={filename:s,modules:[]},t=`# New Model: ${s}
# Created at: ${(new Date).toLocaleString()}
`;if(this.wsConnected){let t=s;await wsClient.saveLocalFile(t,i),this.$message.success(`模型文件 ${s} 创建成功`),this.dialogNewModelVisible=!1,await this.parseAllFiles();var a=this.models.findIndex(e=>e.path===t||e.filename===s);-1!==a&&await this.selectModel(a)}else{this.models.push({filename:s,path:s,raw:t,modules:[],success:!0,modified:!1,errors:[],warnings:[]}),this.$message.success(`模型文件 ${s} 创建成功 (模拟)`),this.dialogNewModelVisible=!1;var r=this.models.findIndex(e=>e.filename===s);-1!==r&&(this.activeModelIndex=r)}}catch(e){this.$message.error("创建失败: "+(e.message||e))}}},handleOpenAddModuleDialog(){this.currentModel&&(this.selectedModuleType="",this.dialogAddModuleVisible=!0)},getModuleDesc(e){return e&&this.modelDictionary&&this.modelDictionary.modules&&this.modelDictionary.modules[e]&&this.modelDictionary.modules[e].description||"无描述"},confirmAddModule(){if(this.selectedModuleType&&this.currentModel)if(this.currentModel.modules&&this.currentModel.modules.some(e=>e.name===this.selectedModuleType))this.$message.warning("该模块已存在，请勿重复添加");else{var e=this.modelDictionary.modules[this.selectedModuleType];if(e){let i={name:this.selectedModuleType,params:[]};e.parameters&&Array.isArray(e.parameters)&&e.parameters.forEach(t=>{var s=this.modelDictionary.parameters[t];if(s){let e;e="array"===s.type?void 0!==s.default?[...s.default]:[]:"matrix"===s.type?void 0!==s.default?s.default.map(e=>[...e]):[[0,0,0]]:void 0!==s.default?s.default:void 0!==s.min?s.min:0,i.params.push({name:t,type:s.type||"single",value:e})}}),this.currentModel.modules||this.$set(this.currentModel,"modules",[]),this.currentModel.modules.push(i),this.hasModified=!0,this.dialogAddModuleVisible=!1;e=this.currentModel.modules.length-1;this.$set(this.expandedModules,e,!0),this.$message.success("已添加模块: "+this.selectedModuleType)}}},handleOpenAddParamDialog(e){var t;!this.currentModel||!this.currentModel.modules||e<0||(t=this.currentModel.modules[e])&&(this.isModuleRunning(this.currentModel.filename,t.name)?this.$message.warning("该模块正在运行中，无法添加参数"):(this.selectedModuleIndexForParam=e,this.selectedParamName="",this.dialogAddParamVisible=!0))},confirmAddParam(){if(this.selectedParamName&&!(this.selectedModuleIndexForParam<0)&&this.currentModel){var s=this.currentModel.modules[this.selectedModuleIndexForParam];if(s)if(s.params.some(e=>e.name===this.selectedParamName))this.$message.warning("该参数已存在");else{var i=this.modelDictionary.parameters[this.selectedParamName];if(i){var a=this.modelDictionary.modules[s.name];if(a&&a.allowed_param_ids&&i.id&&!a.allowed_param_ids.includes(i.id))this.$message.error(`模块 ${s.name} 不允许使用参数 ${this.selectedParamName} (ID: ${i.id})`);else{let e,t="single";e="array"===i.type?(t="array",void 0!==i.default?[...i.default]:[]):"matrix"===i.type?(t="matrix",void 0!==i.default?i.default.map(e=>[...e]):[[0,0,0]]):"boolean"===i.type?(t="single",void 0!==i.default?i.default:i.options&&0<i.options.length?i.options[0]:0):(t="single",void 0!==i.default?i.default:void 0!==i.min?i.min:0);a={name:this.selectedParamName,type:t,value:e};s.params||this.$set(s,"params",[]),s.params.push(a),this.hasModified=!0,this.dialogAddParamVisible=!1,this.$message.success("已添加参数: "+this.selectedParamName)}}else this.$message.error("参数定义不存在")}}},handleRemoveParam(e,s){if(this.currentModel&&this.currentModel.modules&&!(e<0)){let t=this.currentModel.modules[e];if(!(!t||!t.params||s<0||s>=t.params.length))if(this.isModuleRunning(this.currentModel.filename,t.name))this.$message.warning("该模块正在运行中，无法删除参数");else{let e=t.params[s];this.$confirm(`确定要从模块 ${t.name} 中移除参数 ${e.name} 吗？`,"移除参数",{confirmButtonText:"移除",cancelButtonText:"取消",type:"info"}).then(()=>{t.params.splice(s,1),this.hasModified=!0,this.$message.success("已移除参数: "+e.name)}).catch(()=>{})}}},async handleDeleteModel(e,t){if(this.isFileRunning(e.filename))this.$message.error("该模型文件正在运行中，无法删除");else try{await this.$confirm(`确定要删除模型文件 ${e.filename} 吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),this.wsConnected&&e.path?(await wsClient.deleteLocalFile(e.path),this.$message.success("文件已删除"),await this.parseAllFiles(),this.activeModelIndex>=this.models.length&&(this.activeModelIndex=Math.max(-1,this.models.length-1))):(this.models.splice(t,1),this.$message.success("文件已删除 (模拟)"))}catch(e){"cancel"!==e&&this.$message.error("删除失败: "+e.message)}},handleRemoveModule(t){if(this.currentModel&&this.currentModel.modules){let e=this.currentModel.modules[t];this.isModuleRunning(this.currentModel.filename,e.name)?this.$message.error("该模块正在运行中，无法移除"):this.$confirm(`确定要从模型中移除模块 ${e.name} 吗？`,"移除模块",{confirmButtonText:"移除",cancelButtonText:"取消",type:"info"}).then(()=>{this.currentModel.modules.splice(t,1),this.hasModified=!0,this.$message.success("已移除模块: "+e.name)}).catch(()=>{})}},async handleApply(){if(this.canApply&&this.currentModel)try{if(this.runningModule){var e=this.currentModel.modules.find(e=>e.name===this.runningModule);if(e){let t={};e.params.forEach(e=>{t[e.name]=e.value}),this.wsConnected?(await wsClient.applyParamsToDevice(this.device_id,this.loader_num,t),this.$message.success("参数已成功应用到运行模块")):(console.log("[模拟] 应用参数到设备模块:",this.runningModule,t),this.$message.success("参数已应用到模块 (模拟)"))}else this.$message.warning("当前模型文件中未找到运行中的模块: "+this.runningModule)}else this.$message.warning("当前没有运行中的模块，无法应用参数")}catch(e){this.$message.error("应用失败: "+e.message)}},async handleUploadCloud(){if(this.currentModel&&this.currentModel.path)try{this.wsConnected?(await wsClient.uploadToCloud(this.currentModel.path),this.$message.success("已上传到云端")):(console.log("[模拟] 上传云端"),this.$message.success("已上传到云端 (模拟)"))}catch(e){this.$message.error("上传失败: "+e.message)}},async handleGetCloudList(){try{var e;this.wsConnected?(e=await wsClient.getCloudFileList(this.deviceSN),console.log("云端文件列表:",e.files),this.$message.success(`获取到 ${e.files.length} 个云端文件`)):(console.log("[模拟] 获取云端文件列表"),this.$message.info("云端文件列表 (模拟)"))}catch(e){this.$message.error("获取失败: "+e.message)}},async refreshDeviceInfo(){try{this.syncDeviceInfoFromStatus(),await this.refreshDeviceInfoFromSignals(),this.$message.success("设备信息已刷新")}catch(e){console.error("刷新设备信息失败:",e)}},async readRegister(s,i=0){if(this.deviceConnected){s.loading=!0;try{if(this.wsConnected){var a=await wsClient.waitRegValue(this.device_id,this.loader_num,s.name);let t=a;if(a&&"object"==typeof a&&void 0!==a.data)if("string"==typeof a.data)try{t=JSON.parse(a.data)}catch(e){t=a.data}else t=a.data;if(!t||!0!==t.ret&&"true"!==t.ret)throw new Error(t&&t.desc?String(t.desc):"读取失败");var e=void 0!==t.desc?String(t.desc):"";if((""===e||"null"===e||"Null"===e||"NULL"===e)&&i<3)return console.log(`[Register] ${s.name} 读取值为空，重试 ${i+1}/3`),s.loading=!1,await new Promise(e=>setTimeout(e,300)),this.readRegister(s,i+1);s.value=e,s.readError=!1,0===i?this.$message.success(`寄存器 ${s.name} 读取成功`):this.$message.success(`寄存器 ${s.name} 读取成功（重试${i}次）`)}else console.log("[模拟] 读取寄存器 "+s.name),"int"===s.type?s.value=Math.floor(1e4*Math.random()):s.value=s.value||"sample_string",s.readError=!1,this.$message.success(`寄存器 ${s.name} 读取成功 (模拟)`)}catch(e){if(i<3)return console.log(`[Register] ${s.name} 读取失败，重试 ${i+1}/3:`,e.message),s.loading=!1,await new Promise(e=>setTimeout(e,300)),this.readRegister(s,i+1);s.value="读取失败",s.readError=!0,this.$message.error("读取失败: "+e.message)}finally{s.loading=!1}}else this.$message.warning("设备未连接")},async writeRegister(s){if(this.deviceConnected)if(null===s.inputValue||""===s.inputValue)this.$message.warning("请输入要写入的值");else{var t=s.inputValue;try{if(this.wsConnected){var e=await wsClient.setRegValue(this.device_id,this.loader_num,s.name,t),i=e&&void 0!==e.data?e.data:e;if(i&&!1===i.ret)throw new Error(i.desc||"写入失败");try{var a,r=await wsClient.waitRegValue(this.device_id,this.loader_num,s.name);let t=r;if(r&&"object"==typeof r&&void 0!==r.data)if("string"==typeof r.data)try{t=JSON.parse(r.data)}catch(e){t=r.data}else t=r.data;!t||!0!==t.ret&&"true"!==t.ret||(a=void 0!==t.desc?String(t.desc):"","readwrite"!==s.access&&"read"!==s.access)||(s.value=a)}catch(e){console.warn("[Register] 写入后读取实际值失败:",e),"readwrite"===s.access&&(s.value=t)}}else console.log(`[模拟] 写入寄存器 0x${s.address.toString(16).toUpperCase()} = `+t),"readwrite"===s.access&&(s.value=t);s.inputValue=null,s.modified=!0,this.$message.success(`寄存器 ${s.name} 写入成功`),setTimeout(()=>{s.modified=!1},3e3)}catch(e){this.$message.error("写入失败: "+e.message)}}else this.$message.warning("设备未连接")},async refreshAllRegisters(){if(this.deviceConnected){this.registerLoading=!0;var e,t=this.registers.filter(e=>"write"!==e.access);for(e of t)e.loading=!0;try{if(this.wsConnected){var s=await wsClient.getSignals(this.device_id,this.loader_num);let e=[];if(Array.isArray(s))e=s;else if(s&&"object"==typeof s)if(void 0!==s.data){if(Array.isArray(s.data))e=s.data;else if("string"==typeof s.data)try{var i=JSON.parse(s.data);e=Array.isArray(i)?i:[]}catch(e){console.warn("[register] Failed to parse get_signals response:",e)}}else Array.isArray(s.list)&&(e=s.list);var a,r=new Map;for(a of e)a&&null!=a.name&&r.set(String(a.name),void 0!==a.value?String(a.value):"");var n,o,l=new Set;for(n of t)r.has(n.name)&&(n.value=r.get(n.name),n.readError=!1,n.loading=!1,l.add(n.name));for(o of t)l.has(o.name)||(o.value="读取失败",o.readError=!0,o.loading=!1);0<e.length?this.$message.success(`已刷新 ${l.size}/${t.length} 个寄存器`):this.$message.warning("未获取到寄存器数据，请检查设备连接")}else{console.log("[模拟] 刷新所有寄存器"),await new Promise(e=>setTimeout(e,500));for(var d of t)"int"===d.type&&(d.value=Math.floor(1e4*Math.random())),d.readError=!1,d.loading=!1;this.$message.success("所有寄存器已刷新 (模拟)")}}catch(e){this.$message.error("刷新失败: "+e.message);for(var c of t)c.loading=!1,c.value="读取失败",c.readError=!0}finally{this.registerLoading=!1}}else this.$message.warning("设备未连接")},async handleGetFileInfo(){try{var e=(await this.$prompt("请输入要查询的文件/目录名（可留空）","get_file_info",{confirmButtonText:"查询",cancelButtonText:"取消",inputValue:""})).value,t=await wsClient.getFileInfo(this.device_id,this.loader_num,e||""),s=t&&void 0!==t.data?t.data:t;console.log("[get_file_info]",s),this.$message.success("已获取文件信息（详见控制台 console.log）")}catch{}},async loadResourceNode(i,s){this.resourceLoadingCount++;try{let t="loader";if(0<i.level){var a=[];let e=i;for(;e&&0<e.level;)a.unshift(e.data.label),e=e.parent;t="loader/"+a.join("/")}console.log("[ResourceTree] Loading path:",t);var r=await wsClient.obtainLoaderDirStructure(t),n=r&&void 0!==r.data?r.data:r;let e=(Array.isArray(n.result)?n.result:[]).map(e=>{var t=e.label||"";let s=!1;return s=e.type?"file"===e.type:-1!==t.indexOf("."),{label:t,isLeaf:s,type:e.type||(s?"file":"folder"),path:(0<i.level?i.data.path+"/":"loader/")+t}});s(e),this.$nextTick(()=>{let t=this.$refs.resourceTree;t&&i.checked&&e.forEach(e=>{t.setChecked(e.path,!0);e=t.getNode(e.path);e&&!e.isLeaf&&e.expand()})})}catch(e){console.error("[ResourceTree] Load failed:",e),this.$message.error("加载资源列表失败: "+e.message),s([])}finally{this.resourceLoadingCount--}},handleResourceCheck(e,t){let s=this.$refs.resourceTree;e=s.getNode(e);if(e&&!e.isLeaf&&e.checked)if(e.expanded){let t=e=>{e.childNodes.forEach(e=>{s.setChecked(e.data.path,!0),e.isLeaf||(e.expanded?t(e):e.expand())})};t(e)}else e.expand();this.$nextTick(()=>{this.selectedResourceNodes=s.getCheckedNodes()})},handleResourceCheckChange(){this.$refs.resourceTree&&(this.selectedResourceNodes=this.$refs.resourceTree.getCheckedNodes())},handleResourceNodeClick(e,t){this.$refs.resourceTree.setChecked(e.path,!t.checked),this.handleResourceCheck(e,null)},handleLoadModelToDevice(){this.selectedResourceNodes=[],this.importDeviceType="current",this.dialogImportDeviceVisible=!0,this.isImporting=!1,this.resourceTreeKey++},refreshResourceTree(){this.resourceTreeKey++,this.selectedResourceNodes=[]},handleResourceNodeExpand(e,t){t.loaded=!1,t.loadData()},async confirmImportDevice(){if(this.selectedResourceNodes.length)if(0<this.resourceLoadingCount)this.$message.warning("正在加载目录内容，请稍候...");else try{this.isImporting=!0;let s=[],t=this.$refs.resourceTree;if(t.getCheckedNodes(!0,!1).forEach(e=>{var e=t.getNode(e);e&&(e=this.buildFullPath(e))&&s.push(e)}),0===s.length&&t.getCheckedNodes(!1,!1).forEach(e=>{var e=t.getNode(e);e&&(e=this.buildFullPath(e))&&s.push(e)}),0===s.length)this.$message.warning("未找到有效的导入路径"),this.isImporting=!1;else{var e=[...new Set(s)].filter(e=>"loader"!==e);this.$message.info(`正在开始批量导入 ${e.length} 个文件...`);let t=e=>{e=e&&void 0!==e.data?e.data:e;"Finished"===e.desc?(this.$message.success("已完成模型导入"),wsClient.off("load_model_batch",t),this.isImporting=!1,this.dialogImportDeviceVisible=!1):e.ret?this.$message.success(e.desc||"一个文件导入成功"):this.$message.error("导入出错: "+(e.desc||"未知错误"))};wsClient.on("load_model_batch",t);var i=await wsClient.loadModelBatch(this.device_id,this.loader_num,e),a=i&&void 0!==i.data?i.data:i;if(a&&!1===a.ret)throw new Error(a.desc||"批量导入请求失败")}}catch(e){this.$message.error("导入失败: "+(e.message||e)),this.isImporting=!1}else this.$message.warning("请先选择要导入的文件或文件夹")},async handleDownloadCloudModel(){try{var e=(await this.$prompt("请输入 project（工程名）","download_cloud_models",{confirmButtonText:"下一步",cancelButtonText:"取消",inputValue:"project1"})).value,t=(await this.$prompt("请输入 model_name（云端文件名，如 xxx.zip）","download_cloud_models",{confirmButtonText:"下一步",cancelButtonText:"取消",inputValue:"example.zip"})).value,s=await this.$prompt("请输入 model_id（整数）","download_cloud_models",{confirmButtonText:"下载",cancelButtonText:"取消",inputValue:"0",inputPattern:/^\d+$/,inputErrorMessage:"model_id 必须是数字"}),i=Number(s.value),a=await wsClient.downloadCloudModels(this.device_id,this.loader_num,t,i,e),r=a&&void 0!==a.data?a.data:a;if(r&&!1===r.ret)throw new Error(r.desc||"download_cloud_models failed");this.$message.success(r&&r.desc||"云端导入请求已发送"),await this.parseAllFiles()}catch(e){e&&e.message&&"cancel"!==e&&this.$message.error("云端导入失败: "+e.message)}},generateBinContent(){if(!this.currentModel||!this.currentModel.modules)return"";let e="";for(var t of this.currentModel.modules){e+=t.name+`
`;for(var s of t.params)if("matrix"===s.type){e+=s.name+`:
`;for(var i of s.value)e+=`    ${i.join(" ")}
`}else"array"===s.type?e+=`${s.name}:${s.value.join(" ")}\n`:e+=`${s.name}:${s.value}\n`;e+="\n"}return e+="END\n"},initWebSocket(){let u=this;wsClient.on("connected",()=>{u.wsConnected=!0,u.$message.success("WebSocket 已连接"),u.loadLocationInfo(),wsClient.startGetConnectStatus().catch(()=>{}),u.lastConnectStatusTime=Date.now(),u.hasRequestedConnectStatus=!1,u.loadRegisterSheets(),u.loadRegisterDefinitions().then(()=>u.refreshDeviceInfoFromSignals()),u.startConnectStatusMonitor(),u.startOtaTimeoutMonitor()}),wsClient.on("disconnected",()=>{u.wsConnected=!1,u.$message.warning("WebSocket 连接已断开"),u.stopConnectStatusMonitor(),u.stopOtaTimeoutMonitor(),u.markAllDevicesAsDisconnected()}),wsClient.on("reconnectFailed",()=>{u.$message.error("WebSocket 重连失败，请检查服务器")}),wsClient.on("error",e=>{console.error("[WS] 错误:",e)}),wsClient.on("refresh_signals",e=>{try{var t=Array.isArray(e)?e:e&&Array.isArray(e.data)?e.data:[];if(0<t.length){let s=u.signalsToMap(t);var i=u.registerSheets.find(e=>e.id===u.activeSheetId);if(i&&"register"===u.activePage){let t="root"===i.id?u.registers.map(e=>e.name):i.registerNames;u.registers.forEach(e=>{t.includes(e.name)&&s.has(e.name)&&(e.value=s.get(e.name),e.readError=!1)})}}}catch(e){console.warn("[UI] refresh_signals handler error:",e)}}),wsClient.on("device.statusUpdate",e=>{u.handleDeviceStatusUpdate(e)}),wsClient.on("register.changed",e=>{u.handleRegisterChanged(e)}),wsClient.on("get_connect_status",e=>{u.connectStatus=e||{};try{var t,s,i=u.connectStatus&&"object"==typeof u.connectStatus?u.connectStatus:{};for(t of Object.values(i))if(Array.isArray(t))for(var a of t)if(a)for(s of Array.isArray(a.value)?a.value:[a]){var r=u.otaKey(s.ip,s.loader_num);s&&s.is_upgrade?u.otaStatus[r]&&"success"===u.otaStatus[r].status||(u.otaStatus[r]&&"running"===u.otaStatus[r].status?u.otaStatus[r].lastUpdate=Date.now():u.updateOtaStatus(r,{status:"running",desc:"正在升级..."})):u.otaStatus[r]&&"running"===u.otaStatus[r].status&&100<=(u.otaProgress[r]||0)&&u.updateOtaStatus(r,{status:"success",desc:"升级成功"})}}catch(e){console.warn("[UI] OTA status sync from connectStatus failed:",e)}u.lastConnectStatusTime=Date.now(),u.hasRequestedConnectStatus=!1;try{if(!u.selectedDeviceKey){var n,o=u.connectStatus&&"object"==typeof u.connectStatus?Object.values(u.connectStatus)[0]:null,l=Array.isArray(o)?o:[];let e=!1;for(n of l){var d=Array.isArray(n.value)?n.value:[];if(0<d.length){var c=d[0];if(c&&void 0!==c.ip&&void 0!==c.loader_num){u.device_id=String(c.ip),u.loader_num=Number(c.loader_num),u.selectedDeviceKey=String(c.ip)+"#"+Number(c.loader_num),e=!0;break}}else if(n&&void 0!==n.ip&&void 0!==n.loader_num){u.device_id=String(n.ip),u.loader_num=Number(n.loader_num),u.selectedDeviceKey=String(n.ip)+"#"+Number(n.loader_num),e=!0;break}}}}catch(e){console.warn("[UI] Auto-select failed:",e)}try{var h=u.currentDeviceEntry;h?(u.deviceConnected=!!h.connect,u.syncDeviceInfoFromStatus(h)):(u.deviceConnected=!1,u.isModelRunning=!1,u.runningFile="")}catch(e){console.warn("[UI] Status sync failed:",e)}}),wsClient.on("update_ota_progress",e=>{try{var t,s=e&&(e.ip||e.device_id),i=e&&e.loader_num,a=Number(e&&e.progress);void 0!==s&&void 0!==i&&(t=u.otaKey(s,i),Number.isFinite(a)&&u.$set(u.otaProgress,t,a),100<=a?(u.updateOtaStatus(t,{status:"success",desc:"升级成功"}),u.otaUpdatingKey===t&&(u.otaUpdatingKey="")):u.updateOtaStatus(t,{status:"running",desc:`升级中… ${Number.isFinite(a)?a.toFixed(1):""}%`}))}catch(e){}}),wsClient.on("update_loaders",e=>{try{var t,s,i,a=e&&(e.ip||e.device_id),r=e&&e.loader_num;void 0!==a&&void 0!==r&&(t=u.otaKey(a,r),i="success"===(s=e&&e.loader_ota_status?String(e.loader_ota_status):"").toLowerCase(),u.$set(u.otaProgress,t,i?100:u.otaProgress[t]||0),u.updateOtaStatus(t,{status:i?"success":"error",desc:e&&e.desc||s||(i?"success":"failed")}),u.otaUpdatingKey===t)&&(u.otaUpdatingKey="")}catch(e){}}),wsClient.connect().catch(e=>{console.log("[WS] 初始连接失败，使用模拟模式")})},startConnectStatusMonitor(){this.stopConnectStatusMonitor(),this.connectStatusCheckTimer=setInterval(()=>{this.checkConnectStatus()},1e4)},stopConnectStatusMonitor(){this.connectStatusCheckTimer&&(clearInterval(this.connectStatusCheckTimer),this.connectStatusCheckTimer=null)},startOtaTimeoutMonitor(){this.stopOtaTimeoutMonitor(),this.otaTimeoutTimer=setInterval(()=>{this.checkOtaTimeout()},5e3)},stopOtaTimeoutMonitor(){this.otaTimeoutTimer&&(clearInterval(this.otaTimeoutTimer),this.otaTimeoutTimer=null)},checkOtaTimeout(){let s=Date.now();Object.keys(this.otaStatus).forEach(e=>{var t=this.otaStatus[e];t&&"running"===t.status&&0<(t=t.lastUpdate||0)&&3e4<s-t&&(console.warn(`[OTA] 任务超时 (${e}): 30s 无响应，自动恢复按钮点击`),this.updateOtaStatus(e,{status:"error",desc:"升级超时：30秒无响应，请重试"}),this.otaUpdatingKey===e)&&(this.otaUpdatingKey="")})},async checkConnectStatus(){if(this.wsConnected&&(1e4<Date.now()-this.lastConnectStatusTime&&!this.hasRequestedConnectStatus)){console.log("[WS] get_connect_status 超时，主动请求一次"),this.hasRequestedConnectStatus=!0;try{await wsClient.startGetConnectStatus(),setTimeout(()=>{13e3<Date.now()-this.lastConnectStatusTime&&this.wsConnected&&(console.warn("[WS] get_connect_status 请求后仍无响应，将设备状态置灰"),this.markAllDevicesAsDisconnected())},3e3)}catch(e){console.error("[WS] get_connect_status 请求失败:",e),this.markAllDevicesAsDisconnected()}}},markAllDevicesAsDisconnected(){if(this.connectStatus&&"object"==typeof this.connectStatus){var e,t,s={};for([e,t]of Object.entries(this.connectStatus))s[e]=t.map(e=>Array.isArray(e.value)?{...e,value:e.value.map(e=>({...e,connect:!1}))}:{...e,connect:!1});this.connectStatus=s}this.currentDeviceEntry&&(this.deviceConnected=!1,this.isModelRunning=!1,this.runningFile="")},handleDeviceStatusUpdate(e){var t;void 0!==e.connected&&(this.deviceConnected=e.connected),e.running_file&&(this.runningFile=e.running_file,e.running_module||(t=String(e.running_file).split(/[\/\\]/),this.runningModule=t[t.length-1])),e.running_module&&(this.runningModule=e.running_module),void 0!==e.current&&(this.realtimeData.current=e.current),void 0!==e.voltage&&(this.realtimeData.voltage=e.voltage),void 0!==e.power&&(this.realtimeData.power=e.power),void 0!==e.temperature&&(this.realtimeData.temperature=e.temperature)},handleRegisterChanged(t){let e=this.registers.find(e=>e.address===t.address);e&&(e.value=t.value,e.modified=!0,setTimeout(()=>{e.modified=!1},3e3))},async wsRequest(e,t){if(!this.wsConnected)return console.log("[模拟] "+e.name,e.params),t?t():{success:!0};try{return await wsClient.request(e.name,e.params)}catch(e){throw console.error("[WS] 请求失败:",e),this.$message.error("通信失败: "+e.message),e}},initFloatingPanelDrag(){let s=document.getElementById("floating-panel");var e=s.querySelector(".drag-handle");let i=!1,a=0,r=0;e.onmousedown=e=>{i=!0,a=e.clientY,r=s.offsetTop,document.body.style.cursor="grabbing",s.style.transition="none"},window.onmousemove=e=>{var t;i&&(e=e.clientY-a,e=r+e,t=window.innerHeight-s.offsetHeight-50,e=Math.max(50,Math.min(t,e)),s.style.top=e+"px",s.style.transform="none")},window.onmouseup=()=>{i&&(i=!1,document.body.style.cursor="",s.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)")}}},mounted(){this.loadModelDictionary().finally(()=>this.parseAllFiles());var e=this.models.findIndex(e=>e.filename===this.runningFile);-1!==e&&this.selectModel(e),this.initWebSocket(),this.loadRegisterDefinitions(),this.refreshModelOptions(),this.loadDeviceSpecsConfig(),this.$nextTick(()=>{this.initFloatingPanelDrag()}),window.addEventListener("beforeunload",e=>{if(this.hasModified)return e.returnValue="当前文件有未保存的修改，刷新或关闭页面将丢失修改，是否继续？";this.wsConnected&&(wsClient.startGetConnectStatus().catch(()=>{}),wsClient.stopAllTimers().catch(()=>{})),this.stopConnectStatusMonitor()})},beforeDestroy(){this.stopConnectStatusMonitor(),this.wsConnected&&wsClient.stopAllTimers().catch(()=>{})}})</script></body></html>